<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>CMake package guidelines - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-CMake_package_guidelines rootpage-CMake_package_guidelines skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">CMake package guidelines</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="toc" style="display:block; text-align: center; margin-bottom: 1em;">
<b><a href="../en/Arch_package_guidelines.html" title="Arch package guidelines">Arch package guidelines</a></b>
<hr>
<p><a href="../en/32-bit_package_guidelines.html" title="32-bit package guidelines">32-bit</a> – <a href="../en/CLR_package_guidelines.html" title="CLR package guidelines">CLR</a> – <a class="mw-selflink selflink">CMake</a> – <a href="../en/Cross-compiling_tools_package_guidelines.html" title="Cross-compiling tools package guidelines">Cross</a> – <a href="../en/DKMS_package_guidelines.html" title="DKMS package guidelines">DKMS</a> – <a href="../en/Eclipse_plugin_package_guidelines.html" title="Eclipse plugin package guidelines">Eclipse</a> – <a href="../en/Electron_package_guidelines.html" title="Electron package guidelines">Electron</a> – <a href="../en/Font_package_guidelines.html" class="mw-redirect" title="Font packaging guidelines">Font</a> – <a href="../en/Free_Pascal_package_guidelines.html" title="Free Pascal package guidelines">Free Pascal</a> – <a href="../en/GNOME_package_guidelines.html" title="GNOME package guidelines">GNOME</a> – <a href="../en/Go_package_guidelines.html" title="Go package guidelines">Go</a> – <a href="../en/Haskell_package_guidelines.html" title="Haskell package guidelines">Haskell</a> – <a href="../en/Java_package_guidelines.html" title="Java package guidelines">Java</a> – <a href="../en/KDE_package_guidelines.html" title="KDE package guidelines">KDE</a> – <a href="../en/Kernel_module_package_guidelines.html" title="Kernel module package guidelines">Kernel</a> – <a href="../en/Lisp_package_guidelines.html" title="Lisp package guidelines">Lisp</a> – <a href="../en/Meson_package_guidelines.html" title="Meson package guidelines">Meson</a> – <a href="../en/MinGW_package_guidelines.html" title="MinGW package guidelines">MinGW</a> – <a href="../en/Node.js_package_guidelines.html" title="Node.js package guidelines">Node.js</a> – <a href="../en/Nonfree_applications_package_guidelines.html" title="Nonfree applications package guidelines">Nonfree</a> – <a href="../en/OCaml_package_guidelines.html" title="OCaml package guidelines">OCaml</a> – <a href="../en/Perl_package_guidelines.html" title="Perl package guidelines">Perl</a> – <a href="../en/PHP_package_guidelines.html" title="PHP package guidelines">PHP</a> – <a href="../en/Python_package_guidelines.html" title="Python package guidelines">Python</a> – <a href="../en/R_package_guidelines.html" title="R package guidelines">R</a> – <a href="../en/Ruby_Gem_package_guidelines.html" title="Ruby Gem package guidelines">Ruby</a> – <a href="../en/Rust_package_guidelines.html" title="Rust package guidelines">Rust</a> – <a href="../en/VCS_package_guidelines.html" title="VCS package guidelines">VCS</a> – <a href="../en/Web_application_package_guidelines.html" title="Web application package guidelines">Web</a> – <a href="../en/Wine_package_guidelines.html" title="Wine package guidelines">Wine</a>
</p>
</div>
<p>This document covers standards and guidelines on writing <a href="../en/PKGBUILD.html" title="PKGBUILD">PKGBUILDs</a> for software that uses <a rel="nofollow" class="external text" href="https://cmake.org/">CMake</a>.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Typical_usage"><span class="tocnumber">1.1</span> <span class="toctext">Typical usage</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3">
<a href="#CMake_undesired_behaviors"><span class="tocnumber">2</span> <span class="toctext">CMake undesired behaviors</span></a>
<ul>
<li class="toclevel-2 tocsection-4">
<a href="#CMake_can_automatically_override_the_default_compiler_optimization_flag"><span class="tocnumber">2.1</span> <span class="toctext">CMake can automatically override the default compiler optimization flag</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#Notes_about_-O3"><span class="tocnumber">2.1.1</span> <span class="toctext">Notes about -O3</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Fixing_the_automatic_optimization_flag_override"><span class="tocnumber">2.1.2</span> <span class="toctext">Fixing the automatic optimization flag override</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="#Verifying_the_fixes"><span class="tocnumber">2.2</span> <span class="toctext">Verifying the fixes</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="#Prefix_and_library_install_directories"><span class="tocnumber">3</span> <span class="toctext">Prefix and library install directories</span></a></li>
<li class="toclevel-1 tocsection-9">
<a href="#Tips_and_tricks"><span class="tocnumber">4</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#Specifying_directories"><span class="tocnumber">4.1</span> <span class="toctext">Specifying directories</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Reducing_possible_unneeded_output"><span class="tocnumber">4.2</span> <span class="toctext">Reducing possible unneeded output</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Removing_insecure_RPATH_references_from_binaries"><span class="tocnumber">4.3</span> <span class="toctext">Removing insecure RPATH references from binaries</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Getting_all_available_CMake_options"><span class="tocnumber">4.4</span> <span class="toctext">Getting all available CMake options</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="#Template"><span class="tocnumber">5</span> <span class="toctext">Template</span></a></li>
<li class="toclevel-1 tocsection-15"><a href="#Example_packages"><span class="tocnumber">6</span> <span class="toctext">Example packages</span></a></li>
<li class="toclevel-1 tocsection-16"><a href="#See_also"><span class="tocnumber">7</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>From the <a rel="nofollow" class="external text" href="https://cmake.org">CMake web page</a>:
</p>
<dl><dd>CMake is an open-source, cross-platform family of tools designed to build, test and package software. CMake is used to control the software compilation process using simple platform and compiler independent configuration files, and generate native makefiles and workspaces that can be used in the compiler environment of your choice.</dd></dl>
<h3><span class="mw-headline" id="Typical_usage">Typical usage</span></h3>
<p>The typical usage consists of running the <code>cmake</code> command and after that execute the building command. The <code>cmake</code> command usually sets some parameters, checks for the needed dependencies and creates the build files, letting the software ready to be built by other tools like <code>make</code> and <code>ninja</code>.
</p>
<h2><span class="mw-headline" id="CMake_undesired_behaviors">CMake undesired behaviors</span></h2>
<p>Due to its own internal characteristics for generating the build files, sometimes CMake can behave in undesired ways. Being such, some steps should be noted when writing <a href="../en/PKGBUILD.html" title="PKGBUILD">PKGBUILDs</a> for CMake-based software.
</p>
<h3><span class="mw-headline" id="CMake_can_automatically_override_the_default_compiler_optimization_flag">CMake can automatically override the default compiler optimization flag</span></h3>
<p>It's very common to see people running CMake with the <code>-DCMAKE_BUILD_TYPE=Release</code> option. Some upstream projects even inadvertently include this option in their building instructions, but this produces an undesired behavior.
</p>
<p>Each build type causes CMake to automatically append a set of flags to <code>CFLAGS</code> and <code>CXXFLAGS</code>. When using the common <code>Release</code> build type, it automatically appends the <code>-O3</code><a rel="nofollow" class="external autonumber" href="https://github.com/Kitware/CMake/blob/v3.17.0/Modules/Compiler/GNU.cmake#L58">[1]</a> compiler optimization flag, and this overrides the default Arch Linux flag which currently is <code>-O2</code> (defined in the <a href="../en/Makepkg.html#Configuration" title="Makepkg">makepkg configuration file</a>). This is undesired, as it deviates from the Arch Linux targeted optimization level.
</p>
<h4><span class="mw-headline" id="Notes_about_-O3">Notes about <code>-O3</code></span></h4>
<p>Using <code>-O3</code> does not guarantee that the software will perform better, and sometimes it can even slow down the program. It can also break software in some situations. There is a good reason why the Arch Linux developers choose <code>-O2</code> as the target optimization level and we should stick with it. Unless you know exactly what you are doing, or if upstream explicitly tells or implies that <code>-O3</code> is needed, we should avoid using it in our packages.
</p>
<h4><span class="mw-headline" id="Fixing_the_automatic_optimization_flag_override">Fixing the automatic optimization flag override</span></h4>
<p>Fixing this in a 100% guaranteed way is not a simple question due to CMake flexibility. Please note that there is no standard solution that can be applied to all cases. This section will discuss possible solutions and some points that should be observed.
</p>
<p>The default CMake build type is <code>None</code> and it does not append any flags to <code>CFLAGS</code> and <code>CXXFLAGS</code> by default, so simply omitting the usage of the <code>CMAKE_BUILD_TYPE</code> option can work as it will default to <code>None</code>. But note that omitting this option is not guaranteed to fix the problem, as many software projects automatically set the build type to <code>Release</code> (or other type) in the CMake files if <code>CMAKE_BUILD_TYPE</code> is not set at command line.
</p>
<p>Since the default <code>None</code> build type does not append any flags to <code>CFLAGS</code> and <code>CXXFLAGS</code> by default, using the <code>-DCMAKE_BUILD_TYPE=None</code> option can also work. Generally speaking, using the <code>-DCMAKE_BUILD_TYPE=None</code> option is better than omitting the usage of <code>CMAKE_BUILD_TYPE</code>. It will cover the case when upstream automatically sets the build type to <code>Release</code> when <code>CMAKE_BUILD_TYPE</code> is omitted, it will not append any flags by default and it's uncommon to see software setting undesired flags for the <code>None</code> build type.
</p>
<p>But unfortunately, things are not that simple like only using <code>-DCMAKE_BUILD_TYPE=None</code> to fix this. When using the <code>None</code> build type to fix the <code>-O3</code> issue, one may fall into another problem. It's a common practice for many software projects to define some required compiler flags for the <code>Release</code> build type in the CMake files (for example, like setting the <code>CMAKE_C_FLAGS_RELEASE</code> and <code>CMAKE_CXX_FLAGS_RELEASE</code> CMake variables). Such software may break or misbehave when compiled without these upstream defined flags if you use the <code>None</code> build type. In order to determine if you are missing some flags you will need to look at the CMake files, or you can compare the output of <code>make VERBOSE=1</code> for the <code>None</code> and <code>Release</code> build types. What to do if the <code>None</code> build type causes some upstream defined flags to be missed? In this case you may be at the middle of two problematic situations, because if you use the <code>Release</code> build type you may be using the undesired <code>-O3</code> flag, and if you use the <code>None</code> build type you will miss some required upstream defined flags. There is no standard way of solving this situation and it should be analyzed on a case-by-case basis. If upstream defines <code>-O2</code> for the <code>Release</code> build type, you can use <code>-DCMAKE_BUILD_TYPE=Release</code> (see bellow). Otherwise, patching the CMake files may be a solution.
</p>
<p>Some few software projects hardcode <code>-O2</code> for the <code>Release</code> build type in their CMake files, and thus <code>-DCMAKE_BUILD_TYPE=Release</code> can be safely set in this case if you are sure that <code>-O2</code> is the optimization level being used.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>Some software may break when using the <code>None</code> build type. Test the software when using the <code>None</code> build type to check if it will break or lose functionality.</li>
<li>Some software may work only with the <code>Release</code> build type. You will need to experiment and test the software.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Verifying_the_fixes">Verifying the fixes</span></h3>
<p>You can verify if the fixes are being correctly used by CMake by enabling the verbose mode of the build tool. For example, when using <code>make</code> (which is the CMake default), this can be done by adding <code>VERBOSE=1</code> to it (like <code>make VERBOSE=1</code>). This will enable <code>make</code> to output the compiler commands that are being executed. You can then run <a href="../en/Makepkg.html" title="Makepkg">makepkg</a> and examine the output to see if the compiler is using the <code>-D_FORTIFY_SOURCE=2</code> and <code>-O2</code> flags. If multiple optimization flags are being displayed in each command line, the last flag in the line will be the one used by the compiler (it means that <code>-O2</code> needs to be the last optimization flag in order to be effective).
</p>
<h2><span class="mw-headline" id="Prefix_and_library_install_directories">Prefix and library install directories</span></h2>
<p>The standard Arch Linux <code>/usr</code> prefix can be specified by the <code>-DCMAKE_INSTALL_PREFIX=/usr</code> CMake option. This is usually needed because a lot of software defaults to install files into the <code>/usr/local</code> prefix.
</p>
<p>Some upstream projects set their CMake files to install libraries into the <code>/usr/lib64</code> directory. If this is the case, you can correctly set the library installation directory to <code>/usr/lib</code> by using the <code>-DCMAKE_INSTALL_LIBDIR=lib</code> CMake option.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Specifying_directories">Specifying directories</span></h3>
<p>Since CMake version 3.13, there is a <code>-B</code> option that automatically creates the build directory. This avoids the creation of the build directory by a separated <code>mkdir</code> (or <code>install</code>) command. The <code>-S</code> option specifies the source directory (where to search for a <code>CMakeLists.txt</code> file) and avoids the need of <code>cd</code>'ing into the source tree before executing <code>cmake</code>. Combined together, these two options are a convenient way to specify the build and the source directories. For example, for building a program named <i>foo</i>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">PKGBUILD</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build() {
    cmake -B build -S "foo-${pkgver}" [other_cmake_options]
    make -C build
}</pre>
<h3><span class="mw-headline" id="Reducing_possible_unneeded_output">Reducing possible unneeded output</span></h3>
<p>The <code>-Wno-dev</code> CMake option will suppress the output of some warnings that are meant only for the upstream project developers who write the <code>CMakeLists.txt</code> files. Removing these warnings makes the CMake output smoother and reduces the burden on examining it. As a general rule, these warnings usually can be safely ignored by packagers.
</p>
<h3><span class="mw-headline" id="Removing_insecure_RPATH_references_from_binaries">Removing insecure <code>RPATH</code> references from binaries</span></h3>
<p>Sometimes the resulting binaries can contain insecure references in <code>RPATH</code>. This can be verified by running <a href="../en/Namcap.html" title="Namcap">Namcap</a> on the built package and consists in a security issue that should be fixed. There is a good chance to fix this by using the <code>CMAKE_SKIP_INSTALL_RPATH=YES</code> <b>or</b> <code>CMAKE_SKIP_RPATH=YES</code> CMake options. You need to experiment with both and see what will work in the software in question (using both options is not needed).
</p>
<h3><span class="mw-headline" id="Getting_all_available_CMake_options">Getting all available CMake options</span></h3>
<p>For getting all "visible" CMake options that are available for a software project, execute <code>cmake -LAH</code> in the source tree (where the main <code>CMakeLists.txt</code> file is located).
</p>
<p>If you want to save the output for later reference, you can redirect it to a file:
</p>
<pre>$ cmake -LAH &gt;options.txt 2&gt;&amp;1
</pre>
<h2><span class="mw-headline" id="Template">Template</span></h2>
<p>Here is a general template for the <code>build()</code> function that serves as a starting point for CMake-based packages. Supposing the package is named <i>foo</i>, it's C and C++ based and that it does not define any required compiler flags for the <code>Release</code> build type in the CMake files:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">PKGBUILD</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build() {
    cmake -B build -S "foo-${pkgver}" \
        -DCMAKE_BUILD_TYPE='None' \
        -DCMAKE_INSTALL_PREFIX='/usr' \
        -Wno-dev
    make -C build
}</pre>
<p>Do not forget to place <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cmake">cmake</a></span> in <a href="../en/PKGBUILD.html#makedepends" class="mw-redirect" title="Makedepends">makedepends</a>.
</p>
<h2><span class="mw-headline" id="Example_packages">Example packages</span></h2>
<ul>
<li><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=i2pd">i2pd</a></span></li>
<li><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libmysofa">libmysofa</a></span></li>
</ul>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://cmake.org/documentation/">CMake documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://cmake.org/cmake/help/latest/">Documentation reference for the latest version</a></li>
<li><a href="https://en.wikipedia.org/wiki/CMake" class="extiw" title="wikipedia:CMake">Wikipedia article</a></li>
<li><span class="plainlinks archwiki-template-man" title="$ man 1 cmake"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cmake.1">cmake(1)</a></span></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Arch_package_guidelines.html" title="Category:Arch package guidelines">Arch package guidelines</a></li></ul>
</div></div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=CMake_package_guidelines&amp;oldid=661959">https://wiki.archlinux.org/index.php?title=CMake_package_guidelines&amp;oldid=661959</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 18 April 2021, at 18:27.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
