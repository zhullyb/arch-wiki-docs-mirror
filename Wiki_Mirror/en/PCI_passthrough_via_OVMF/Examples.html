<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>PCI passthrough via OVMF/Examples - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-PCI_passthrough_via_OVMF_Examples rootpage-PCI_passthrough_via_OVMF skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">PCI passthrough via OVMF/Examples</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"><span class="subpages">&lt; <a href="../../en/PCI_passthrough_via_OVMF.html" title="PCI passthrough via OVMF">PCI passthrough via OVMF</a></span></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p>As PCI passthrough is quite tricky to get right (both on the hardware and software configuration sides), this page presents <b>working, complete</b> VFIO setups. Feel free to look up users' scripts, BIOS/UEFI configuration, configuration files and specific hardware. If you have a problem, it might have been stumbled upon by other VFIO users and fixed in the examples below.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you have got VFIO working properly, please post your own setup according to the template on the bottom.</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Users'_setups"><span class="tocnumber">1</span> <span class="toctext">Users' setups</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#mstrthealias:_Intel_7800X_/_X299,_GTX_1070"><span class="tocnumber">1.1</span> <span class="toctext">mstrthealias: Intel 7800X / X299, GTX 1070</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#DragoonAethis:_6700K,_GA-Z170X-UD3,_GTX_1070"><span class="tocnumber">1.2</span> <span class="toctext">DragoonAethis: 6700K, GA-Z170X-UD3, GTX 1070</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Manbearpig3130's_Virtual_Gaming_Machine"><span class="tocnumber">1.3</span> <span class="toctext">Manbearpig3130's Virtual Gaming Machine</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Bretos'_Virtual_Gaming_Setup"><span class="tocnumber">1.4</span> <span class="toctext">Bretos' Virtual Gaming Setup</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Skeen's_Virtual_Gaming_Rack_Machine"><span class="tocnumber">1.5</span> <span class="toctext">Skeen's Virtual Gaming Rack Machine</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#droserasprout_poor_man's_setup"><span class="tocnumber">1.6</span> <span class="toctext">droserasprout poor man's setup</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#prauat:_2xIntel(R)_Xeon(R)_CPU_E5-2609_v4,_2xGigabyte_GeForce_GTX_1060_6GB_G1_Gaming,_Intel_S2600CWTR"><span class="tocnumber">1.7</span> <span class="toctext">prauat: 2xIntel(R) Xeon(R) CPU E5-2609 v4, 2xGigabyte GeForce GTX 1060 6GB G1 Gaming, Intel S2600CWTR</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Dinkonin's_virtual_gaming/work_setup"><span class="tocnumber">1.8</span> <span class="toctext">Dinkonin's virtual gaming/work setup</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#pauledd's_unexeptional_setup"><span class="tocnumber">1.9</span> <span class="toctext">pauledd's unexeptional setup</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#hkk's_Windows_gaming_machine_(6700K,_1070,_16GB)"><span class="tocnumber">1.10</span> <span class="toctext">hkk's Windows gaming machine (6700K, 1070, 16GB)</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#sitilge's_treachery"><span class="tocnumber">1.11</span> <span class="toctext">sitilge's treachery</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#chestm007's_hackery"><span class="tocnumber">1.12</span> <span class="toctext">chestm007's hackery</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Eduxstad's_Infidelity"><span class="tocnumber">1.13</span> <span class="toctext">Eduxstad's Infidelity</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#Pi's_vr-vm"><span class="tocnumber">1.14</span> <span class="toctext">Pi's vr-vm</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#coghex's_gaming_box"><span class="tocnumber">1.15</span> <span class="toctext">coghex's gaming box</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#Roobre's_VFIO_setup"><span class="tocnumber">1.16</span> <span class="toctext">Roobre's VFIO setup</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#laenco's_VFIO_setup"><span class="tocnumber">1.17</span> <span class="toctext">laenco's VFIO setup</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#Poncho's_VFIO_setup"><span class="tocnumber">1.18</span> <span class="toctext">Poncho's VFIO setup</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="#zane's_not_working_box"><span class="tocnumber">1.19</span> <span class="toctext">zane's not working box</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#Muata's_VFIO_setup"><span class="tocnumber">1.20</span> <span class="toctext">Muata's VFIO setup</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#peterge's_VFIO_setup"><span class="tocnumber">1.21</span> <span class="toctext">peterge's VFIO setup</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#CaptainSolidus's_VFIO_Setup"><span class="tocnumber">1.22</span> <span class="toctext">CaptainSolidus's VFIO Setup</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-24"><a href="#Adding_your_own_setup"><span class="tocnumber">2</span> <span class="toctext">Adding your own setup</span></a></li>
</ul>
</div>

<h2>
<span id="Users.27_setups"></span><span class="mw-headline" id="Users'_setups">Users' setups</span>
</h2>
<h3>
<span id="mstrthealias:_Intel_7800X_.2F_X299.2C_GTX_1070"></span><span class="mw-headline" id="mstrthealias:_Intel_7800X_/_X299,_GTX_1070">mstrthealias: Intel 7800X / X299, GTX 1070</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel(R) Core(TM) i7-7800X CPU</li>
<li>
<b>Motherboard</b>: ASRock X299 Taichi (Revision: A, BIOS/UEFI Version: 1.60A)</li>
<li>
<b>GPU</b>: Asus STRIX GTX 1070</li>
<li>
<b>RAM</b>: 32GB DDR4</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: Kernel version 4.14.8-1-skx (patched crystal_khz=24000).
<ul>
<li>Custom patches:
<ul><li>skylakex-crystal_khz-24000.patch (see below)</li></ul>
</li>
<li>Patches used from linux-ck:
<ul>
<li>enable_additional_cpu_optimizations_for_gcc_v4.9+_kernel_v4.13+.patch</li>
<li>0001-add-sysctl-to-disallow-unprivileged-CLONE_NEWUSER-by.patch</li>
<li>0001-e1000e-Fix-e1000_check_for_copper_link_ich8lan-retur.patch</li>
<li>0002-dccp-CVE-2017-8824-use-after-free-in-DCCP-code.patch</li>
</ul>
</li>
<li>Config:
<ul><li>PREEMPT, NO_HZ_IDLE, 300HZ, MSKYLAKE</li></ul>
</li>
</ul>
</li>
<li>GitHub: Link TBD</li>
<li>Benchmarks: <a rel="nofollow" class="external free" href="https://imgur.com/a/hIfQD">https://imgur.com/a/hIfQD</a>
</li>
<li>Using <b>libvirt/QEMU</b>: libvirt 3.10.0 / QEMU 2.11.0</li>
<li>Issues you have encountered, special steps taken to make something work a bit better, etc.
<ul>
<li>Skylake-X default clock incorrect in 4.14.8 (<a rel="nofollow" class="external free" href="https://bugzilla.kernel.org/show_bug.cgi?id=197299">https://bugzilla.kernel.org/show_bug.cgi?id=197299</a>)
<ul>
<li>Was unable to resolve timing issue using adjtimex</li>
<li>Patching kernel source to <b>crystal_khz = 24000</b> resolved timing/performance issues</li>
</ul>
</li>
<li>Enable 'Intel SpeedShift' in BIOS, installed <b>cpupower'</b>, set governor='performance'
<ul><li>Verify: dmesg|grep HWP
<ul><li>intel_pstate: HWP enabled</li></ul>
</li></ul>
</li>
<li>Enable HT in BIOS</li>
<li>Enable 'deadline' IO sceduler:
<ul><li>echo 'ACTION=="add|change", KERNEL=="sd*[!0-9]|sr*", ATTR{queue/scheduler}="deadline"' &gt;&gt; /etc/udev/rules.d/60-schedulers.rules</li></ul>
</li>
<li>Bypass x2apic opt-out:
<ul><li>GRUB_CMDLINE_LINUX="... intremap=no_x2apic_optout ..."</li></ul>
</li>
<li>Isolate cores for Windows VM:
<ul><li>GRUB_CMDLINE_LINUX="... isolcpus=2-5,8-11 nohz_full=2-5,8-11 rcu_nocbs=2-5,8-11 ..."</li></ul>
</li>
<li>Use hugepages (2MB) for all VM memory allocation</li>
<li>memoryBacking: &lt;hugepages/&gt;&lt;nosharepages/&gt;&lt;locked/&gt;&lt;access mode='private'/&gt;&lt;allocation mode='immediate'/&gt;</li>
<li>Extracted rom from GPU; used for &lt;rom file=../&gt; config</li>
<li>Using MSI for GPU and GPU Audio (configured in Windows registry; FPS seems same as using line-based interrupts)</li>
</ul>
</li>
<li>Hardware setup
<ul>
<li>PCIE1: NVIDIA GeForce GT 710B (for host)</li>
<li>Onboard: ASRock XHCI 3.1 USB (for host)</li>
<li>Onboard: Intel I219 NIC (bridged)</li>
<li>PCIE3: Asus Xonar STX (passthrough to Win10)</li>
<li>PCIE5: NVIDIA GeForce GTX 1070 (passthrough to Win10)</li>
<li>M2_1: Samsung 960 EVO 500GB (passthrough to Win10)</li>
<li>Onboard: Intel XHCI USB 3.0 (passthrough to Win10)</li>
<li>Onboard: Intel HDA (passthrough to Win10)</li>
<li>Onboard: Intel I211 NIC (passthrough to Win10)</li>
<li>Onboard: ASRock AHCI SATA A1/A2 (passthrough to Linux)</li>
</ul>
</li>
</ul>
<h3>
<span id="DragoonAethis:_6700K.2C_GA-Z170X-UD3.2C_GTX_1070"></span><span class="mw-headline" id="DragoonAethis:_6700K,_GA-Z170X-UD3,_GTX_1070">DragoonAethis: 6700K, GA-Z170X-UD3, GTX 1070</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i7-6700K (using iGPU as the host GPU)</li>
<li>
<b>Motherboard</b>: Gigabyte GA-Z170X-UD3 (Revision 1.0, BIOS/UEFI Version: F23d)</li>
<li>
<b>GPU</b>: MSI GeForce 1070 Gaming X (10Gbps)</li>
<li>
<b>RAM</b>: 16GB DDR4 2400MHz</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: "Vanilla" Linux (no ACS patch needed).</li>
<li>Using <b>libvirt</b>: XML domain, helper scripts, IOMMU groups, etc available in <a rel="nofollow" class="external text" href="https://github.com/DragoonAethis/VFIO">my VFIO repository</a>.</li>
<li>
<b>Guest OS</b>: Windows 8.1 Pro.</li>
<li>The entire HDD is passed to the VM as a raw device (formatted as a single NTFS partition).</li>
<li>USB keyboard and mouse are passed to the guest VM and shared with the host with Synergy.</li>
<li>Virtualized audio: PulseAudio -&gt; local Unix socket. Previously, I have had a bit more complex setup in which PA on the host was configured to accept TCP connections, and the envvars required for QEMU to use PA were pointed at the PA server running on 127.0.0.1. This way it was not required to change the QEMU user (exact details in the repo), but introduced other minor issues I have resolved later.</li>
<li>Bridged networking (with NetworkManager's and <a rel="nofollow" class="external text" href="https://www.happyassassin.net/2014/07/23/bridged-networking-for-libvirt-with-networkmanager-2014-fedora-21/">this tutorial's</a> help) is used. <code>bridge0</code> is created, <code>eth0</code> interface is bound to it. STP disabled, VirtIO NIC is configured in the VM and that VM is seen in the network just as any other computer (and is being assigned an IP address from the router itself, can communicate freely with other computers).</li>
<li>For some reason, enabling intel_iommu=on on the kernel cmdline without CSM support enabled in UEFI causes a black screen on boot. Enable it (Windows 8/10 features need to be enabled to show "CSM Support", selecting "Other OS" hides that).</li>
</ul>
<h3>
<span id="Manbearpig3130.27s_Virtual_Gaming_Machine"></span><span class="mw-headline" id="Manbearpig3130's_Virtual_Gaming_Machine">Manbearpig3130's Virtual Gaming Machine</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i7-6850K 3.6GHz</li>
<li>
<b>Motherboard</b>: Gigabyte x99-Ultra Gaming (Revision 1.0, BIOS/UEFI Version: F4)</li>
<li>
<b>Host GPU</b>: AMD Radeon HD6950 1GB</li>
<li>
<b>Guest GPU</b>: AMD R9 390 8GB</li>
<li>
<b>RAM</b>: 32GB G-Skill Ripjaws DDR4 runing at 3200MHz</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Host Kernel</b>: Kernel version Linux 4.7.2-1.</li>
<li>Using <b>libvirt QEMU/KVM with OVMF</b>: link to domain XMLs/scripts/notes: <a rel="nofollow" class="external free" href="https://github.com/manbearpig3130/MBP-VT-d-gaming-machine">https://github.com/manbearpig3130/MBP-VT-d-gaming-machine</a>
</li>
<li>
<b>Host OS</b>: Arch Linux</li>
<li>
<b>Guest OS</b>: Windows 10 Pro</li>
<li>2x 480GB SSDs set up in LVM striped mode (with mdadm) formatted to ext4 are mounted in linux which contains the guest's qcow2 virtual VirtIO disk file.</li>
<li>USB Host controller is passed through, giving most USB ports to the VM, leaving my USB 3.1 controller with attached USB hub for the host.</li>
<li>Motherboard has two NICs, one is passed into VM (Works perfectly after installing Killer NIC Driver).</li>
<li>VM gets dedicated 16GB RAM via static hugepages.</li>
<li>CPU pinning increased performance considerably.</li>
<li>Windows boots straight into Steam big picture mode on primary display (43" Sony Bravia). Overall an awesome gaming machine that meets my gaming needs and lust for GNU/Linux at the same time.</li>
<li>
<b>Quirks</b>:</li>
<li>I sometimes have to reinstall the AMD drivers in Windows to get HDMI audio working properly, or roll back to Windows HDMI driver. I normally use a USB headset which works fine anyway.</li>
</ul>
<h3>
<span id="Bretos.27_Virtual_Gaming_Setup"></span><span class="mw-headline" id="Bretos'_Virtual_Gaming_Setup">Bretos' Virtual Gaming Setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i7-7700k</li>
<li>
<b>Motherboard</b>: Z270 GAMING M3 (MS-7A62)</li>
<li>
<b>GPU</b>: ASUS GeForce GTX960</li>
<li>
<b>RAM</b>: Kingston HyperX 3x8GB DDR4 2.4GHz</li>
<li>
<b>Storage</b>: 2x Corsair MP500 m.2 240G SSDs in mdadm RAID0, 1x WD Black 1TB for storage. 100GB LVM volume as writeback cache for HDD</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: vanilla</li>
<li>
<b>Host OS</b>: Arch Linux</li>
<li>
<b>Guest OS</b>: Windows 10 Pro</li>
<li>Using <b>libvirt/QEMU</b>: GitHub config repository: <a rel="nofollow" class="external autonumber" href="https://github.com/Bretos/vfio">[1]</a>
</li>
<li>Issues you have encountered: AUDIO. Had to get USB audio adapter and pass it through.</li>
<li>No issues other than audio. Works like a charm.</li>
</ul>
<h3>
<span id="Skeen.27s_Virtual_Gaming_Rack_Machine"></span><span class="mw-headline" id="Skeen's_Virtual_Gaming_Rack_Machine">Skeen's Virtual Gaming Rack Machine</span>
</h3>
<p>Still work in progress.
</p>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: AMD FX(tm)-8350</li>
<li>
<b>Motherboard</b>: MSI 970A SLI Krait Edition (MS-7693) (Revision 5.0, BIOS/UEFI Version: 25.4)</li>
<li>
<b>Host GPU</b>: ASUS GeForce GTX 480 1536MB</li>
<li>
<b>Guest GPU</b>: ASUS GeForce GTX 480 1536MB</li>
<li>
<b>RAM</b>: 2x8GB Kingston HyperX Fury White DDR3 1866MHz</li>
<li>
<b>Storage</b>: 2x250GB Samsung EVO (MZ-75E250) set up in LVM striped mode (with mdadm), 2x1TB WD Blue (WDC_WD10SPCX) for storage. 250GB LVM volume as writeback cache for HDD.</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Host Kernel</b>: Linux 4.9.0-3 (No ACS)</li>
<li>
<b>Host OS</b>: Debian Stretch</li>
<li>
<b>Guest OS</b>: Windows 10 Home (10_1703_N, International Edition)</li>
<li>Using <b>libvirt QEMU/KVM with OVMF</b>: See <a rel="nofollow" class="external text" href="https://github.com/Skeen/libvirt-gpu-passthrough">Github</a>
</li>
</ul>
<p>Issues you have encountered:
</p>
<ul>
<li>Identifical GPUs; solved <a href="../../en/PCI_passthrough_via_OVMF.html#Using_identical_guest_and_host_GPUs" title="PCI passthrough via OVMF">using this section on the wiki</a>, but with the script from the <a href="../../en/Talk:PCI_passthrough_via_OVMF.html#Using_identical_guest_and_host_GPUs_-_did_not_work_for_me." title="Talk:PCI passthrough via OVMF">corresponding discussion page</a>. Several adaptations for Debian were required too, but are not applicable for this forum.</li>
<li>"Error 43: Driver failed to load";
<ul>
<li>Spoofing vendor_id caused Windows to crash during boot-up.</li>
<li>Linux VMs complain unable to find GPU from Grub2, and booted into blind-mode, but would still pick up the graphics card during the boot process, and would remain functional until VM reboot.</li>
<li>Vendor_id spoofing turned out to work after solving the real problem (Missing UEFI compatability in VBIOS).</li>
</ul>
</li>
<li>Missing UEFI (OVMF) compatability in VBIOS;
<ul>
<li>Requested a GOP/UEFI compatible VBIOS upgrade from ASUS, but ASUS could neither understand the request, or provide the upgrade (The only thing supplied was standard support answers).</li>
<li>No compatible VBIOS was found at <a rel="nofollow" class="external text" href="https://www.techpowerup.com/vgabios/">TechPowerUp</a>.</li>
<li>Finally solved by manually hacking GOP/UEFI support into the ROM, using <a rel="nofollow" class="external text" href="http://www.win-raid.com/t892f16-AMD-and-Nvidia-GOP-update-No-requests-DIY.html">GOPupd</a>. Current rom was dumped within a Windows 10 VM using GPU-Z, then modified using GOPupd, pulled to Linux, and provided using the rom file parameter in the VM XML file.</li>
</ul>
</li>
<li>VM only uses one core (even with mode=host-passthrough): solved <a href="../../en/PCI_passthrough_via_OVMF.html#VM_only_uses_one_core" title="PCI passthrough via OVMF">using this section on the wiki</a>.</li>
</ul>
<p>Quirks:
</p>
<ul>
<li>The GPU that is being passed through, <a href="../../en/PCI_passthrough_via_OVMF.html#Passing_through_a_device_that_does_not_support_resetting" title="PCI passthrough via OVMF">does not support resetting</a>, and thus doing a hard-reboot / shutdown of the VM locks the GPU.
<ul>
<li>The VM cannot be started again unless the Host machine is rebooted.
<ul><li>When doing a clean reboot / shutdown, allows the VM to start up as expected without reboot..</li></ul>
</li>
<li>Removing and rescanning the PCI device, does not change anything.</li>
<li>No further attempts at powercycling the GPU from the host has been done (Yet).</li>
</ul>
</li>
<li>
<a href="../../en/PCI_passthrough_via_OVMF.html#Passing_VM_audio_to_host_via_PulseAudio" title="PCI passthrough via OVMF">Passing VM audio to host via PulseAudio</a> results in heavy crackling.
<ul><li>Using <a href="../../en/PCI_passthrough_via_OVMF.html#Slowed_down_audio_pumped_through_HDMI_on_the_video_card" title="PCI passthrough via OVMF">Message-Signaled Interrupts</a> have not been attempted (Yet).</li></ul>
</li>
</ul>
<h3>
<span id="droserasprout_poor_man.27s_setup"></span><span class="mw-headline" id="droserasprout_poor_man's_setup">droserasprout poor man's setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i3-6100</li>
<li>
<b>Motherboard</b>: ASRock H110M2 D3 (BIOS version 0603)</li>
<li>
<b>Host GPU</b>: Intel HD 530</li>
<li>
<b>Guest GPU</b>: Sapphire Radeon R7 360</li>
<li>
<b>RAM</b>: Apacer 8Gb 75.C93DE.G040C, Kingston 4Gb 99U5401-011.A00LF</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: linux-lts 4.9.67-1 (vanilla)</li>
<li>
<b>Host OS</b>: Arch Linux</li>
<li>
<b>Guest OS</b>: Windows 10 Pro 1709 (build 16299.98)</li>
<li>Using <b>libvirt/QEMU</b>: See my configs and IOMMU groups on <a rel="nofollow" class="external text" href="https://github.com/droserasprout/win10-vfio-configs">Github</a>
</li>
<li>HDD partition is passed to the VM as a raw virtio device.</li>
<li>HD Audio is passed too. Works fine with both playing and recording, no latency issues or glitches. After VM is powered off host audio works fine too.</li>
<li>Guest's latency is slightly better when CPU cores are isolated for VM.</li>
<li>i2c-dev module added to bypass 'EDID signature' error when switching HDMI. Without it I had to switch video output before starting VM for some reason.</li>
<li>intremap=no_x2apic_optout kernel option added to bypass motherboard firmware falsely reporting x2APIC method is not supported. Seems to have a strong influence on the guest's latency.</li>
<li>Overall performance is pretty close to the native OS setup.</li>
</ul>
<h3>
<span id="prauat:_2xIntel.28R.29_Xeon.28R.29_CPU_E5-2609_v4.2C_2xGigabyte_GeForce_GTX_1060_6GB_G1_Gaming.2C_Intel_S2600CWTR"></span><span class="mw-headline" id="prauat:_2xIntel(R)_Xeon(R)_CPU_E5-2609_v4,_2xGigabyte_GeForce_GTX_1060_6GB_G1_Gaming,_Intel_S2600CWTR">prauat: 2xIntel(R) Xeon(R) CPU E5-2609 v4, 2xGigabyte GeForce GTX 1060 6GB G1 Gaming, Intel S2600CWTR</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>:2xIntel(R) Xeon(R) CPU E5-2609 v4</li>
<li>
<b>Motherboard</b>: Intel S2600CWTR(Revision ???, BIOS/UEFI Version: SE5C610.86B.01.01.0022.062820171903)</li>
<li>
<b>GPU</b>: 2xGigabyte GeForce GTX 1060 6GB G1 Gaming [GeForce GTX 1060 6GB] (rev a1)</li>
<li>
<b>RAM</b>: Samsung M393A2G40EB1-CPB  2133 MHz 64GB (4x16GB)</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: Linux 4.14.15-1-ARCH #1 SMP PREEMPT</li>
<li>Using <b>libvirt/QEMU</b>: <a rel="nofollow" class="external free" href="https://github.com/prauat/passvm/blob/master/generic.xml">https://github.com/prauat/passvm/blob/master/generic.xml</a>
</li>
<li>Most important:</li>
<li>When using nvidia driver hide virtualization to guest &lt;kvm&gt;&lt;hidden state='on'/&gt;&lt;/kvm&gt;</li>
<li>Configuration works with Arch Linux guest os, still work in progress.</li>
</ul>
<h3>
<span id="Dinkonin.27s_virtual_gaming.2Fwork_setup"></span><span class="mw-headline" id="Dinkonin's_virtual_gaming/work_setup">Dinkonin's virtual gaming/work setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>:  Intel(R) Core(TM) i7-7700K CPU @ 4.60GHz</li>
<li>
<b>Motherboard</b>: MSI Z270 GAMING PRO CARBON (MS-7A63) BIOS Version: 1.80</li>
<li>
<b>GPU</b>: 1x Gigabyte GeForce GTX 1050 2GB (host), 1x MSI GeForce 1080 AERO 8GB(guest)</li>
<li>
<b>RAM</b>: 32GB DDR4</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: Kernel version linux 4.15.2-2-ARCH.</li>
<li>Using <b>libvirt/QEMU (patched from AUR) with OVMF</b>
</li>
<li>Installed qemu-patched from AUR because of crackling/delayed sound with pulseaduio (still hear ocasional pops/clicks while gaming.</li>
<li>Patched video bios with <a rel="nofollow" class="external free" href="https://github.com/Matoking/NVIDIA-vBIOS-VFIO-Patcher">https://github.com/Matoking/NVIDIA-vBIOS-VFIO-Patcher</a>, because of error:</li>
</ul>
<pre>vfio-pci 0000:01:00.0: Invalid PCI ROM header signature: expecting 0xaa55, got 0xffff
</pre>
<ul><li>Single monitor setup, implemented full software KVM(for host and guest) described here: <a rel="nofollow" class="external free" href="https://rokups.github.io/#!pages/full-software-kvm-switch.md">https://rokups.github.io/#!pages/full-software-kvm-switch.md</a>
</li></ul>
<h3>
<span id="pauledd.27s_unexeptional_setup"></span><span class="mw-headline" id="pauledd's_unexeptional_setup">pauledd's unexeptional setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i7 6700K</li>
<li>
<b>Motherboard</b>: Gigabyte GA-Z170N-WIFI Retail (Revision 1.0 , BIOS/UEFI Version: F20)</li>
<li>
<b>GPU</b>: 8GB Palit GeForce GTX 1070 Dual Aktiv PCIe 3.0 x16 (Retail)</li>
<li>
<b>RAM</b>: 16GB G.Skill RipJaws V DDR4-3200 DIMM CL16 Dual Kit</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: 4.15.2-gentoo</li>
<li>Using <b>libvirt/QEMU</b>: libvirt-4.0.0, qemu-2.11.1, <a rel="nofollow" class="external free" href="https://github.com/pauledd/GPU-Passthrough/blob/master/win10-2.xml">https://github.com/pauledd/GPU-Passthrough/blob/master/win10-2.xml</a> , using vfio kernel module</li>
<li>Had to dump VBIOS in at the host while GPU was normally attached (and drivers loaded) (see <a rel="nofollow" class="external free" href="https://stackoverflow.com/a/42441234">https://stackoverflow.com/a/42441234</a>), had to set CPU settings manually according to my cpu (host-passthrough, sockets 1, cores: 4, threads: 2 ) or some games will regularly crash, see my xml how to insert vbios, still have audio clicking/lag with pulseaudio but thats ok for me, no further patching etc.. works out of the box without any issues.</li>
<li>3DMark Results Time Spy Graphic Score: Native Windows 10: 5564 , GPU-Passthrough: 5541</li>
</ul>
<h3>
<span id="hkk.27s_Windows_gaming_machine_.286700K.2C_1070.2C_16GB.29"></span><span class="mw-headline" id="hkk's_Windows_gaming_machine_(6700K,_1070,_16GB)">hkk's Windows gaming machine (6700K, 1070, 16GB)</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i7-6700K 4.5GHz</li>
<li>
<b>Motherboard</b>: AsRock Fatality Gaming K6 Z170 (rev. 1.05)</li>
<li>
<b>Host GPU</b>: Intel GPU HD530 with 1GB shared memory</li>
<li>
<b>Guest GPU</b>: Gigabyte GeForce GTX1070 G1 Gaming 8GB</li>
<li>
<b>RAM</b>: 16GB G.Skill RipjawsV @ 3333 MHz CL14-15-15-31-2T [DDR4]</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Host Kernel</b>: Kernel version Linux 4.15.7-1-vfio (with ACS patch included).</li>
<li>Using <b>libvirt QEMU/KVM with OVMF</b>
</li>
<li>
<b>Host OS</b>: Arch Linux</li>
<li>
<b>Guest OS</b>: Windows 10 Pro</li>
<li>128GB Intel 600p SSD splited into 3 partitions: 512MB for EFI, 30GB for / in Btrfs and other gigs for Windows 10 installed straight on SSD.</li>
<li>Two more HDDs for Windows. 1TB and 650GB</li>
<li>Passed specific devices like X360 and some of single USB ports.</li>
<li>One NIC behind NAT on VM machine.</li>
<li>VM gets dedicated 8GB RAM via static hugepages.</li>
<li>CPU pinning increased performance considerably and machine gets 4/4 cores of my 4/8 CPU</li>
<li>Windows boots on second screen with simple script which shutting down display with xrandr.</li>
<li>Using Synergy to share mouse and keyboard between systems.</li>
<li>
<b>Quirks</b>:</li>
<li>Synergy is not perfect and will not entirely work in some games.</li>
<li>No boot screen. Display is turning on only when Windows is up and ready to go.</li>
</ul>
<h3>
<span id="sitilge.27s_treachery"></span><span class="mw-headline" id="sitilge's_treachery">sitilge's treachery</span>
</h3>
<p>Full info: <a rel="nofollow" class="external free" href="https://git.sitilge.id.lv/sitilge/dotfiles">https://git.sitilge.id.lv/sitilge/dotfiles</a>
</p>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Core i5 6600K</li>
<li>
<b>Motherboard</b>: Asus Z170i</li>
<li>
<b>GPU</b>: Gigabyte Radeon RX460 OC 2GB</li>
<li>
<b>Storage</b>: Samsung 850 EVO 500GB</li>
<li>
<b>RAM</b>: Corsair 16GB DDR4</li>
<li>
<b>Mouse, Keyboard</b>: Logitech M90, Vortex Pok3r</li>
</ul>
<p>Host Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: linux-vfio</li>
<li>
<b>Packages</b>: qemu-git, virtio-win, ovmf</li>
</ul>
<p>Guest Configuration:
</p>
<ul>
<li>
<b>OS</b>: Windows 10 Pro</li>
<li>
<b>CPU</b>: host</li>
<li>
<b>Motherboard</b>: host</li>
<li>
<b>GPU</b>:  passthrough</li>
<li>
<b>Storage</b>: 64GB</li>
<li>
<b>RAM</b>: 8GB</li>
<li>
<b>Mouse, Keyboard</b>: passthrough</li>
</ul>
<p>Notes:
</p>
<ul>
<li>You can easy simlink the config files using <code>stow -t / boot mkinitcpio</code> and then <code>mkinitcpio -p linux-vfio</code>.</li>
<li>
<code>-smp cores=4</code> - guest might utilize only one core otherwise.</li>
<li>
<code>-soundhw ac97</code> - I'm passing mobo audio thus ac97. Download, unzip and install the Realtek AC97 drivers within a guest.</li>
<li>Use virtio drivers for both block devices and network. For example, the ping went down from 250 to 50.</li>
<li>Mouse and keyboard passthrough solved the terrible lag problem which was present in emulation mode.</li>
<li>Make sure virtualization is supported and enabled in your firmware (UEFI). The option was hidden in a submenu in my case.</li>
<li>As trivial as it sounds, check your cables.</li>
<li>Be patient - it took more than 10 minutes for the guest to recognize the GPU.</li>
</ul>
<h3>
<span id="chestm007.27s_hackery"></span><span class="mw-headline" id="chestm007's_hackery">chestm007's hackery</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Ryzen 7 1800x</li>
<li>
<b>Motherboard</b>: Asus ROG Crosshair VI (Revision 1, BIOS/UEFI Version: 3502)</li>
<li>
<b>GPU</b>: Asus ROG RX480oc 8GB</li>
<li>
<b>RAM</b>: 32gb Ripjaws 2400mhz</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: 4.16.12-1-ARCH.</li>
<li>Using <b>libvirt/QEMU</b>: libvirtd (libvirt) 4.3.0, QEMU emulator version 2.12.0,</li>
</ul>
<p>Notes: 
</p>
<ul>
<li>using ic6 audio - works fine for me.</li>
<li>have a working looking-glass setup, however cant get spice to pass through keyboard and mouse, currently using a mixture of synergy and a dedicated screen as a workaround</li>
</ul>
<h3>
<span id="Eduxstad.27s_Infidelity"></span><span class="mw-headline" id="Eduxstad's_Infidelity">Eduxstad's Infidelity</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Ryzen 2600X @ 3.7 GHZ</li>
<li>
<b>Motherboard</b>: ASUS PRIME B350-PLUS(BIOS/UEFI Version: 4011)</li>
<li>
<b>GPU1 (Guest)</b>: MSI 390 8GB @ Stock</li>
<li>
<b>GPU2 (Host)</b>: XFX 550 4GB @ Stock</li>
<li>
<b>RAM</b>: 2 x 8GB (16GB) @ 3000 HZ</li>
<li>
<b>Guest OS</b>: Windows 8.1 Embedded Pro</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: 4.17.3-1-ARCH (vanilla).</li>
<li>Using <b>libvirt/QEMU</b>: libvirt/virt-manager (<a rel="nofollow" class="external free" href="https://github.com/eduxstad/vfio-config">https://github.com/eduxstad/vfio-config</a>).</li>
<li>Look in the repository for complete documentation of extra steps taken</li>
<li>Overview: VM managed using virt-manager, using looking glass for primary io and built in spice display server as backup. Passing vm audio back to pulseaudio. Using hugepages for RAM. SCSI Drivers installed for hardware drive support.</li>
</ul>
<h3>
<span id="Pi.27s_vr-vm"></span><span class="mw-headline" id="Pi's_vr-vm">Pi's vr-vm</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: i7-8700k @ 4.8 GHz</li>
<li>
<b>Motherboard</b>: MSI Gaming Pro Carbon (BIOS/UEFI Version: A.40/5.12)</li>
<li>
<b>GPU</b>: Palit RTX 2080 Ti</li>
<li>
<b>RAM</b>: 4x8GB G.Skill DDR4 @ 3000 MHz</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>Kernel: latest mainline (rc if available)
<ul>
<li>custom built with ZFS, WireGuard</li>
<li>
<i>CONFIG_PREEMPT_VOLUNTARY=y</i> to work around QEMU bug with long guest boot times</li>
</ul>
</li>
<li>Startup scripts/additional info: <a rel="nofollow" class="external free" href="https://github.com/PiMaker/Win10-VFIO">https://github.com/PiMaker/Win10-VFIO</a>
</li>
<li>Issues encountered:
<ul>
<li>PUBG would not launch at all
<ul><li>Solution: Enable the HyperV clock with &lt;timer name='hypervclock' present='yes'/&gt; and disable hpet with &lt;timer name='hpet' present='no'/&gt;</li></ul>
</li>
<li>VR would start to stutter badly after about 20-30 minutes of playtime (this one took me about 2 weeks to finally figure out :-)
<ul><li>Solution:
<ul>
<li>Enable invariant tsc passthrough with &lt;feature policy='require' name='invtsc'/&gt; (required even if using host-passthrough!)</li>
<li>Enable MSI for the GPU (using tool from <a rel="nofollow" class="external text" href="https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044/">here</a>)</li>
<li>Enable vAPIC and synic in the HyperV configuration</li>
<li>Manually move all IRQs to host cores using qemu_fifo.sh script from my GitHub repo above</li>
</ul>
</li></ul>
</li>
</ul>
</li>
<li>Overview: SteamVR-capable gaming and workstation rig, passing through NVIDIA GPU and onboard USB-controller (leaving an additional ASMedia USB port to the host). 22 GB hugepages memory, 10 of 12 cores (with SMT) passed through. Audio working via Scream (<a rel="nofollow" class="external free" href="https://github.com/duncanthrax/scream">https://github.com/duncanthrax/scream</a>) - with IVSHMEM, surprisingly low latency and no stutters.</li>
</ul>
<h3>
<span id="coghex.27s_gaming_box"></span><span class="mw-headline" id="coghex's_gaming_box">coghex's gaming box</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: i7-8086k @ 5.0 GHZ (8086k is just a binned 8700k)</li>
<li>
<b>Motherboard</b>: GIGABYTE Z370 AORUS Gaming 7 rev1.0 (BIOS/UEFI Version: F15a)</li>
<li>
<b>GPU</b>: GIGABYTE GV-N108TAORUSX WB-11GD AORUS GeForce GTX 1080 Ti Waterforce WB Xtreme Edition 11G @ ~2Ghz</li>
<li>
<b>RAM</b>: 4 x 8GB (32GB) Corsair Dominator Platinum @ 3600 HZ (XMP)</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: linux-zen-5.5.8.zen1-1</li>
<li>
<b>Modules</b>: raid0 raid1 md_mod ext4 vfat ahci vfio_pci vfio vfio_iommu_type1 vfio_virqfd usbhid it87 (aur version is unmaintained and the support for the ITE8686E chip on this board is limited, replace it87 source with that which is found <a rel="nofollow" class="external text" href="https://github.com/andreychernyshev/it87-8613E">here</a> for more comprehensive support)</li>
<li>
<b>Virsh</b>: virsh-5.10.0</li>
<li>
<b>Qemu</b>: qemu-system-x86_64-4.2.0 machine='pc-i440fx-4.2'</li>
<li>
<b>Performance Services</b>: <a href="../../en/Improving_performance.html#irqbalance" title="Improving performance">irqbalance-1.6.0</a>, <a href="../../en/Improving_performance.html#Ananicy" title="Improving performance">ananicy-git-2.1.0.r22</a>, <a href="../../en/CPU_frequency_scaling.html#cpupower" title="CPU frequency scaling">cpupower5.5-1</a>
</li>
<li>EDIT(2020): much has changed since this setup was posted years ago and a custom kernel is no longer needed on this hardware, everything works perfectly...</li>
<li>scripts, libvirt XML, and personal configs can be found here: <a rel="nofollow" class="external free" href="https://github.com/coghex/hoest">https://github.com/coghex/hoest</a>
</li>
<li>host boot options: intel_iommu=on iommu=pt rd.driver.pre=vfio-pci acpi_enforce_resources=lax</li>
<li>systemd modprobe.d options: kvm ignore_msrs=1 (avoids critical bugs), kvm report_ignored_msrs=N (cleans up journal logs)</li>
<li>libvirt features: acpi, apic, kvm hidden state='on', vmport state='off'</li>
<li>guest hyper-v options: hv-relaxed, hv-vapic, hv-spinlocks (retries='8191'), hv-vpindex, hv-runtime, hv-synic, hv-stimer, hv-stimer-direct, hv-reset, hv-vendor_id (value='1234567890ab'), hv-frequencies, hv-reenlightenment, hv-tlbflush, hv-ipi, (hv-evmcs and hv-no-nonarch-coresharing seemingly do not work yet in virsh)</li>
<li>make sure to use the multifunction field for the GPU's hdmi audio controller and set them to the same slot, otherwise the audio interrupts will hang.  Someone should probably add that to the guide...</li>
<li>im running the clock at 100Hz, the people running it at 1000 with the zen or ck kernel should know that the MuQSS scheduler works the same regardless of this speed and 1000 will just add more useless interrupts.</li>
<li>cpu pinning works best for single VM performance, default host-passthrough works best for multiple running VMs.</li>
<li>on windows, the <a rel="nofollow" class="external text" href="https://github.com/CHEF-KOCH/MSI-utility">MSI_util_v2</a> gets used every update to reset MSI interrupts on the GPU.</li>
</ul>
<p>Hardware Specific:
</p>
<ul>
<li>
<b>Fully-Functional Passthrough Devices</b>: this motherboard has many PCI slots, all of these devices have been working flawlessly with little setup for years now:
<ul>
<li>Inatek USB Card: KT5001 <a rel="nofollow" class="external autonumber" href="https://www.amazon.com/Inateck-Express-15-Pin-Connector-KT5001/dp/B00FPIMJEW">[2]</a>
</li>
<li>Creative Sound Card: 70SB155000001 <a rel="nofollow" class="external autonumber" href="https://www.amazon.com/Creative-Labs-70SB155000001-Blaster-PCI-Express/dp/B01LYT7U99">[3]</a>
</li>
<li>EDUP WiFi Card: AC9636GS (must use virtio usb passthrough for bluetooth functionality) <a rel="nofollow" class="external autonumber" href="https://www.amazon.com/EDUP-3000Mbps-802-11AX-Bluetooth-EP-AC9636GS/dp/B082F5D4SM">[4]</a>
</li>
<li>Intel Optane SSD: SSDPED1D480GASX <a rel="nofollow" class="external autonumber" href="https://www.amazon.com/Intel-Optane-900P-480GB-XPoint/dp/B0772T4BVZ">[5]</a>
</li>
<li>Zotac GeForce GT 710: ZT-71304-20L (this one does not seem to be available on amazon anymore, a shame since its one of the few high performance PCIEx1 cards...) <a rel="nofollow" class="external autonumber" href="https://www.amazon.com/ZOTAC-GeForce-Profile-Graphic-ZT-71304-20L/dp/B01E9Z2D60">[6]</a>
</li>
</ul>
</li>
<li>none of the proprietary gigabyte software works, in fact, it blue screens windows and installs itself as a startup program, forever locking you out.</li>
<li>if anyone else uses this exact motherboard, there are two internal USB IOMMU groups, even with the ACS patch.  one will include the usb labeled "USB 3.1", and the other will include all the other USBs.  this means if you want more than just a keyboard and mouse, you will need either a usb hub to plug into the 3.1 slot and passthrough, or a PCIE USB bus.</li>
<li>the two ethernet ports are in different IOMMU groups, making this a perfect motherboard for vfio.</li>
<li>the ACS patch is needed on this motherboard if you want to use two graphics cards at once in seperate IOMMU groups.  this sets the main GPU to PCIEx8 instead of x16.</li>
</ul>
<h3>
<span id="Roobre.27s_VFIO_setup"></span><span class="mw-headline" id="Roobre's_VFIO_setup">Roobre's VFIO setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz</li>
<li>
<b>Motherboard</b>: Gigabyte Z390 M GAMING</li>
<li>
<b>GPU</b>: EVGA GTX 1080Ti</li>
<li>
<b>RAM</b>: 32GB DDR4 2400 (2x Ballistix)</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: Latest -ARCH (5.9.1-arch1-1 at the time of writing)</li>
<li>Using <b>libvirt/QEMU</b>: libvirt 1:6.5.0-3, qemu 5.1.0-2. Config: <a rel="nofollow" class="external free" href="https://gist.github.com/roobre/8f2d86a51a6b619a6622a64a58f9fc94">https://gist.github.com/roobre/8f2d86a51a6b619a6622a64a58f9fc94</a>
</li>
<li>
<b>ZFS</b> volumes passed as raw devices for hard drives with <b>virtio-scsi</b>.</li>
<li>
<b>VirtIO all the things!</b> Download drivers from <a rel="nofollow" class="external free" href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/</a>
</li>
</ul>
<p>Issues: 
</p>
<ul><li>Pulseaudio never worked good (too much crackling), so I ended up passing-through an USB 3.1 PCI controller and connecting an USB audio card to it. That card is then connected to one of my MoBo's inputs, and echoed using pulseaudio's `loopback` module.</li></ul>
<ul><li>Synergy works really great. On some games (ones who take control of the mouse pointer, e.g. first-person), you need to lock the mouse cursor to the VM window to avoid issues (camera moving too fast).</li></ul>
<ul><li>Do not forget to add the needed snippet for the nvidia driver to run (<a href="../../en/PCI_passthrough_via_OVMF.html#%22Error_43:_Driver_failed_to_load%22_on_Nvidia_GPUs_passed_to_Windows_VMs" title="PCI passthrough via OVMF">PCI passthrough via OVMF#"Error 43: Driver failed to load" on Nvidia GPUs passed to Windows VMs</a><sup>[<a href="../../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup>)</li></ul>
<h3>
<span id="laenco.27s_VFIO_setup"></span><span class="mw-headline" id="laenco's_VFIO_setup">laenco's VFIO setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Ryzen 9 3950X @ 4.15Ghz all-cores via PBO</li>
<li>
<b>Motherboard</b>: Asus ROG STRIX X470-F GAMING (BIOS/UEFI Version: 5406)</li>
<li>
<b>GPU1 (Guest)</b>: Palit GeForce GTX 1080 8GB @ Stock</li>
<li>
<b>GPU2 (Host)</b>: MSI RX 570 8GB @ Stock</li>
<li>
<b>RAM</b>: 4 x 16GB (64GB) @ 3333 MHz</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Guest OS</b>: Windows 10 Pro</li>
<li>
<b>Kernel</b>: 5.4.13-arch1-1-gc (-ck is also good). No ACS patch.</li>
<li>Using vanilla <b>QEMU 4.2.0</b>
</li>
<li>AMD Ryzen currently (2020.01.20) got bugged with smp threads option - VM stuck on start.</li>
<li>Got classic Nvidia error 43 - classically fixed. But also added some cpu flags which are set automatically with kvm=on found here <a rel="nofollow" class="external free" href="https://github.com/qemu/qemu/blob/master/target/i386/cpu.c#L4008">https://github.com/qemu/qemu/blob/master/target/i386/cpu.c#L4008</a>
</li>
<li>As pure qemu have no option to pin cpu cores and self threads - using python script "cpu_affinity" - credits to <a rel="nofollow" class="external free" href="https://github.com/zegelin/qemu-affinity/">https://github.com/zegelin/qemu-affinity/</a> and also a copy in my repo. Requires debug-threads=on</li>
<li>Using dynamically allocated hugepages 2Mb</li>
<li>Hardly using VirtIO</li>
<li>Using hardware usb switch like Aten US224-AT and hdmi switch "many-to-one", which allow me to have one monitor, mouse, keyboard and some usb devices, and switch them by button between host and guest.</li>
<li>Repo with current major system config and script for VM could be found here <a rel="nofollow" class="external free" href="https://github.com/laenco/vfio-config">https://github.com/laenco/vfio-config</a>
</li>
</ul>
<h3>
<span id="Poncho.27s_VFIO_setup"></span><span class="mw-headline" id="Poncho's_VFIO_setup">Poncho's VFIO setup</span>
</h3>
<p><b>Hardware:</b>
</p>
<ul>
<li>
<b>CPU</b>: Ryzen 7 2700x @ stock (PBO)</li>
<li>
<b>Motherboard</b>: MSI B450-A PRO MAX (BIOS/UEFI version: 7B86vM5)</li>
<li>
<b>GPU1 (Guest)</b>: MSI GeForce GTX 1660 Ti Gaming X 6GB @ Stock</li>
<li>
<b>GPU2 (Host)</b>: AsRock RX 570 8GB @ Stock</li>
<li>
<b>RAM</b>: 2 x 16GB @ 3200MHz</li>
</ul>
<p><b>Configuration:</b>
</p>
<ul>
<li>
<b>Guest OS</b>: Windows 10 Home</li>
<li>
<b>Kernel</b>: 5.4.17-1-MANJARO vanilla, no ACS patch</li>
<li>
<b>libvirt 6.4.0/QEMU 5.0.0</b>: <a rel="nofollow" class="external text" href="https://gist.github.com/jp1995/7427b00eae14aba91a6ee2ab0d17df0a/">win12.xml gist</a>
</li>
</ul>
<p><b>Issues I have encountered:</b>
</p>
<p>The main issue that plagued me for a while was crashes. The crashes were occurring more often in more demanding games, and less often when the host was as idle as possible. Mostly just the game crashed, but sometimes it would take the VM with it. I finally solved this by changing my RAM speed from 3466MHz to 2666MHz. I will try slowly bumping the RAM speed back up step by step to find the point of instability and I will edit this once I have found it. <i>Edit:</i> It's 3200MHz.
</p>
<p><b>Describing setup loosely:</b> 
</p>
<ul>
<li>On the hardware side, my 620 Watt PSU is perfectly adequate, despite some early concerns.</li>
<li>16 PCI lanes for the Guest card, 4 for the Host card. 8+8 is also a solution but I have not had the need to try this.</li>
<li>Regarding the VM setup, I pinned and isolated 12 logical processors, leaving 4 to the host. The isolation was achieved using <a rel="nofollow" class="external text" href="https://rokups.github.io/#!pages/gaming-vm-performance.md/">these scripts.</a> I needed the git version of cpuset for it to work. The pinning alone did not change performance at all.</li>
<li>Audio passthrough is done through the usual pulseaudio solution, I have no demonic interference, works almost perfectly. I have to plug my headset directly into the VM when I want my mic to not sound garbage. ICH9.</li>
<li>I did try enabling MSI on the GPU in an attempt to fix the crashes described above, but all I got was a small but significant reduction in performance.</li>
<li>Regarding input, I got a bit lucky. My motherboard has two USB 3 ports all alone in a single IOMMU group. I got a 4 port USB switch and the only complaint I have with it is that while switching from Host to Guest is near instantaneous, the other way around takes about 3 seconds.</li>
<li>No trouble at all getting the NVIDIA gpu to run in a VM, used the general solution in the wiki, including &lt;kvm&gt;&lt;hidden state='on'/&gt;&lt;/kvm&gt;</li>
<li>As for storage, I just gave the VM a whole raw SATA SSD. Benchmarking shows about a 50% performance drop, but I have not really noticed significantly longer loading times in games. In the future I might try reinstalling windows on a virtual image for cloning purposes and use the SSD as a game drive.</li>
<li>All in all, <s>there is about a 10% performance loss in CPU intensive games, compared to bare metal.</s> after four months of use, I have found that some games do not run as well as others. EFT can drop over 25 fps compared to native. GTA V can drop more. Insurgency Sandstorm starts stuttering, something frame time related I think, when there is anything graphical going on in the host machine. Less demanding games run great. Hoping Zen 3 saves me with more CPU resources, L3 cache, bandwidth etc. Ideally, I imagine separate NUMA nodes would be great for this, but way above my price range.</li>
</ul>
<h3>
<span id="zane.27s_not_working_box"></span><span class="mw-headline" id="zane's_not_working_box">zane's not working box</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>MacBook Pro 11,x</b> (2014 Model)</li>
<li>
<b>CPU</b>: Intel Core i7-4770HQ</li>
<li>
<b>Motherboard</b>: Apple</li>
<li>
<b>GPU</b>: Iris Pro 5200 for host, GTX 1660 eGPU over Thunderbolt 2 for guest</li>
<li>
<b>RAM</b>: 16GB</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: linux-vfio from aur 5.5.8</li>
<li>
<b>qemu</b>: 4.2.0</li>
<li>
<b>libvirt</b>: 5.10.0</li>
<li>
<b>ovmf</b>: 1:r26976.bd85bf54c2</li>
<li>
<b>libvirt/QEMU</b>: <a rel="nofollow" class="external text" href="https://gist.github.com/xzn/ef338049c91d21e9c1900982b21d9d32">libvirt setup</a>; <a rel="nofollow" class="external text" href="https://gist.github.com/xzn/06760e0e7df6ca325d0f05979aeff3bd">qemu setup</a>
</li>
</ul>
<p>Description:
</p>
<ul><li>The qemu script include lines for setting up device mapped file for raw disk access. 3D Performace is about 40% to 80% native depending on the application, with periodic lag spike/stutter.</li></ul>
<p>Issues:
</p>
<ul>
<li>Use <a rel="nofollow" class="external text" href="https://github.com/0xbb/apple_set_os.efi">apple_set_os.efi</a> or <code>spoof_osx_version</code> with <a rel="nofollow" class="external text" href="https://www.rodsbooks.com/refind/configfile.html">refind</a> to avoid black screen on start. This prevents Apple firmware from shutting down host iGPU when booting Linux/Windows.</li>
<li>CPU pinning for guest is mandatory as it removes majority of stutters. After that isolate host CPU cores and pin emulator/IO threads as well. <a rel="nofollow" class="external text" href="https://github.com/PiMaker/Win10-VFIO/blob/master/qemu_fifo.sh">Pi's script</a> for pinning IRQ handlers also helps. Hugepages for memory helps.</li>
<li>Kernel parameters: <code>intel_iommu=on iommu=pt pcie_acs_override=downstream pci=realloc vfio-pci.ids=10de:2184,10de:1aeb,10de:1aec,10de:1aed,8086:0d01,8086:156d,8086:156c isolcpus=0-5 nohz_full=0-5 rcu_nocbs=0-5 default_hugepagesz=1G hugepagesz=1G hugepages=12 mitigations=off pcie_aspm=off module_blacklist=nvidia audit=0 loglevel=3 quiet</code>. Everything starting with <code>mitigations=off</code> are optional. <code>pci=realloc</code> is mandatory or you will get <code>NVRM: This PCI I/O region assigned to your NVIDIA device is invalid: NVRM: BAR1 is 0M @ 0x0 (PCI:0000:0a:00.0)</code> error in dmesg and Error 43 for the Nvidia driver in guest.</li>
<li>Add <code>vfio_pci vfio vfio_iommu_type1 vfio_virqfd</code> to your <code>mkinitcpio.conf</code> as normal. Add <code>options kvm ignore_msrs=1</code> and <code>options kvm report_ignored_msrs=N</code> to your <code>/etc/modprobe.d/kvm.conf</code> as well.</li>
<li>For me ACSO patch is mandatory, available from linux-vfio aur.</li>
<li>Enabling MSI for guest GPU seemingly helps. Using <code>ioh3420</code> device and passthrough GPU on top of that DOES NOT seem to help, while making PulseAudio output cracks badly. Setting <code>mixing-engine=off</code> for PulseAudio also makes it cracks badly so consider USB soundcard if needed. (I personally use the sound out on my monitor from guest). While I'm not sure what this option does, setting <code>in.buffer-length</code> on PulseAudio audiodev reduces cracks.</li>
</ul>
<h3>
<span id="Muata.27s_VFIO_setup"></span><span class="mw-headline" id="Muata's_VFIO_setup">Muata's VFIO setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: i7 4790</li>
<li>
<b>Motherboard</b>: MSI B85M-G43 BIOS/UEFI Version: V3.9 (03/30/2015)</li>
<li>
<b>GPU</b>: NVIDIA GeForce GTX 1060 6GB (MSI Gaming+)</li>
<li>
<b>RAM</b>: 16GB</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: linux-zen 5.5.11-1</li>
<li>Using <b>libvirt/QEMU</b>: <a rel="nofollow" class="external text" href="https://github.com/Muata/VFIO">VFIO setup</a>;</li>
<li>
<b>qemu</b>: 4.2.0</li>
<li>
<b>libvirt</b>: 5.10.0</li>
<li>No issues at moment of writing this.</li>
</ul>
<p>&gt; I had some issues with the network, for example, I could not connect to Activision games servers (CoD: MW, Overwatch) but I have changed firewall settings from public to private and everything is good for now.
</p>
<p>&gt; For the first time, I had windows on .raw image and disk was throttling a lot, I have set up raid0 on my 2 HDD's, then I created 3 partitions with LVM - 120GB for windows, 700GB for data(games), 700gb for Linux data and passthrough two of partition as Virtio-BLK. <a href="../../en/LVM_on_software_RAID.html" class="mw-redirect" title="Software RAID and LVM">RAID&amp;LVM</a>
</p>
<p>&gt; Audio passthrough is done through the usual PulseAudio solution, works nicely.
</p>
<p>&gt; For some people who, maybe looking how to passthrough GPU - because it's not obvious when you doing it for the first time and it's not on the wiki though, so when you pass a correct group of vfio-pci.ids then you need to add in (easiest way) a Virtual Machine Manager - Add hardware - PCI Host Device - You graphic card (for me it was 0000:01:00:0 NVIDIA Corporation GP106 [GeForce GTX 1060 6GB]).
</p>
<h3>
<span id="peterge.27s_VFIO_setup"></span><span class="mw-headline" id="peterge's_VFIO_setup">peterge's VFIO setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: AMD Ryzen 5 3700X</li>
<li>
<b>Motherboard</b>: MSI x370 Gaming Pro Carbon</li>
<li>
<b>GPU</b>: SAPPHIRE PULSE Radeon RX 5700 XT (Host), Asus ROG Strix GeForce GTX 1080 (VM)</li>
<li>
<b>RAM</b>: 32GB</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: 5.8.12-arch1-1</li>
<li>Using <b>libvirt/QEMU</b>: <a rel="nofollow" class="external text" href="https://github.com/peterge1998/vfio-setup-libvirt/blob/master/etc/libvirt/qemu/win11.xml">Xml File</a>
</li>
<li>No issues right now.</li>
</ul>
<p>&gt; Mouse and keyboard passthrough with evdev.
</p>
<p>&gt; Monitor connected to both GPUs to display native 144hz.
</p>
<p>&gt; Needed this option in <code>/etc/modprobe.d/kvm.conf</code>, related to my Ryzen CPU: 
<code>options kvm ignore_msrs</code>
</p>
<p>&gt; Had problems passing sound to host with a ICH6 device, sound was crackeling and a bit delayed. Then switched to 
scream-ivshmem and sound is working perfectly now. Its great in combination with looking-glass.
</p>
<p>&gt; Tried to build a solution where i can use my main GPU (GTX 1080) on Host and VM, by rebinding drivers. Rebinding drivers worked on the GTX 1080, but it was not able to use it to offload games from my host gpu back then <a rel="nofollow" class="external text" href="https://www.reddit.com/r/VFIO/comments/eaknqx/enabling_dri_prime1_to_use_passthrough_card_on/">Reddit Post</a> (Got it working with an R9 380 for the host, but needed to restart xorg every time). Then bought the RX 5700 XT, where GPU offloading worked like a charm, but due to the early stage of driver support driver rebinding is not supported <a rel="nofollow" class="external text" href="https://www.reddit.com/r/VFIO/comments/f2ypgz/5700xt_use_amd_gpu_on_host_and_vm_rebind_drivers/">Reddit Post</a>. So i currently have 2 GPUs in my rig.
</p>
<h3>
<span id="CaptainSolidus.27s_VFIO_Setup"></span><span class="mw-headline" id="CaptainSolidus's_VFIO_Setup">CaptainSolidus's VFIO Setup</span>
</h3>
<p>Hardware:
</p>
<ul>
<li>
<b>CPU</b>: Intel Xeon E3-1245 V2</li>
<li>
<b>Motherboard</b>: Gigabyte Z77A-G45 (BIOS/UEFI Version: 2.12)</li>
<li>
<b>Host GPU</b>: AMD ATI Radeon HD 7950/8950 / R9 280 (AMDGPU with SI support enabled)</li>
<li>
<b>Guest GPU</b>: NVIDIA GeForce GTX 1060 6GB</li>
<li>
<b>RAM</b>: 2x8GB DDR3 1600 (8 for the host, 8 for the guest)</li>
</ul>
<p>Configuration:
</p>
<ul>
<li>
<b>Kernel</b>: 5.7.4-1 (ACS-patched)</li>
<li>Using <b>libvirt/QEMU</b>: libvirt 6.4.0/QEMU 5.0.0 <a rel="nofollow" class="external text" href="https://github.com/CaptainSolidus/vfio">VFIO repository</a>
</li>
<li>
<b>Guest OS</b>: Windows 10 Pro 2004</li>
<li>Motherboard puts all PCIe lanes in a single IOMMU group, and no way to edit in BIOS, thus the ACS patch. There seems to be no issues having with this.</li>
<li>CPU Pinning worked best, passing through CPUs 1,2,3,5,6,7 and leaving 0 &amp; 4 for the host. Using "host-model" as CPU type and setting a topology helped with edge case crashes during benchmarking</li>
<li>The Intel integrated graphics worked fine as well, but I kept the R9 280 for anything Linux native or older. Both GPUs work with Looking Glass.</li>
<li>Switched to VirtIO drivers for SCSI and Networking, and ICH9 for audio.</li>
<li>Keyboard and mouse are passed through via the <a href="../../en/PCI_passthrough_via_OVMF.html#Passing_keyboard/mouse_via_Evdev" title="PCI passthrough via OVMF">evdev method</a>
</li>
<li>Audio crackled using PulseAudio passthrough, so I switched to Scream over the bridged network, which works perfectly. The Scream client starts with the system, so I do not need to enable it on boot.</li>
<li>Looking Glass is also set up, and works well on the client. The Looking Glass client is set to boot with the VM, and the VM is set to automatically login (via netplwiz)</li>
<li>Setting up <a href="../../en/PCI_passthrough_via_OVMF.html#Host_lockup_if_guest_is_left_running_during_sleep" title="PCI passthrough via OVMF">sleep prevention</a> will help prevent the host machine sleeping while gaming in the VM</li>
</ul>
<h2><span class="mw-headline" id="Adding_your_own_setup">Adding your own setup</span></h2>
<p>Add a new section with your nickname, CPU, motherboard and GPU models, then copy and paste this template to your section:
</p>
<pre>Hardware:

* '''CPU''': 
* '''Motherboard''': (Revision , BIOS/UEFI Version: )
* '''GPU''': 
* '''RAM''': 

Configuration:

* '''Kernel''': Kernel version (vanilla/CK/Zen/ACS-patched or not).
* Using '''libvirt/QEMU''':
* Issues you have encountered, special steps taken to make something work a bit better, etc.
* Describe your setup loosely here, so that when other wiki users are looking for something, they can easily skim through available setups.
</pre>
<p>Replace proper sections with your own data. Make sure to provide the exact motherboard model, revision (if possible - should be on both the motherboard itself and the box it came in) and BIOS/UEFI version you are using. Describe your exact software setup and add a link to your configuration files. (GitHub, GitLab, BitBucket, etc can host a public repository which you may update once in a while, but uploading them to pastebins is fine, too. <b>Do not</b> post the entire config file contents here.)
</p>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Virtualization.html" title="Category:Virtualization">Virtualization</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li></ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=PCI_passthrough_via_OVMF/Examples&amp;oldid=645116">https://wiki.archlinux.org/index.php?title=PCI_passthrough_via_OVMF/Examples&amp;oldid=645116</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 13 December 2020, at 14:16.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
