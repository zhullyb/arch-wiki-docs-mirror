<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>DKMS package guidelines - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-DKMS_package_guidelines rootpage-DKMS_package_guidelines skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">DKMS package guidelines</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="toc" style="display:block; text-align: center; margin-bottom: 1em;">
<b><a href="../en/Arch_package_guidelines.html" title="Arch package guidelines">Arch package guidelines</a></b>
<hr>
<p><a href="../en/32-bit_package_guidelines.html" title="32-bit package guidelines">32-bit</a> – <a href="../en/CLR_package_guidelines.html" title="CLR package guidelines">CLR</a> – <a href="../en/CMake_package_guidelines.html" title="CMake package guidelines">CMake</a> – <a href="../en/Cross-compiling_tools_package_guidelines.html" title="Cross-compiling tools package guidelines">Cross</a> – <a class="mw-selflink selflink">DKMS</a> – <a href="../en/Eclipse_plugin_package_guidelines.html" title="Eclipse plugin package guidelines">Eclipse</a> – <a href="../en/Electron_package_guidelines.html" title="Electron package guidelines">Electron</a> – <a href="../en/Font_package_guidelines.html" class="mw-redirect" title="Font packaging guidelines">Font</a> – <a href="../en/Free_Pascal_package_guidelines.html" title="Free Pascal package guidelines">Free Pascal</a> – <a href="../en/GNOME_package_guidelines.html" title="GNOME package guidelines">GNOME</a> – <a href="../en/Go_package_guidelines.html" title="Go package guidelines">Go</a> – <a href="../en/Haskell_package_guidelines.html" title="Haskell package guidelines">Haskell</a> – <a href="../en/Java_package_guidelines.html" title="Java package guidelines">Java</a> – <a href="../en/KDE_package_guidelines.html" title="KDE package guidelines">KDE</a> – <a href="../en/Kernel_module_package_guidelines.html" title="Kernel module package guidelines">Kernel</a> – <a href="../en/Lisp_package_guidelines.html" title="Lisp package guidelines">Lisp</a> – <a href="../en/Meson_package_guidelines.html" title="Meson package guidelines">Meson</a> – <a href="../en/MinGW_package_guidelines.html" title="MinGW package guidelines">MinGW</a> – <a href="../en/Node.js_package_guidelines.html" title="Node.js package guidelines">Node.js</a> – <a href="../en/Nonfree_applications_package_guidelines.html" title="Nonfree applications package guidelines">Nonfree</a> – <a href="../en/OCaml_package_guidelines.html" title="OCaml package guidelines">OCaml</a> – <a href="../en/Perl_package_guidelines.html" title="Perl package guidelines">Perl</a> – <a href="../en/PHP_package_guidelines.html" title="PHP package guidelines">PHP</a> – <a href="../en/Python_package_guidelines.html" title="Python package guidelines">Python</a> – <a href="../en/R_package_guidelines.html" title="R package guidelines">R</a> – <a href="../en/Ruby_Gem_package_guidelines.html" title="Ruby Gem package guidelines">Ruby</a> – <a href="../en/Rust_package_guidelines.html" title="Rust package guidelines">Rust</a> – <a href="../en/VCS_package_guidelines.html" title="VCS package guidelines">VCS</a> – <a href="../en/Web_application_package_guidelines.html" title="Web application package guidelines">Web</a> – <a href="../en/Wine_package_guidelines.html" title="Wine package guidelines">Wine</a>
</p>
</div>
<p>Here are some guidelines to follow when creating a <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="DKMS">DKMS</a> package.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Package_name"><span class="tocnumber">1</span> <span class="toctext">Package name</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Dependencies"><span class="tocnumber">2</span> <span class="toctext">Dependencies</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Build_source_location"><span class="tocnumber">3</span> <span class="toctext">Build source location</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Patching"><span class="tocnumber">4</span> <span class="toctext">Patching</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Module_loading_automatically_in_.install"><span class="tocnumber">5</span> <span class="toctext">Module loading automatically in .install</span></a></li>
<li class="toclevel-1 tocsection-6">
<a href="#Example"><span class="tocnumber">6</span> <span class="toctext">Example</span></a>
<ul>
<li class="toclevel-2 tocsection-7"><a href="#PKGBUILD"><span class="tocnumber">6.1</span> <span class="toctext">PKGBUILD</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#dkms.conf"><span class="tocnumber">6.2</span> <span class="toctext">dkms.conf</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#.install"><span class="tocnumber">6.3</span> <span class="toctext">.install</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Package_name">Package name</span></h2>
<p>DKMS packages are named by appending "<i>-dkms</i>" to the original package name.
</p>
<p>The variable <code>$_pkgname</code> is often used below <code>$pkgname</code> to describe the package name minus the "<i>-dkms</i>" suffix (e.g. <code>_pkgname=${pkgname%-*</code>}
</p>
<h2><span class="mw-headline" id="Dependencies">Dependencies</span></h2>
<p>Dependencies should be inherited from the original version with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dkms">dkms</a></span> added and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-headers">linux-headers</a></span> removed (as it is listed by the dkms package as <i>optional</i>).
</p>
<h2><span class="mw-headline" id="Build_source_location">Build source location</span></h2>
<p>Build sources should go into (this is the default build directory for DKMS):
</p>
<pre>/usr/src/<i>PACKAGE_NAME</i>-<i>PACKAGE_VERSION</i>
</pre>
<p>In the package directory, a DKMS configuration tells DKMS how to build the module (<code>dkms.conf</code>), including the variables <code>PACKAGE_NAME</code> and <code>PACKAGE_VERSION</code>.
</p>
<ul>
<li>
<code>PACKAGE_NAME</code> - the actual project name (usually <code>$_pkgname</code> or <code>$_pkgbase</code>).</li>
<li>
<code>PACKAGE_VERSION</code> - by convention this should also be the <code>$pkgver</code>.</li>
</ul>
<h2><span class="mw-headline" id="Patching">Patching</span></h2>
<p>The sources can be patched either directly in the PKGBUILD or through <code>dkms.conf</code>.
</p>
<h2><span class="mw-headline" id="Module_loading_automatically_in_.install">Module loading automatically in .install</span></h2>
<p>Loading and unloading modules should be left to the user.  Consider the possibility a module may crash when loaded.
</p>
<p>Also, please note that you do not have to call <code>depmod</code> explicitly to update the dependencies of your kernel module. Pacman is now calling DKMS <code>dkms install</code> and <code>dkms remove</code> automatically as hooks. <code>dkms install</code> is making sure <code>depmod</code> is called at the end of its process. <code>dkms install</code> depends on <code>dkms build</code> (to build the source against the current kernel), which itself depends on <code>dkms add</code> (to add a symlink from <code>/var/lib/dkms/&lt;package&gt;/&lt;version&gt;/source</code> to <code>/usr/src/&lt;package&gt;</code>).
</p>
<h2><span class="mw-headline" id="Example">Example</span></h2>
<p>Here is an example package that edits <code>dkms.conf</code> according to the package name and version.
</p>
<h3><span class="mw-headline" id="PKGBUILD">PKGBUILD</span></h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">PKGBUILD</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Maintainer: foo &lt;foo(at)example(dot)org&gt;
# Contributor: bar &lt;bar(at)example(dot)org&gt;

_pkgbase=example
pkgname=example-dkms
pkgver=1
pkgrel=1
pkgdesc="The Example kernel modules (DKMS)"
arch=('i686' 'x86_64')
url="<a rel="nofollow" class="external free" href="https://www.example.org/">https://www.example.org/</a>"
license=('GPL2')
depends=('dkms')
conflicts=("${_pkgbase}")
install=${pkgname}.install
source=("${url}/files/tarball.tar.gz"
        'dkms.conf'
        'linux-3.14.patch')
md5sums=(<i>use 'updpkgsums'</i>)

prepare() {
  cd ${_pkgbase}-${pkgver}

  # Patch
  patch -p1 -i "${srcdir}"/linux-3.14.patch

}

package() {
  # Install
  make DESTDIR="${pkgdir}" install

  # Copy dkms.conf
  install -Dm644 dkms.conf "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf

  # Set name and version
  sed -e "s/@_PKGBASE@/${_pkgbase}/" \
      -e "s/@PKGVER@/${pkgver}/" \
      -i "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf

  # Copy sources (including Makefile)
  cp -r ${_pkgbase}/* "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/
}</pre>
<h3><span class="mw-headline" id="dkms.conf">dkms.conf</span></h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">dkms.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">PACKAGE_NAME="@_PKGBASE@"
PACKAGE_VERSION="@PKGVER@"
MAKE[0]="make --uname_r=$kernelver"
CLEAN="make clean"
BUILT_MODULE_NAME[0]="@_PKGBASE@"
DEST_MODULE_LOCATION[0]="/kernel/drivers/misc"
AUTOINSTALL="yes"</pre>
<h3><span class="mw-headline" id=".install">.install</span></h3>
<p>Now pacman has DKMS hooks implemented, you do not have to specify DKMS-specific configuration in your .install file. Calls to <code>dkms install</code> and <code>dkms remove</code> will be automatic.
</p>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Arch_package_guidelines.html" title="Category:Arch package guidelines">Arch package guidelines</a></li></ul>
</div></div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=DKMS_package_guidelines&amp;oldid=633332">https://wiki.archlinux.org/index.php?title=DKMS_package_guidelines&amp;oldid=633332</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 25 August 2020, at 02:36.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
