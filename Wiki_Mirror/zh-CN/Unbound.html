<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Unbound (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Unbound_简体中文 rootpage-Unbound_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Unbound (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="/title/Domain_name_resolution" title="Domain name resolution">Domain name resolution</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="https://unbound.net/">Unbound</a> 是一个具有验证，递归和缓存等功能的 DNS 解析器。根据<a href="https://en.wikipedia.org/wiki/Unbound_(DNS_Server)" class="extiw" title="wikipedia:Unbound (DNS Server)">Wikipedia</a>：
</p>
<dl><dd>Unbound has supplanted the Berkeley Internet Name Domain (<a href="/title/BIND" title="BIND">BIND</a>) as the default, base-system name server in several open source projects, where it is perceived as smaller, more modern, and more secure for most applications.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻译状态：</strong>本文是 <a href="/title/Unbound" title="Unbound">Unbound</a> 的<a href="/title/ArchWiki:Translation_Team_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="ArchWiki:Translation Team (简体中文)">翻译</a>。上次翻译日期：2019-03-24。如果英文版本有所<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Unbound&amp;diff=0&amp;oldid=397940">更改</a>，则您可以帮助同步翻译。</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%E5%AE%89%E8%A3%85"><span class="tocnumber">1</span> <span class="toctext">安装</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#%E9%85%8D%E7%BD%AE"><span class="tocnumber">2</span> <span class="toctext">配置</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#%E6%9C%AC%E5%9C%B0DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">2.1</span> <span class="toctext">本地DNS服务器</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="tocnumber">2.2</span> <span class="toctext">访问控制</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#%E4%BD%BF%E7%94%A8DNS_over_TLS%E8%BF%9B%E8%A1%8C%E8%BD%AC%E5%8F%91"><span class="tocnumber">2.3</span> <span class="toctext">使用DNS over TLS进行转发</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#%E6%A0%B9%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">2.4</span> <span class="toctext">根域名服务器</span></a></li>
<li class="toclevel-2 tocsection-7">
<a href="#DNSSEC%E9%AA%8C%E8%AF%81"><span class="tocnumber">2.5</span> <span class="toctext">DNSSEC验证</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#%E6%B5%8B%E8%AF%95DNSSEC"><span class="tocnumber">2.5.1</span> <span class="toctext">测试DNSSEC</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-9">
<a href="#%E8%BD%AC%E5%8F%91%E6%9F%A5%E8%AF%A2"><span class="tocnumber">2.6</span> <span class="toctext">转发查询</span></a>
<ul>
<li class="toclevel-3 tocsection-10">
<a href="#%E5%85%81%E8%AE%B8%E6%9C%AC%E5%9C%B0%E7%BD%91%E7%BB%9C%E4%BD%BF%E7%94%A8DNS"><span class="tocnumber">2.6.1</span> <span class="toctext">允许本地网络使用DNS</span></a>
<ul>
<li class="toclevel-4 tocsection-11"><a href="#%E4%BD%BF%E7%94%A8openresolv"><span class="tocnumber">2.6.1.1</span> <span class="toctext">使用openresolv</span></a></li>
<li class="toclevel-4 tocsection-12">
<a href="#%E6%89%8B%E5%8A%A8%E5%88%B6%E5%AE%9ADNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">2.6.1.2</span> <span class="toctext">手动制定DNS服务器</span></a>
<ul>
<li class="toclevel-5 tocsection-13"><a href="#%E5%8C%85%E5%90%AB%E6%9C%AC%E5%9C%B0DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">2.6.1.2.1</span> <span class="toctext">包含本地DNS服务器</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-3 tocsection-14">
<a href="#%E8%BD%AC%E5%8F%91%E6%89%80%E6%9C%89%E5%85%B6%E4%BD%99%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="tocnumber">2.6.2</span> <span class="toctext">转发所有其余的请求</span></a>
<ul>
<li class="toclevel-4 tocsection-15"><a href="#%E4%BD%BF%E7%94%A8openresolv_2"><span class="tocnumber">2.6.2.1</span> <span class="toctext">使用openresolv</span></a></li>
<li class="toclevel-4 tocsection-16"><a href="#%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9ADNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">2.6.2.2</span> <span class="toctext">手动指定DNS服务器</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-17">
<a href="#%E4%BD%BF%E7%94%A8"><span class="tocnumber">3</span> <span class="toctext">使用</span></a>
<ul>
<li class="toclevel-2 tocsection-18"><a href="#%E5%90%AF%E5%8A%A8unbound"><span class="tocnumber">3.1</span> <span class="toctext">启动unbound</span></a></li>
<li class="toclevel-2 tocsection-19">
<a href="#%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6unbound"><span class="tocnumber">3.2</span> <span class="toctext">远程控制unbound</span></a>
<ul>
<li class="toclevel-3 tocsection-20"><a href="#%E9%85%8D%E7%BD%AEunbound-control"><span class="tocnumber">3.2.1</span> <span class="toctext">配置unbound-control</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="#%E4%BD%BF%E7%94%A8unbound-control"><span class="tocnumber">3.2.2</span> <span class="toctext">使用unbound-control</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-22">
<a href="#%E6%8F%90%E7%A4%BA%E4%B8%8E%E6%8A%80%E5%B7%A7"><span class="tocnumber">4</span> <span class="toctext">提示与技巧</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="#%E5%9F%9F%E5%90%8D%E9%BB%91%E5%90%8D%E5%8D%95"><span class="tocnumber">4.1</span> <span class="toctext">域名黑名单</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAauthoritative_DNS%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">4.2</span> <span class="toctext">添加一个authoritative DNS服务器</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="#WAN_facing_DNS"><span class="tocnumber">4.3</span> <span class="toctext">WAN facing DNS</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#%E6%A0%B9%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Esystemd_timer"><span class="tocnumber">4.4</span> <span class="toctext">根域名服务器与systemd timer</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-27">
<a href="#%E7%96%91%E9%9A%BE%E8%A7%A3%E7%AD%94"><span class="tocnumber">5</span> <span class="toctext">疑难解答</span></a>
<ul>
<li class="toclevel-2 tocsection-28"><a href="#%E6%9C%89%E5%85%B3num-threads%E7%9A%84%E9%97%AE%E9%A2%98"><span class="tocnumber">5.1</span> <span class="toctext">有关num-threads的问题</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-29"><a href="#%E5%8F%82%E9%98%85"><span class="tocnumber">6</span> <span class="toctext">参阅</span></a></li>
</ul>
</div>

<h2>
<span id=".E5.AE.89.E8.A3.85"></span><span class="mw-headline" id="安装">安装</span>
</h2>
<p>安装 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=unbound">unbound</a></span> 软件包。
此外, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=expat">expat</a></span> 是使用<a href="/title/DNSSEC" title="DNSSEC">DNSSEC</a>验证请求所必须的。
</p>
<h2>
<span id=".E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="配置">配置</span>
</h2>
<p>默认配置已经位于<code>/etc/unbound/unbound.conf</code>文件中。此外，<code>/etc/unbound/unbound.conf.example</code>文件包含了其他的可配置设置项，并以注释的形式给出了示范设置。以下章节重点解释和默认配置文件不同的设置项。如需了解更多细节，参见<span class="plainlinks archwiki-template-man" title="$ man 5 unbound.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/unbound.conf.5">unbound.conf(5)</a></span>。
</p>
<p>除非特别声明，这一节列出的选项都是放置在配置文件的<code>server</code>节中，类似这样：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server:
  ...
  <i>setting</i>: <i>value</i>
  ...
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 请确保你的配置文件中已经设置了<code>do-daemonize: no</code>,否则<code>unbound.service</code>会无法启动.</div>
<h3>
<span id=".E6.9C.AC.E5.9C.B0DNS.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="本地DNS服务器">本地DNS服务器</span>
</h3>
<p>如果你想要使用<i>unbound</i>作为本地DNS服务器，请把<a href="/title/Resolv.conf" class="mw-redirect" title="Resolv.conf">resolv.conf</a>中的域名服务器（nameserver）设置到回环地址<code>::1</code>和<code>127.0.0.1</code>。你可能想要让你的配置<a href="/title/Domain_name_resolution_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E7%BB%99/etc/resolv.conf%E6%B7%BB%E5%8A%A0%E5%86%99%E4%BF%9D%E6%8A%A4" title="Domain name resolution (简体中文)">Domain name resolution (简体中文)#给/etc/resolv.conf添加写保护</a>。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 实现这个目的的一个简便方法是安装<a href="/title/Openresolv" title="Openresolv">openresolv</a>，然后取消文件<code>/etc/resolvconf.conf</code>中包含<code>name_servers="::1 127.0.0.1"</code>的那一行的注释。然后运行<code>resolvconf -u</code>来重新生成<code>/etc/resolv.conf</code>。</div>
<p>要了解如何测试设置项，参见<a href="/title/Domain_name_resolution#Lookup_utilities" title="Domain name resolution">Domain name resolution#Lookup utilities</a>。
</p>
<p>在把<a href="/title/Resolv.conf" class="mw-redirect" title="Resolv.conf">resolv.conf</a>中的设置更改为持久化设置后，请特别注意检查正在使用的服务器是<code>::1</code>或<code>127.0.0.1</code>。
</p>
<p>你还需要对“unbound”进行设置，以使它<a href="#%E8%BD%AC%E5%8F%91%E6%9F%A5%E8%AF%A2">#转发查询</a>到你所选择的DNS服务器。
</p>
<h3>
<span id=".E8.AE.BF.E9.97.AE.E6.8E.A7.E5.88.B6"></span><span class="mw-headline" id="访问控制">访问控制</span>
</h3>
<p>你可以通过IP地址来指定响应请求的端口。默认监听的是<i>localhost</i>。
</p>
<p>为了在所有端口上监听，使用以下配置：
</p>
<pre>interface: 0.0.0.0
</pre>
<p>为了通过IP地址来控制可以访问服务器的系统，使用<code>access-control</code>选项：
</p>
<pre>access-control: <i>subnet</i> <i>action</i>
</pre>
<p>例如:
</p>
<pre>access-control: 192.168.1.0/24 allow
</pre>
<p><i>action</i>可以是<code>deny</code> (drop message), <code>refuse</code> (polite error reply), <code>allow</code> (recursive ok), or <code>allow_snoop</code> (recursive and nonrecursive ok)中的任意一个。默认除了localhost之外的所有东西都会被拒绝。
</p>
<h3>
<span id=".E4.BD.BF.E7.94.A8DNS_over_TLS.E8.BF.9B.E8.A1.8C.E8.BD.AC.E5.8F.91"></span><span class="mw-headline" id="使用DNS_over_TLS进行转发">使用DNS over TLS进行转发</span>
</h3>
<p>为了使用这个功能，你需要设置<code>tls-cert-bundle</code>选项来指定本地系统的根证书认证包，以使得unbound可以转发TLS请求并指定允许DNS over TLS的服务器数量。
</p>
<p>对每个服务器你都需要用 @ 来指定连接的端口，同时你也要用 # 来指明它的域名是什么。虽然它看起来像注释，the hashtag name allows for the TLS authentication name to be set for stub-zones and with <code>unbound-control forward control</code> command。在 @ 和 # 之间不应该有空格。
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server:
...
	tls-cert-bundle: /etc/ssl/certs/ca-certificates.crt
...
forward-zone:
        name: "."
        forward-tls-upstream: yes
        forward-addr: 1.1.1.1@853#cloudflare-dns.com
</pre>
<h3>
<span id=".E6.A0.B9.E5.9F.9F.E5.90.8D.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="根域名服务器">根域名服务器</span>
</h3>
<p>为了查询一个没有被缓存成地址的主机，解释器需要从服务器树的根开始、对根服务器进行请求来知道去哪里找到目标地址的顶级域名。Unbound内置了一些根节点，但是推荐你提供一个根节点文件给它以免内置的过于老旧。
</p>
<p>首先，告诉<i>unbound</i>使用<code>root.hints</code>文件：
</p>
<pre>root-hints: root.hints
</pre>
<p>然后把你的<i>root hints</i>文件放进<i>unbound</i>的配置文件夹。实现这个目标最简单的方法是运行下面的命令：
</p>
<pre># curl -o /etc/unbound/root.hints https://www.internic.net/domain/named.cache</pre>
<p>建议每六个月更新一次<code>root.hints</code>来保持根服务器列表是最新的。你可以手动完成这个任务，也可以使用<a href="/title/Systemd/Timers" title="Systemd/Timers">Systemd/Timers</a>。详情参见<a href="#%E6%A0%B9%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Esystemd_timer">#根域名服务器与systemd timer</a>。
</p>
<h3>
<span id="DNSSEC.E9.AA.8C.E8.AF.81"></span><span class="mw-headline" id="DNSSEC验证">DNSSEC验证</span>
</h3>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="/title/File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> DNSSEC默认启用.<a rel="nofollow" class="external autonumber" href="https://github.com/archlinux/svntogit-community/commit/79f1ebebd72b53d3b597f6dc48b84f3d76dd9a0c/trunk/conf">[1]</a>. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Unbound_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Unbound (简体中文)#</a>)</div>
</div>
<p>为了使用<a href="/title/DNSSEC" title="DNSSEC">DNSSEC</a>验证，你需要在<code>server:</code>节中添加以下设置来告诉<i>unbound</i>服务器根证书文件的位置：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">trust-anchor-file: trusted-key.key</pre>
<p><code>/etc/unbound/trusted-key.key</code>是从依赖项<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnssec-anchors">dnssec-anchors</a></span>所提供的的<code>/etc/trusted-key.key</code>复制而来的，它的<a href="/title/PKGBUILD" title="PKGBUILD">PKGBUILD</a>按照<span class="plainlinks archwiki-template-man" title="$ man 8 unbound-anchor"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/unbound-anchor.8">unbound-anchor(8)</a></span>生成了<code>/etc/trusted-key.key</code>。
</p>
<p>如果总的<a href="#%E8%BD%AC%E5%8F%91%E6%9F%A5%E8%AF%A2">#转发查询</a>设置到了不支持DNSSEC的DNS服务器，那么请确保已经把这些DNS服务器注释掉，否则DNS请求会失败。DNSSEC验证只会在被请求的DNS服务器支持它的时候成功完成。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 如果使用DNSSEC，在地址被缓存之前DNS查询时间将会显著增加。</div>
<h4>
<span id=".E6.B5.8B.E8.AF.95DNSSEC"></span><span class="mw-headline" id="测试DNSSEC">测试DNSSEC</span>
</h4>
<p>为了测试DNSSEC是否工作，在<a href="/title/Starting" class="mw-redirect" title="Starting">starting</a> <code>unbound.service</code>之后：
</p>
<pre>$ unbound-host -C /etc/unbound/unbound.conf -v sigok.verteiltesysteme.net
</pre>
<p>得到的回应应该是附带<code>(secure)</code>字样的ip地址。
</p>
<pre>$ unbound-host -C /etc/unbound/unbound.conf -v sigfail.verteiltesysteme.net
</pre>
<p>这次的回应应该包含<code>(BOGUS (security failure))</code>字样。
</p>
<p>另外你也可以使用“drill”来测试：
</p>
<pre>$ drill sigok.verteiltesysteme.net
$ drill sigfail.verteiltesysteme.net
</pre>
<p>第一个命令应该返回<code>NOERROR</code>的<code>rcode</code>；而第二个命令应该返回<code>SERVFAIL</code>的<code>rcode</code>。
</p>
<h3>
<span id=".E8.BD.AC.E5.8F.91.E6.9F.A5.E8.AF.A2"></span><span class="mw-headline" id="转发查询">转发查询</span>
</h3>
<p>如果你只想转发请求到外部的DNS服务器，请跳到<a href="#%E8%BD%AC%E5%8F%91%E6%89%80%E6%9C%89%E5%85%B6%E4%BD%99%E7%9A%84%E8%AF%B7%E6%B1%82">#转发所有其余的请求</a>。
</p>
<h4>
<span id=".E5.85.81.E8.AE.B8.E6.9C.AC.E5.9C.B0.E7.BD.91.E7.BB.9C.E4.BD.BF.E7.94.A8DNS"></span><span class="mw-headline" id="允许本地网络使用DNS">允许本地网络使用DNS</span>
</h4>
<h5>
<span id=".E4.BD.BF.E7.94.A8openresolv"></span><span class="mw-headline" id="使用openresolv">使用openresolv</span>
</h5>
<p>如果你的网络管理器支持<a href="/title/Openresolv" title="Openresolv">openresolv</a>，你可以通过设置来使它提供本地DNS服务器、使用unbound来查询域名。
<a rel="nofollow" class="external autonumber" href="https://roy.marples.name/projects/openresolv/configuration.html">[2]</a>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolvconf.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
private_interfaces="*"

# Write out unbound configuration file
unbound_conf=/etc/unbound/resolvconf.conf</pre>
<p>运行<code>resolvconf -u</code>来生成文件。
</p>
<p>配置unbound读取openresolv生成的文件并允许回应<a href="https://en.wikipedia.org/wiki/Private_network" class="extiw" title="wikipedia:Private network">private IP address ranges</a>：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">include: "/etc/unbound/resolvconf.conf"
...
server:
...
   private-domain: "intranet"
   private-domain: "internal"
   private-domain: "private"
   private-domain: "corp"
   private-domain: "home"
   private-domain: "lan"

   unblock-lan-zones: yes
   insecure-lan-zones: yes
   ...
</pre>
<p>另外你可能想要对私有DNS域名空间禁用DNSSEC<a rel="nofollow" class="external autonumber" href="https://tools.ietf.org/html/rfc6762#appendix-G">[3]</a>：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">

...
server:
...
   domain-insecure: "intranet"
   domain-insecure: "internal"
   domain-insecure: "private"
   domain-insecure: "corp"
   domain-insecure: "home"
   domain-insecure: "lan"
...
</pre>
<h5>
<span id=".E6.89.8B.E5.8A.A8.E5.88.B6.E5.AE.9ADNS.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="手动制定DNS服务器">手动制定DNS服务器</span>
</h5>
<p>如果你有一个需要DNS请求的本地网络，同时你想要把请求都转发给一个本地的DNS服务器，那么你需要添加这一行：
</p>
<pre>private-address: <i>本地子网/子网掩码</i>
</pre>
<p>例如:
</p>
<pre>private-address: 10.0.0.0/24
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 你可以使用私有地址来防止DNS劫持攻击。为了达到这个目的，你可能需要允许RFC1918网络(10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 169.254.0.0/16 fd00::/8 fe80::/10)。 Unbound的未来版本可能会默认启用这个功能。</div>
<h6>
<span id=".E5.8C.85.E5.90.AB.E6.9C.AC.E5.9C.B0DNS.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="包含本地DNS服务器">包含本地DNS服务器</span>
</h6>
<p>为了包含一个本地DNS服务器，以用于转发和反代本地地址，类似下面的一组配置是必要的（请把下面的10.0.0.1替换为本地网络中提供DNS服务的服务器的地址）：
</p>
<pre>local-zone: "10.in-addr.arpa." transparent
</pre>
<p>上面这一行对于让反向查询正常工作是非常重要的。
</p>
<pre>forward-zone:
name: "mynetwork.com."
forward-addr: 10.0.0.1
forward-zone:
local-data: "1.0.0.127.in-addr.arpa. 10800 IN PTR localhost."
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 转发空间和根空间之间的区别是，根空间只有在直接连接到一个authoritative DNS服务器的时候才能正常工作。如果一个<a href="/title/BIND" title="BIND">BIND</a>DNS服务器提供authoritative DNS，那么这个特性对于来自于它的请求有用——但是如果你在把请求指向一个<i>unbound</i>服务器（内部查询都被转发到另一个DNS服务器），那么把这个指向定义为该机器上的根空间是不会起作用的。在这种情况下，你必须把它定义为上面所说的转发空间，因为转发空间可以通过链式查询去到别的DNS服务器上，亦即转发空间可以把请求指向递归DNS服务器。这个区别是很重要的，因为如果你不恰当地使用根空间，你不会得到能够说明问题的错误信息。</div>
<p>你可以通过下面的配置来设定localhost的前向和反向查询：
</p>
<pre>local-zone: "localhost." static
local-data: "localhost. 10800 IN NS localhost."
local-data: "localhost. 10800 IN SOA localhost. nobody.invalid. 1 3600 1200 604800 10800"
local-data: "localhost. 10800 IN A 127.0.0.1"
local-zone: "127.in-addr.arpa." static
local-data: "127.in-addr.arpa. 10800 IN NS localhost."
local-data: "127.in-addr.arpa. 10800 IN SOA localhost. nobody.invalid. 2 3600 1200 604800 10800"
local-data: "1.0.0.127.in-addr.arpa. 10800 IN PTR localhost."
</pre>
<h4>
<span id=".E8.BD.AC.E5.8F.91.E6.89.80.E6.9C.89.E5.85.B6.E4.BD.99.E7.9A.84.E8.AF.B7.E6.B1.82"></span><span class="mw-headline" id="转发所有其余的请求">转发所有其余的请求</span>
</h4>
<h5>
<span id=".E4.BD.BF.E7.94.A8openresolv_2"></span><span class="mw-headline" id="使用openresolv_2">使用openresolv</span>
</h5>
<p>如果你的网络管理器支持<a href="/title/Openresolv" title="Openresolv">openresolv</a>，你可以通过配置使它提供上游DNS服务器给unbound。
<a rel="nofollow" class="external autonumber" href="https://roy.marples.name/projects/openresolv/configuration.html">[4]</a>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolvconf.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
# Write out unbound configuration file
unbound_conf=/etc/unbound/resolvconf.conf</pre>
<p>运行<code>resolvconf -u</code>来生成文件。
</p>
<p>最后配置unound读取openresolv生成的文件：
</p>
<pre>include: "/etc/unbound/resolvconf.conf"
</pre>
<h5>
<span id=".E6.89.8B.E5.8A.A8.E6.8C.87.E5.AE.9ADNS.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="手动指定DNS服务器">手动指定DNS服务器</span>
</h5>
<p>为了使本地机器之外的、本地网络外部的默认转发区域使用指定的服务器，请在配置文件中添加一个名字是<code>.</code>的转发区域。在这个例子里，所有的请求都被转发到谷歌的DNS服务器：
</p>
<pre>forward-zone:
  name: "."
  forward-addr: 8.8.8.8
  forward-addr: 8.8.4.4
</pre>
<h2>
<span id=".E4.BD.BF.E7.94.A8"></span><span class="mw-headline" id="使用">使用</span>
</h2>
<h3>
<span id=".E5.90.AF.E5.8A.A8unbound"></span><span class="mw-headline" id="启动unbound">启动unbound</span>
</h3>
<p><a href="/title/Start/enable" class="mw-redirect" title="Start/enable">Start/enable</a> <code>unbound.service</code> systemd服务。
</p>
<h3>
<span id=".E8.BF.9C.E7.A8.8B.E6.8E.A7.E5.88.B6unbound"></span><span class="mw-headline" id="远程控制unbound">远程控制unbound</span>
</h3>
<p><i>unbound</i>安装的时候自带了<code>unbound-control</code>工具，利用这个工具我们可以远程控制unbound服务器。它和<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pdnsd">pdnsd</a></span>的<a href="/title/Pdnsd#pdnsd-ctl" title="Pdnsd">pdnsd-ctl</a>命令很类似。
</p>
<h4>
<span id=".E9.85.8D.E7.BD.AEunbound-control"></span><span class="mw-headline" id="配置unbound-control">配置unbound-control</span>
</h4>
<p>在能够使用它之前你需要做下面的事情：
</p>
<p>1) 首先，运行：
</p>
<pre># unbound-control-setup
</pre>
<p>来为你的服务器和客户端生成一个self-signed的证书和private key。生成的文件位于<code>/etc/unbound</code>文件夹。
</p>
<p>2) 然后，把下面的内容放进<code>/etc/unbound/unbound.conf</code>文件。<code>control-enable: yes</code>是一定要有的，其余的内容可以按照所需进行调整。
</p>
<pre>remote-control:
   # Enable remote control with unbound-control(8) here.
   # 用unbound-control-setup生成的keys and certificates进行配置。
   control-enable: yes
   # 设定监听哪个地址.
   # give 0.0.0.0 and ::0 to listen to all interfaces.
   control-interface: 127.0.0.1
   # 远程控制用的端口.
   control-port: 8953
   # unbound server key file.
   server-key-file: "/etc/unbound/unbound_server.key"
   # unbound server certificate file.
   server-cert-file: "/etc/unbound/unbound_server.pem"
   # unbound-control key file.
   control-key-file: "/etc/unbound/unbound_control.key"
   # unbound-control certificate file.
   control-cert-file: "/etc/unbound/unbound_control.pem"
</pre>
<h4>
<span id=".E4.BD.BF.E7.94.A8unbound-control"></span><span class="mw-headline" id="使用unbound-control">使用unbound-control</span>
</h4>
<p>下面是<i>unbound-control</i>可以使用的一部分命令：
</p>
<ul><li>不重置数据的情况下查看统计数据</li></ul>
<pre> # unbound-control stats_noreset
</pre>
<ul><li>把cache dump到stdout</li></ul>
<pre> # unbound-control dump_cache
</pre>
<ul><li>清空cache并且重新加载配置</li></ul>
<pre> # unbound-control reload
</pre>
<p>请参考<span class="plainlinks archwiki-template-man" title="$ man 8 unbound-control"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/unbound-control.8">unbound-control(8)</a></span>来了解<i>unbound-control</i>支持的操作。
</p>
<h2>
<span id=".E6.8F.90.E7.A4.BA.E4.B8.8E.E6.8A.80.E5.B7.A7"></span><span class="mw-headline" id="提示与技巧">提示与技巧</span>
</h2>
<h3>
<span id=".E5.9F.9F.E5.90.8D.E9.BB.91.E5.90.8D.E5.8D.95"></span><span class="mw-headline" id="域名黑名单">域名黑名单</span>
</h3>
<p>你可以打开这个网页<a rel="nofollow" class="external text" href="https://pgl.yoyo.org/adservers/serverlist.php?hostformat=unbound&amp;showintro=0&amp;startdate%5Bday%5D=&amp;startdate%5Bmonth%5D=&amp;startdate%5Byear%5D=&amp;mimetype=plaintext">adservers</a>，把它的内容保存到<code>/etc/unbound/adservers</code>，然后把下面的配置直接添加到unbound配置文件里就可以了：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/unbound/unbound.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server:
...
  include: /etc/unbound/adservers
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>为了在查询这些hosts的时候返回OK状态指示，你可以更改默认的127.0.0.1重定向，改成重定向到你所控制的服务器并让那台服务器返回空的204回应，参考<a rel="nofollow" class="external autonumber" href="https://www.shadowandy.net/2014/04/adblocking-nginx-serving-1-pixel-gif-204-content.htm">[5]</a>
</li>
<li>如果需要把其他格式的hosts文件转换成unbound的格式的，请运行这个命令: <pre>$ grep '^0\.0\.0\.0' <i>hostsfile</i> | awk '{print "local-zone: \""$2"\" always_nxdomain"}' &gt; /etc/unbound/adservers</pre>
</li>
</ul>
</div>
<h3>
<span id=".E6.B7.BB.E5.8A.A0.E4.B8.80.E4.B8.AAauthoritative_DNS.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="添加一个authoritative_DNS服务器">添加一个authoritative DNS服务器</span>
</h3>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="/title/File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> 同时运行两个DNS服务器并不一定比只运行一个提供所有功能的DNS服务器更安全。  (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Unbound_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Unbound (简体中文)#</a>)</div>
</div>
<p>对于想要在一台机器上同时两个DNS服务器（一个是提供验证、递归、缓存功能的DNS服务器，另一个是authoritative DNS服务器）的用户来说，参考<a href="/title/NSD" title="NSD">NSD</a>的维基页面可能会有所帮助。那个页面提供了一个示范配置。一个服务器专门响应authoritative DNS请求，另一个服务器提供验证、递归、缓存等DNS功能，这样会比一个服务器提供所有功能会更安全。很多用户已经在使用Bind作为DNS服务器，而针对从Bind变成Bind和NSD协同工作的过程的帮助在<a href="/title/NSD" title="NSD">NSD</a>页面有提供。
</p>
<h3><span class="mw-headline" id="WAN_facing_DNS">WAN facing DNS</span></h3>
<p>通过更改配置文件和服务器所监听的接口（地址）来允许来自本地网络之外的机器的DNS请求进入本地网络（LAN）内的某台特定机器，这个想法是可行的。这个功能对于公开的网站服务器和邮件服务器是非常有用的。这个在bind上已经实现了多年的技术，通过正确配置防火墙机器上的端口转发——转发这些请求到正确的机器上——也可以在unbound上实现。
</p>
<h3>
<span id=".E6.A0.B9.E5.9F.9F.E5.90.8D.E6.9C.8D.E5.8A.A1.E5.99.A8.E4.B8.8Esystemd_timer"></span><span class="mw-headline" id="根域名服务器与systemd_timer">根域名服务器与systemd timer</span>
</h3>
<p>下面是一个systemd服务和timer的示例文件，它用来每隔一个月更新一次<code>root.hints</code>，所用的方法与<a href="#%E6%A0%B9%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8">#根域名服务器</a>中的相同：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/roothints.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Update root hints for unbound
After=network.target

[Service]
ExecStart=/usr/bin/curl -o /etc/unbound/root.hints https://www.internic.net/domain/named.cache</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/roothints.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Run root.hints monthly

[Timer]
OnCalendar=monthly
Persistent=true

[Install]
WantedBy=timers.target</pre>
<p>最后<a href="/title/Start/enable" class="mw-redirect" title="Start/enable">Start/enable</a> <code>roothints.timer</code> systemd timer就可以了。
</p>
<h2>
<span id=".E7.96.91.E9.9A.BE.E8.A7.A3.E7.AD.94"></span><span class="mw-headline" id="疑难解答">疑难解答</span>
</h2>
<h3>
<span id=".E6.9C.89.E5.85.B3num-threads.E7.9A.84.E9.97.AE.E9.A2.98"></span><span class="mw-headline" id="有关num-threads的问题">有关num-threads的问题</span>
</h3>
<p><code>unbound.conf</code>的man page提到：
</p>
<pre>     outgoing-range: &lt;number&gt;
           Number of ports to open. This number of file  descriptors  can  be  opened  per thread.
</pre>
<p>网上的一些人建议<code>num-threads</code>这个参数应该设置成你的CPU的核心数量。示范配置文件<code>unbound.conf.example</code>里关于这个选项只有下面这两行：
</p>
<pre>       # number of threads to create. 1 disables threading.
       # num-threads: 1
</pre>
<p>但是人为地把<code>num-threads</code>提高到比<code>1</code>就一定会造成<i>unbound</i>在启动的时候在log里写一个warning提示说exceeding the number of file descriptors。实际上对于大多数在小型网络或是单机上运行unbound的用户来说，通过让<code>num-threads</code>超过<code>1</code>来得到性能提升是徒劳的。如果你一定要这么做，那么请参考<a rel="nofollow" class="external text" href="https://www.unbound.net/documentation/howto_optimise.html">official documentation</a>。下面这条经验法则应该对你有所帮助：
</p>
<dl><dd><i>Set <code>num-threads</code> equal to the number of CPU cores on the system. E.g. for 4 CPUs with 2 cores each, use 8.</i></dd></dl>
<p>把<code>outgoing-range</code>设置得尽可能大，参考上面的链接来突破总数是<code>1024</code>这个限制。这样就会使得unbound可以同时为更多客户端提供服务。1个核心设置<code>950</code>，2个核心设置<code>450</code>，四个核心设置<code>200</code>。<code>num-queries-per-thread</code>最好设置成<code>outgoing-range</code>的一半。
</p>
<p>因为<code>outgoing-range</code>是有限制的，同时<code>num-queries-per-thread</code>也因此受到了限制，所以最好在编译的时候带上<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libevent">libevent</a></span>，这样就不会有<code>1024</code>限制了。如果你有一个高负荷DNS服务器使得你不得不这样编译，你需要从源码编译unbound而不是直接安装<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=unbound">unbound</a></span>。
</p>
<h2>
<span id=".E5.8F.82.E9.98.85"></span><span class="mw-headline" id="参阅">参阅</span>
</h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://fedoraproject.org/wiki/Changes/Default_Local_DNS_Resolver">Fedora change to Unbound</a></li>
<li><a rel="nofollow" class="external text" href="https://github.com/jodrell/unbound-block-hosts/">Block hosts that contain advertisements</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="/title/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="/title/Category:Domain_Name_System_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="Category:Domain Name System (简体中文)">Domain Name System (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="/title/Category:Pages_or_sections_flagged_with_Template:Out_of_date" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
<li><a href="/title/Category:Pages_or_sections_flagged_with_Template:Accuracy" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Unbound_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=669473">https://wiki.archlinux.org/index.php?title=Unbound_(简体中文)&amp;oldid=669473</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 8 May 2021, at 11:51.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="/title/ArchWiki:Privacy_policy" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="/title/ArchWiki:About" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="/title/ArchWiki:General_disclaimer" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
