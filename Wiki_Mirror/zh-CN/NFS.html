<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>NFS (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-NFS_简体中文 rootpage-NFS_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">NFS (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻译状态：</strong>本文是 <a href="../en/NFS.html" title="NFS">NFS</a> 的<a href="../zh-CN/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (简体中文)">翻译</a>。上次翻译日期：2020-06-10。如果英文版本有所<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=NFS&amp;diff=0&amp;oldid=615653">更改</a>，则您可以帮助同步翻译。</div>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a><b>本文或本节需要<a href="../zh-CN/ArchWiki:Contributing.html#%E7%BF%BB%E8%AF%91" title="ArchWiki:Contributing (简体中文)">翻译</a>。要贡献翻译，请访问<a href="../zh-CN/ArchWiki:Translation_Team.html" class="mw-redirect" title="ArchWiki Translation Team (简体中文)">简体中文翻译团队</a>。</b><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>附注：</b> Some content is not translated.（在 <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:NFS_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:NFS (简体中文)#</a> 中讨论）</div>
</div>
<p>来自<a href="https://en.wikipedia.org/wiki/Network_File_System" class="extiw" title="wikipedia:Network File System">维基百科</a>：NFS 网络文件系统(Network File System) 是由Sun公司1984年发布的分布式文件系统协议。它允许客户端上的用户像访问本地文件一样地访问网络上的文件。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 
<ul>
<li>NFS不提供加密功能. 在处理敏感数据时,请使用类似<a href="../en/Kerberos.html" title="Kerberos">Kerberos</a>或安全的<a href="../zh-CN/Category:Virtual_Private_Network.html" title="Category:Virtual Private Network (简体中文)">VPN</a>的协议传输NFS流量.</li>
<li>与<a href="../en/Samba.html" title="Samba">Samba</a>不同, NFS默认不提供任何验证用户的方法,客户端访问限制是通过IP地址和/或<a href="../en/Network_configuration.html#Set_the_hostname" class="mw-redirect" title="Hostname">hostname</a>实现的.</li>
<li>NFS期望<a href="../en/Users_and_groups.html" class="mw-redirect" title="User">user</a>和/或<a href="../en/Users_and_groups.html#Group_management" class="mw-redirect" title="User group">user group</a>的ID在客户端与服务端上是相同的.使用<a href="#%E5%90%AF%E7%94%A8NFSv4_ID%E6%98%A0%E5%B0%84">启用NFSv4 ID映射</a>,或使用<code>anonuid</code>/<code>anongid</code>并在<code>/etc/exports</code>中启用<code>all_squash</code>,手动改变UID/GID来解决这一问题.</li>
</ul>
</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%E5%AE%89%E8%A3%85"><span class="tocnumber">1</span> <span class="toctext">安装</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#%E9%85%8D%E7%BD%AE"><span class="tocnumber">2</span> <span class="toctext">配置</span></a>
<ul>
<li class="toclevel-2 tocsection-3">
<a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="tocnumber">2.1</span> <span class="toctext">服务端</span></a>
<ul>
<li class="toclevel-3 tocsection-4"><a href="#%E5%BC%80%E5%A7%8B%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1"><span class="tocnumber">2.1.1</span> <span class="toctext">开始运行服务</span></a></li>
<li class="toclevel-3 tocsection-5"><a href="#%E9%99%90%E5%88%B6NFS%E4%BD%BF%E5%85%B6%E5%8F%AA%E5%85%81%E8%AE%B8%E6%9D%A5%E8%87%AA%E7%89%B9%E5%AE%9A%E6%8E%A5%E5%8F%A3/IP%E5%9C%B0%E5%9D%80%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="tocnumber">2.1.2</span> <span class="toctext">限制NFS使其只允许来自特定接口/IP地址的访问</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE"><span class="tocnumber">2.1.3</span> <span class="toctext">防火墙配置</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#%E5%90%AF%E7%94%A8NFSv4_ID%E6%98%A0%E5%B0%84"><span class="tocnumber">2.1.4</span> <span class="toctext">启用NFSv4 ID映射</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8">
<a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="tocnumber">2.2</span> <span class="toctext">客户端</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BD"><span class="tocnumber">2.2.1</span> <span class="toctext">手动挂载</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#%E4%BD%BF%E7%94%A8/etc/fstab%E6%8C%82%E8%BD%BD"><span class="tocnumber">2.2.2</span> <span class="toctext">使用/etc/fstab挂载</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#Mount_using_/etc/fstab_with_systemd"><span class="tocnumber">2.2.3</span> <span class="toctext">Mount using /etc/fstab with systemd</span></a></li>
<li class="toclevel-3 tocsection-12">
<a href="#%E4%BD%9C%E4%B8%BAsystemd%E5%8D%95%E5%85%83"><span class="tocnumber">2.2.4</span> <span class="toctext">作为systemd单元</span></a>
<ul>
<li class="toclevel-4 tocsection-13"><a href="#%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD"><span class="tocnumber">2.2.4.1</span> <span class="toctext">自动挂载</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-14"><a href="#%E4%BD%BF%E7%94%A8autofs%E6%8C%82%E8%BD%BD"><span class="tocnumber">2.2.5</span> <span class="toctext">使用autofs挂载</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-15">
<a href="#%E6%8F%90%E7%A4%BA%E5%92%8C%E6%8A%80%E5%B7%A7"><span class="tocnumber">3</span> <span class="toctext">提示和技巧</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="tocnumber">3.1</span> <span class="toctext">性能调优</span></a></li>
<li class="toclevel-2 tocsection-17">
<a href="#%E5%A4%84%E7%90%86%E8%87%AA%E5%8A%A8%E6%8C%82%E8%BD%BD"><span class="tocnumber">3.2</span> <span class="toctext">处理自动挂载</span></a>
<ul>
<li class="toclevel-3 tocsection-18"><a href="#Cron"><span class="tocnumber">3.2.1</span> <span class="toctext">Cron</span></a></li>
<li class="toclevel-3 tocsection-19"><a href="#systemd/Timers"><span class="tocnumber">3.2.2</span> <span class="toctext">systemd/Timers</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#Using_a_NetworkManager_dispatcher"><span class="tocnumber">3.2.3</span> <span class="toctext">Using a NetworkManager dispatcher</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-21"><a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="tocnumber">4</span> <span class="toctext">故障排查</span></a></li>
<li class="toclevel-1 tocsection-22"><a href="#%E6%9B%B4%E5%A4%9A%E5%8F%82%E8%80%83"><span class="tocnumber">5</span> <span class="toctext">更多参考</span></a></li>
</ul>
</div>

<h2>
<span id=".E5.AE.89.E8.A3.85"></span><span class="mw-headline" id="安装">安装</span>
</h2>
<p>客户端和服务端都只需要<a href="../en/Pacman.html" title="Pacman">安装</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nfs-utils">nfs-utils</a></span> 包。
</p>
<p>强烈建议使用<a href="../zh-CN/System_time.html#%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5" title="System time (简体中文)">时间同步守护进程</a>以保持客户端/服务器之间的时间同步，如果各个节点上没有精确同步的时钟，NFS 可能产生非预期的延迟。
</p>
<h2>
<span id=".E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="配置">配置</span>
</h2>
<h3>
<span id=".E6.9C.8D.E5.8A.A1.E7.AB.AF"></span><span class="mw-headline" id="服务端">服务端</span>
</h3>
<p>全局设置选项在<code>/etc/nfs.conf</code>中被列出.只进行简单配置的用户无需编辑此文件.
</p>
<p>NFS服务器需要<code>/etc/exports</code>或<code>/etc/exports.d/*.exports</code>文件中定义的共享（“导出”）列表(详细介绍参见<span class="plainlinks archwiki-template-man" title="$ man 5 exports"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/exports.5">exports(5)</a></span>)。这些共享的对象是相对于所谓的"NFS根目录"的.出于安全考虑，建议定义一个单独的目录为NFS根,这可以将用户限制在该挂载点中. 绑定的挂载点(bind mounts)将<a href="../zh-CN/File_systems.html" title="File systems (简体中文)">文件系统</a>上他处的目录与被分享的挂载点连接起来.
</p>
<p>查看下面的例子.在本例中:
</p>
<ol>
<li>NFS 根目录是 <code>/srv/nfs</code>
</li>
<li>将要共享的目录是 <code>/mnt/music</code>,该目录被绑定挂载连接到了它实际的位置<code>/mnt/music</code>。</li>
</ol>
<pre># mkdir -p /srv/nfs/music /mnt/music
# mount --bind /mnt/music /srv/nfs/music
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> <a href="../en/ZFS.html" title="ZFS">ZFS</a> 文件系统对于 bindmounts 方式挂载要特殊处理，参阅 <a href="../en/ZFS.html#Bind_mount" title="ZFS">ZFS#Bind mount</a>。</div>
<p>为了让服务器重启后共享仍旧有效，增加绑定到 <code>fstab</code> 文件：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/mnt/music /srv/nfs/music  none   bind   0   0
</pre>
<p>增加允许被挂载的目录和使其只能被属于特定CIDR所指定的IP范围或拥有特定主机名的客户端所访问的限制至<code>/etc/exports</code>文件,例如：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/exports</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/srv/nfs        192.168.1.0/24(rw,sync,crossmnt,fsid=0)
/srv/nfs/music  192.168.1.0/24(rw,sync)
/srv/nfs/home   192.168.1.0/24(rw,sync,nohide)
/srv/nfs/public 192.168.1.0/24(ro,all_squash,insecure) desktop(rw,sync,all_squash,anonuid=99,anongid=99) # 将访客映射到特定用户组 - 在本例中是<i>nobody</i></pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>
<code>crossmnt</code> 选项使客户端可以访问<b>所有</b>挂载在文件系统上并标记有<code>crossmnt</code>的文件系统并且客户端不需要单独逐个挂载子共享. 请注意,你可能不希望在子共享同时被共享到另一端地址时使用该选项.</li>
<li>除了<code>crossmnt</code>之外,你也可以在子共享上使用<code>nohide</code>选项,这样的话,子共享就会在根共享被挂载时自动挂载.与<code>crossmnt</code>不同的是,<code>nohide</code>仍然会遵守子共享的地址范围.</li>
<li>使用一个通配符(*)以允许来自所有接口的访问.</li>
</ul>
</div>
<p>如果服务运行时修改了 <code>/etc/exports</code> 文件， 你需要重新导出使其生效:
</p>
<pre># exportfs -arv
</pre>
<p>想要查看已经加载的共享的详细信息,请使用:
</p>
<pre># exportfs -v
</pre>
<p>有关所有可用选项的详细介绍,请参阅<span class="plainlinks archwiki-template-man" title="$ man 5 exports"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/exports.5">exports(5)</a></span>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> <a rel="nofollow" class="external text" href="http://ip2cidr.com/">ip2cidr</a>是一个可以将IP范围转换为CIDR的工具.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 如果共享是<a href="../en/Tmpfs.html" title="Tmpfs">tmpfs</a>文件系统,你需要指定<code>fsid=1</code>选项.</div>
<h4>
<span id=".E5.BC.80.E5.A7.8B.E8.BF.90.E8.A1.8C.E6.9C.8D.E5.8A.A1"></span><span class="mw-headline" id="开始运行服务">开始运行服务</span>
</h4>
<p><a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" title="Systemd (简体中文)">启用并运行</a><code>nfs-server.service</code>
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>警告：</strong> NFS服务的前置服务(<code>rpc-gssd.service</code>)只有在<a href="../en/Random_number_generation.html" class="mw-redirect" title="Random number generator">随机数生成</a>池充分初始化后才会变得可用,这有可能会减缓启动速度.这个问题在无头服务器上特别常见.强烈建议使用类似于<a href="../en/Rng-tools.html" title="Rng-tools">Rng-tools</a>的工具来填充生成随机数所用的熵池(在你的设备支持<a href="../en/Trusted_Platform_Module.html" class="mw-redirect" title="TPM">TPM</a>的情况下),如果不支持TPM,可以使用<a href="../zh-CN/Haveged.html" title="Haveged (简体中文)">Haveged</a>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 在启用ZFS共享的同时,请也<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">启动</a>/<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">启用</a><code>zfs-share.service</code>.如果不这么做的话,在重启之后ZFS目录不会被共享.参阅<a href="../en/ZFS.html#NFS" title="ZFS">ZFS#NFS</a>.</div>
<h4>
<span id=".E9.99.90.E5.88.B6NFS.E4.BD.BF.E5.85.B6.E5.8F.AA.E5.85.81.E8.AE.B8.E6.9D.A5.E8.87.AA.E7.89.B9.E5.AE.9A.E6.8E.A5.E5.8F.A3.2FIP.E5.9C.B0.E5.9D.80.E7.9A.84.E8.AE.BF.E9.97.AE"></span><span class="mw-headline" id="限制NFS使其只允许来自特定接口/IP地址的访问">限制NFS使其只允许来自特定接口/IP地址的访问</span>
</h4>
<p>默认情况下,启动<code>nfs-server.service</code>会忽略<code>/etc/exports</code>文件的内容,而是在所有网络接口上监听连接.可以通过定义监听的IP和/或主机名来改变这一行为.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nfs.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[nfsd]
host=192.168.1.123
# 或者也可以使用主机名.
# host=myhostname</pre>
<p>在修改完后,<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" title="Systemd (简体中文)">重启</a><code>nfs-server.service</code>以应用设置.
</p>
<h4>
<span id=".E9.98.B2.E7.81.AB.E5.A2.99.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="防火墙配置">防火墙配置</span>
</h4>
<p>To enable access through a <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">firewall</a>, TCP and UDP ports <code>111</code>, <code>2049</code>, and <code>20048</code> may need to be opened when using the default configuration; use <code>rpcinfo -p</code> to examine the exact ports in use on the server:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ rpcinfo -p | grep nfs</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">100003    3   tcp   2049  nfs
100003    4   tcp   2049  nfs
100227    3   tcp   2049  nfs_acl
</pre>
<p>When using NFSv4, make sure TCP port <code>2049</code> is open. No other port opening should be required:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT</pre>
<p>When using an older NFS version, make sure other ports are open:
</p>
<pre># iptables -A INPUT -p tcp -m tcp --dport 111 -j ACCEPT
# iptables -A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT
# iptables -A INPUT -p tcp -m tcp --dport 20048 -j ACCEPT
# iptables -A INPUT -p udp -m udp --dport 111 -j ACCEPT
# iptables -A INPUT -p udp -m udp --dport 2049 -j ACCEPT
# iptables -A INPUT -p udp -m udp --dport 20048 -j ACCEPT
</pre>
<p>To have this configuration load on every system start, edit <code>/etc/iptables/iptables.rules</code> to include the following lines:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">-A INPUT -p tcp -m tcp --dport 111 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 2049 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 20048 -j ACCEPT
-A INPUT -p udp -m udp --dport 111 -j ACCEPT
-A INPUT -p udp -m udp --dport 2049 -j ACCEPT
-A INPUT -p udp -m udp --dport 20048 -j ACCEPT</pre>
<p>The previous commands can be saved by executing:
</p>
<pre># iptables-save &gt; /etc/iptables/iptables.rules
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This command will <b>override</b> the current iptables start configuration with the current iptables configuration!</div>
<p>If using NFSv3 and the above listed static ports for <code>rpc.statd</code> and <code>lockd</code> the following ports may also need to be added to the configuration:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">-A INPUT -p tcp -m tcp --dport 32765 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 32803 -j ACCEPT
-A INPUT -p udp -m udp --dport 32765 -j ACCEPT
-A INPUT -p udp -m udp --dport 32803 -j ACCEPT</pre>
<p>To apply changes, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> <code>iptables.service</code>.
</p>
<h4>
<span id=".E5.90.AF.E7.94.A8NFSv4_ID.E6.98.A0.E5.B0.84"></span><span class="mw-headline" id="启用NFSv4_ID映射">启用NFSv4 ID映射</span>
</h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Missing lookup information, static binding examples, etc. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:NFS_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:NFS (简体中文)#</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 
<ul>
<li>NFSv4 ID映射不适用于默认的<code>sec=sys</code>挂载选项.<a rel="nofollow" class="external autonumber" href="http://dfusion.com.au/wiki/tiki-index.php?page=Why+NFSv4+UID+mapping+breaks+with+AUTH_UNIX">[1]</a>
</li>
<li>在客户端和服务器上<b>均</b>需要启用NFSv4 ID映射</li>
<li>另一个选择是确保用户ID和组ID（UID和GID）在客户端和服务器上相同.</li>
<li>不需要<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" class="mw-redirect" title="启用">启用</a>/<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" class="mw-redirect" title="启动">启动</a><code>nfs-idmapd.service</code>,因为它已被新的id映射器替换:</li>
</ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># dmesg | grep id_resolver</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[ 3238.356001] NFS: Registering the id_resolver key type
[ 3238.356009] Key type id_resolver registered
</pre>
</div>
<p>NFSv4 协议将客户端的UID和GID值表示为<code>user@domain</code>形式的字符串.将UID和字符串互相转换的过程称为<i>ID映射</i>.<a rel="nofollow" class="external autonumber" href="http://man7.org/linux/man-pages/man5/nfsidmap.5.html">[2]</a>.
</p>
<p>即使idmapd可能正在运行，它也可能未被完全启用。如果<code>/sys/module/nfs/parameters/nfs4_disable_idmapping</code>/<code>/sys/module/nfsd/parameters/nfs4_disable_idmapping</code>在客户端或服务器上返回<code>Y</code>，请通过以下方式启用它： 
</p>
<p>客户端:
</p>
<pre># echo "N" | tee /sys/module/nfs/parameters/nfs4_disable_idmapping
</pre>
<p>服务器:
</p>
<pre># echo "N" | tee /sys/module/nfsd/parameters/nfs4_disable_idmapping
</pre>
<p>设置为<a href="../zh-CN/Kernel_module.html#%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97%E5%8F%82%E6%95%B0" title="Kernel module (简体中文)">内核模块参数</a>以使此更改永久生效，即：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modprobe.d/nfsd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">options nfs nfs4_disable_idmapping=0
options nfsd nfs4_disable_idmapping=0</pre>
<p>要完全使用<i>idmapping</i>，请确保在服务器和客户端的<code>/etc/idmapd.conf</code>文件中<b>都</b>配置了域：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/idmapd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># 以下应设置为本地NFSv4域名
# 默认为主机的DNS域名。
Domain = <i>domain.tld</i></pre>
<p>有关详细信息，请参见<a rel="nofollow" class="external autonumber" href="https://unix.stackexchange.com/a/464950">[3]</a>.
</p>
<p><br>
</p>
<h3>
<span id=".E5.AE.A2.E6.88.B7.E7.AB.AF"></span><span class="mw-headline" id="客户端">客户端</span>
</h3>
<p>打算将NFS4与<a href="../en/Kerberos.html" title="Kerberos">Kerberos</a>一起使用的用户需要<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" title="Systemd (简体中文)">启动</a>并<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" title="Systemd (简体中文)">启用</a><code>nfs-client.target</code>.
</p>
<h4>
<span id=".E6.89.8B.E5.8A.A8.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="手动挂载">手动挂载</span>
</h4>
<p>对于NFSv3，请使用以下命令显示服务器分享的文件系统： 
</p>
<pre>$ showmount -e servername
</pre>
<p>对于NFSv4，请挂载NFS根目录，并查看可用的挂载：
</p>
<pre># mount server:/ /mountpoint/on/client
</pre>
<p>然后挂载分享.挂载时省略服务器的NFS分享根目录：
</p>
<pre># mount -t nfs -o vers=4 servername:/music /mountpoint/on/client
</pre>
<p>如果挂载失败，请尝试包括服务器的分享根目录（对于Debian/RHEL/SLES是必需的，某些发行版需要使用<code>-t nfs4</code>而不是<code>-t nfs</code>）：
</p>
<pre># mount -t nfs -o vers=4 servername:/srv/nfs/music /mountpoint/on/client
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 服务器名称必须是有效的主机名（而不仅仅是IP地址）。否则，挂载远程共享将挂起。</div>
<h4>
<span id=".E4.BD.BF.E7.94.A8.2Fetc.2Ffstab.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="使用/etc/fstab挂载">使用/etc/fstab挂载</span>
</h4>
<p>Using <a href="../en/Fstab.html" title="Fstab">fstab</a> is useful for a server which is always on, and the NFS shares are available whenever the client boots up. Edit <code>/etc/fstab</code> file, and add an appropriate line reflecting the setup. Again, the server's NFS export root is omitted.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">servername:/music   /mountpoint/on/client   nfs   defaults,timeo=900,retrans=5,_netdev	0 0</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Consult <span class="plainlinks archwiki-template-man" title="$ man 5 nfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nfs.5">nfs(5)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 8 mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.8">mount(8)</a></span> for more mount options.</div>
<p>Some additional mount options to consider:
</p>
<dl>
<dt>rsize and wsize</dt>
<dd>The <code>rsize</code> value is the number of bytes used when reading from the server. The <code>wsize</code> value is the number of bytes used when writing to the server. By default, if these options are not specified, the client and server negotiate the largest values they can both support (see <span class="plainlinks archwiki-template-man" title="$ man 5 nfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nfs.5">nfs(5)</a></span> for details). After changing these values, it is recommended to test the performance (see <a href="#Performance_tuning">#Performance tuning</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>).</dd>
</dl>
<dl>
<dt>soft or hard</dt>
<dd>Determines the recovery behaviour of the NFS client after an NFS request times out. If neither option is specified (or if the <code>hard</code> option is specified), NFS requests are retried indefinitely. If the <code>soft</code> option is specified, then the NFS client fails a NFS request after <i>retrans</i> retransmissions have been sent, causing the NFS client to return an error to the calling application.</dd>
</dl>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> A so-called <code>soft</code> timeout can cause silent data corruption in certain cases. As such, use the <code>soft</code> option only when client responsiveness is more important than data integrity. Using NFS over TCP or increasing the value of the <code>retrans</code> option may mitigate some of the risks of using the <code>soft</code> option.</div>
<dl>
<dt>timeo</dt>
<dd>The <code>timeo</code> value is the amount of time, in tenths of a second, to wait before resending a transmission after an RPC timeout. The default value for NFS over TCP is 600 (60 seconds). After the first timeout, the timeout value is doubled for each retry for a maximum of 60 seconds or until a major timeout occurs. If connecting to a slow server or over a busy network, better stability can be achieved by increasing this timeout value.</dd>
</dl>
<dl>
<dt>retrans</dt>
<dd>The number of times the NFS client retries a request before it attempts further recovery action. If the <code>retrans</code> option is not specified, the NFS client tries each request three times. The NFS client generates a "server not responding" message after <i>retrans</i> retries, then attempts further recovery (depending on whether the hard mount option is in effect).</dd>
</dl>
<dl>
<dt>_netdev</dt>
<dd>The <code>_netdev</code> option tells the system to wait until the network is up before trying to mount the share - <a href="../en/Systemd.html" title="Systemd">systemd</a> assumes this for NFS.</dd>
</dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Setting the sixth field (<code>fs_passno</code>) to a nonzero value may lead to unexpected behaviour, e.g. hangs when the systemd automount waits for a check which will never happen.</div>
<h4>
<span id="Mount_using_.2Fetc.2Ffstab_with_systemd"></span><span class="mw-headline" id="Mount_using_/etc/fstab_with_systemd">Mount using /etc/fstab with systemd</span>
</h4>
<p>Another method is using the <a href="../en/Fstab.html#Remote_filesystem" title="Fstab">x-systemd.automount</a> option which mounts the filesystem upon access:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">servername:/home   <i>/mountpoint/on/client</i>  nfs  _netdev,noauto,x-systemd.automount,x-systemd.mount-timeout=10,timeo=14,x-systemd.idle-timeout=1min 0 0</pre>
<p>To make systemd aware of the changes to fstab, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Reload">reload</a> systemd and restart <code>remote-fs.target</code> <a rel="nofollow" class="external autonumber" href="https://bbs.archlinux.org/viewtopic.php?pid=1515377#p1515377">[4]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>The <code>noauto</code> mount option will not mount the NFS share until it is accessed: use <code>auto</code> for it to be available immediately. <br> If experiencing any issues with the mount failing due to the network not being up/available, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>NetworkManager-wait-online.service</code>. It will ensure that <code>network.target</code> has all the links available prior to being active.</li>
<li>The <code>users</code> mount option would allow user mounts, but be aware it implies further options as <code>noexec</code> for example.</li>
<li>The <code>x-systemd.idle-timeout=1min</code> option will unmount the NFS share automatically after 1 minute of non-use. Good for laptops which might suddenly disconnect from the network.</li>
<li>If shutdown/reboot holds too long because of NFS,  <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>NetworkManager-wait-online.service</code> to ensure that NetworkManager is not exited before the NFS volumes are unmounted. Also try to add the <code>x-systemd.requires=network-online.target</code> mount option if shutdown takes too long.</li>
<li>Using the <code>nocto</code> option may improve performance for read-only mounts, but should be used only if the data on the server changes only occasionally.</li>
</ul>
</div>
<h4>
<span id=".E4.BD.9C.E4.B8.BAsystemd.E5.8D.95.E5.85.83"></span><span class="mw-headline" id="作为systemd单元">作为systemd单元</span>
</h4>
<p>在<code>/etc/systemd/system</code>目录下创建一个新<code>.mount</code> 文件,例如<code>mnt-myshare.mount</code>.有关详细信息，请参见<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.mount.5">systemd.mount(5)</a></span>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 确保文件名与您要使用的挂载点相对应.例如,仅当要将共享挂载到<code>/mnt/myshare</code>时才能使用单元名称<code>mnt-myshare.mount</code>.否则可能会发生以下错误： <code>systemd[1]: mnt-myshare.mount: Where= setting does not match unit name. Refusing.</code>.</div>
<p><code>What=</code> 分享的路径
</p>
<p><code>Where=</code> 分享应当被挂载的路径
</p>
<p><code>Options=</code> 挂载分享的选项
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 
<ul>
<li>网络安装单元会自动获取对<i>remote-fs-pre.target</i>, <i>network.target</i> 和 <i>network-online.target</i>的<code>After</code>依赖,并获得对<i>remote-fs.target</i>的<code>Before</code>依赖,除非<code>nofail</code>挂载选项被设置.在后一种情况下,还会添加一个<code>Wants</code>单元。</li>
<li>
<a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>noauto</code> to <code>Options</code> preventing automatically mount during boot (unless it is pulled in by some other unit).</li>
<li>If you want to use a hostname for the server you want to share (instead of an IP address), add <code>nss-lookup.target</code> to <code>After</code> and <code>Wants</code>. This might avoid mount errors at boot time that do not arise when testing the unit.</li>
</ul>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/mnt-myshare.mount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Mount Share at boot

[Mount]
What=172.16.24.192:/mnt/myshare
Where=/mnt/myshare
Options=noatime
Type=nfs
TimeoutSec=30

[Install]
WantedBy=multi-user.target</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In case of an unreachable system, <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">append</a> <code>ForceUnmount=true</code> to <code>[Mount]</code>, allowing the share to be (force-)unmounted.</div>
<p>To use <code>mnt-myshare.mount</code>, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> the unit and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> it to run on system boot.
</p>
<h5>
<span id=".E8.87.AA.E5.8A.A8.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="自动挂载">自动挂载</span>
</h5>
<p>要想自动挂载一个分享,你可以使用下面的自动挂载单元:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/mnt-myshare.automount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Automount myshare

[Automount]
Where=/mnt/myshare

[Install]
WantedBy=multi-user.target</pre>
<p><a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Disable">Disable</a>/<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Stop">stop</a> the <code>mnt-myshare.mount</code> unit, and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a>/<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> <code>mnt-myshare.automount</code> to automount the share when the mount path is being accessed.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>TimeoutIdleSec</code> to enable auto unmount. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.automount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.automount.5">systemd.automount(5)</a></span> for details.</div>
<h4>
<span id=".E4.BD.BF.E7.94.A8autofs.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="使用autofs挂载">使用autofs挂载</span>
</h4>
<p>Using <a href="../en/Autofs.html" title="Autofs">autofs</a> is useful when multiple machines want to connect via NFS; they could both be clients as well as servers. The reason this method is preferable over the earlier one is that if the server is switched off, the client will not throw errors about being unable to find NFS shares. See <a href="../en/Autofs.html#NFS_network_mounts" title="Autofs">autofs#NFS network mounts</a> for details.
</p>
<h2>
<span id=".E6.8F.90.E7.A4.BA.E5.92.8C.E6.8A.80.E5.B7.A7"></span><span class="mw-headline" id="提示和技巧">提示和技巧</span>
</h2>
<h3>
<span id=".E6.80.A7.E8.83.BD.E8.B0.83.E4.BC.98"></span><span class="mw-headline" id="性能调优">性能调优</span>
</h3>
<p>When using NFS on a network with a significant number of clients one may increase the default NFS threads from <i>8</i> to <i>16</i> or even a higher, depending on the server/network requirements:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nfs.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[nfsd]
threads=16</pre>
<p>It may be necessary to tune the <code>rsize</code> and <code>wsize</code> mount options to meet the requirements of the network configuration.
</p>
<p>In recent linux kernels (&gt;2.6.18) the size of I/O operations allowed by the NFS server (default max block size) varies depending on RAM size, with a maximum of 1M (1048576 bytes), the max block size of the server will be used even if nfs clients requires bigger <code>rsize</code> and <code>wsize</code>. 	See <a rel="nofollow" class="external free" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/5/html/5.8_Technical_Notes/Known_Issues-kernel.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/5/html/5.8_Technical_Notes/Known_Issues-kernel.html</a>
It is possible to change the default max block size allowed by the server by writing to the <code>/proc/fs/nfsd/max_block_size</code> before starting <i>nfsd</i>. For example, the following command restores the previous default iosize of 32k:
</p>
<pre># echo 32768 &gt; /proc/fs/nfsd/max_block_size
</pre>
<p>To make the change permanent, create a <a href="../en/Systemd.html#Temporary_files" title="Systemd">systemd-tmpfile</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/nfsd-block-size.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">w /proc/fs/nfsd/max_block_size - - - - 32768
</pre>
<p>To mount with the increased <code>rsize</code> and <code>wsize</code> mount options:
</p>
<pre># mount -t nfs -o rsize=32768,wsize=32768,vers=4 servername:/srv/nfs/music /mountpoint/on/client
</pre>
<p>Furthermore, despite the violation of NFS protocol, setting <code>async</code> instead of <code>sync</code> or <code>sync,no_wdelay</code> may potentially achieve a significant performance gain especially on spinning disks. Configure exports with this option and then execute <code>exportfs -arv</code> to apply.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/exports</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/srv/nfs        192.168.1.0/24(rw,async,crossmnt,fsid=0)
/srv/nfs/music  192.168.1.0/24(rw,async)</pre>
<h3>
<span id=".E5.A4.84.E7.90.86.E8.87.AA.E5.8A.A8.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="处理自动挂载">处理自动挂载</span>
</h3>
<p>This trick is useful for NFS-shares on a <a href="../en/Network_configuration/Wireless.html" class="mw-redirect" title="Wireless">wireless</a> network and/or on a network that may be unreliable. If the NFS host becomes unreachable, the NFS share will be unmounted to hopefully prevent system hangs when using the <code>hard</code> mount option <a rel="nofollow" class="external autonumber" href="https://bbs.archlinux.org/viewtopic.php?pid=1260240#p1260240">[5]</a>.
</p>
<p>Make sure that the NFS mount points are correctly indicated in <a href="../en/Fstab.html" title="Fstab">fstab</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">lithium:/mnt/data           /mnt/data	        nfs noauto,noatime 0 0
lithium:/var/cache/pacman   /var/cache/pacman	nfs noauto,noatime 0 0</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Use hostnames in <a href="../en/Fstab.html" title="Fstab">fstab</a> for this to work, not IP addresses.</li>
<li>In order to mount NFS shares with non-root users the <code>users</code> option has to be added.</li>
<li>The <code>noauto</code> mount option tells <a href="../en/Systemd.html" title="Systemd">systemd</a> to not automatically <a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mount">mount</a> the shares at boot, otherwise this may causing the boot process to stall.</li>
</ul>
</div>
<p>Create the <code>auto_share</code> script that will be used by <a href="../en/Cron.html" title="Cron">cron</a> or <a href="../en/Systemd/Timers.html" title="Systemd/Timers">systemd/Timers</a> to use ICMP ping to check if the NFS host is reachable:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/auto_share</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

function net_umount {
  umount -l -f $1 &amp;&gt;/dev/null
}

function net_mount {
  mountpoint -q $1 || mount $1
}

NET_MOUNTS=$(sed -e '/^.*#/d' -e '/^.*:/!d' -e 's/\t/ /g' /etc/fstab | tr -s " ")$'\n'b

printf %s "$NET_MOUNTS" | while IFS= read -r line
do
  SERVER=$(echo $line | cut -f1 -d":")
  MOUNT_POINT=$(echo $line | cut -f2 -d" ")

  # Check if server already tested
  if [[ "${server_ok[@]}" =~ "${SERVER}" ]]; then
    # The server is up, make sure the share are mounted
    net_mount $MOUNT_POINT
  elif [[ "${server_notok[@]}" =~ "${SERVER}" ]]; then
    # The server could not be reached, unmount the share
    net_umount $MOUNT_POINT
  else
    # Check if the server is reachable
    ping -c 1 "${SERVER}" &amp;&gt;/dev/null

    if [ $? -ne 0 ]; then
      server_notok[${#server_notok[@]}]=$SERVER
      # The server could not be reached, unmount the share
      net_umount $MOUNT_POINT
    else
      server_ok[${#server_ok[@]}]=$SERVER
      # The server is up, make sure the share are mounted
      net_mount $MOUNT_POINT
    fi
  fi
done
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Test using a TCP probe instead of ICMP ping (default is tcp port 2049 in NFS4) then replace the line:
<pre># Check if the server is reachable
ping -c 1 "${SERVER}" &amp;&gt;/dev/null
</pre>
<p>with:
</p>
<pre># Check if the server is reachable
timeout 1 bash -c ": &lt; /dev/tcp/${SERVER}/2049"
</pre>
in the <code>auto_share</code> script above.</div>
<p>Make sure the script is <a href="../en/Help:Reading.html#Make_executable" class="mw-redirect" title="Executable">executable</a>:
</p>
<pre># chmod +x /usr/local/bin/auto_share
</pre>
<p>Next check configure the script to run every X, in the examples below this is every minute.
</p>
<h4><span class="mw-headline" id="Cron">Cron</span></h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># crontab -e</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">* * * * * /usr/local/bin/auto_share
</pre>
<h4>
<span id="systemd.2FTimers"></span><span class="mw-headline" id="systemd/Timers">systemd/Timers</span>
</h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/auto_share.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Automount NFS shares every minute

[Timer]
OnCalendar=*-*-* *:*:00

[Install]
WantedBy=timers.target</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/auto_share.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Automount NFS shares
After=syslog.target network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/auto_share

[Install]
WantedBy=multi-user.target</pre>
<p>Finally, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> <code>auto_share.timer</code>.
</p>
<h4><span class="mw-headline" id="Using_a_NetworkManager_dispatcher">Using a NetworkManager dispatcher</span></h4>
<p><a href="../en/NetworkManager.html#Network_services_with_NetworkManager_dispatcher" title="NetworkManager">NetworkManager</a> can also be configured to run a script on network status change.
</p>
<p>The easiest method for mount shares on network status change is to symlink the <code>auto_share</code> script:
</p>
<pre># ln -s /usr/local/bin/auto_share /etc/NetworkManager/dispatcher.d/30-nfs.sh
</pre>
<p>However, in that particular case unmounting will happen only after the network connection has already been disabled, which is unclean and may result in effects like freezing of KDE Plasma applets. 
</p>
<p>The following script safely unmounts the NFS shares before the relevant network connection is disabled by listening for the <code>pre-down</code> and <code>vpn-pre-down</code> events, make the script is <a href="../en/Help:Reading.html#Make_executable" class="mw-redirect" title="Executable">executable</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/dispatcher.d/30-nfs.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

# Find the connection UUID with "nmcli con show" in terminal.
# All NetworkManager connection types are supported: wireless, VPN, wired...
WANTED_CON_UUID="CHANGE-ME-NOW-9c7eff15-010a-4b1c-a786-9b4efa218ba9"

if [[ "$CONNECTION_UUID" == "$WANTED_CON_UUID" ]]; then
    
    # Script parameter $1: NetworkManager connection name, not used
    # Script parameter $2: dispatched event
    
    case "$2" in
        "up")
            mount -a -t nfs4,nfs 
            ;;
        "pre-down");&amp;
        "vpn-pre-down")
            umount -l -a -t nfs4,nfs -f &gt;/dev/null
            ;;
    esac
fi
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This script ignores mounts with the <code>noauto</code> option, remove this mount option or use <code>auto</code> to allow the dispatcher to manage these mounts.</div>
<p>在<code>/etc/NetworkManager/dispatcher.d/pre-down</code>中创建一个符号链接以捕获<code>pre-down</code>事件:
</p>
<pre># ln -s /etc/NetworkManager/dispatcher.d/30-nfs.sh /etc/NetworkManager/dispatcher.d/pre-down.d/30-nfs.sh
</pre>
<h2>
<span id=".E6.95.85.E9.9A.9C.E6.8E.92.E6.9F.A5"></span><span class="mw-headline" id="故障排查">故障排查</span>
</h2>
<p>There is a dedicated article <a href="../en/NFS/Troubleshooting.html" title="NFS/Troubleshooting">NFS/Troubleshooting</a>.
</p>
<h2>
<span id=".E6.9B.B4.E5.A4.9A.E5.8F.82.E8.80.83"></span><span class="mw-headline" id="更多参考">更多参考</span>
</h2>
<ul>
<li>See also <a href="../en/Avahi.html" title="Avahi">Avahi</a>, a Zeroconf implementation which allows automatic discovery of NFS shares.</li>
<li>HOWTO: <a href="../en/Diskless_system.html" class="mw-redirect" title="Diskless network boot NFS root">Diskless network boot NFS root</a>
</li>
<li>
<a rel="nofollow" class="external text" href="http://blogs.msdn.com/sfu/archive/2008/04/14/all-well-almost-about-client-for-nfs-configuration-and-performance.aspx">Microsoft Services for Unix NFS Client info</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-04 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="https://blogs.oracle.com/jag/entry/nfs_on_snow_leopard">NFS on Snow Leopard</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-04-01 ⓘ]</sup> (Dead Link =&gt; <a rel="nofollow" class="external text" href="https://web.archive.org/web/20151212160906/https://blogs.oracle.com/jag/entry/nfs_on_snow_leopard">Archive.org Mirror</a>)</li>
<li><a rel="nofollow" class="external free" href="http://chschneider.eu/linux/server/nfs.shtml">http://chschneider.eu/linux/server/nfs.shtml</a></li>
<li><a rel="nofollow" class="external text" href="https://www.slashroot.in/how-do-linux-nfs-performance-tuning-and-optimization">How to do Linux NFS Performance Tuning and Optimization</a></li>
<li><a rel="nofollow" class="external text" href="https://www.cyberciti.biz/faq/linux-unix-tuning-nfs-server-client-performance/">Linux: Tune NFS Performance</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../zh-CN/Category:File_systems.html" title="Category:File systems (简体中文)">File systems (简体中文)</a></li>
<li><a href="../zh-CN/Category:Network_sharing.html" title="Category:Network sharing (简体中文)">Network sharing (简体中文)</a></li>
<li><a href="../zh-CN/Category:Servers.html" title="Category:Servers (简体中文)">Servers (简体中文)</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../zh-CN/Category:Pages_or_sections_flagged_with_Template:Translateme.html" title="Category:Pages or sections flagged with Template:Translateme (简体中文)">Pages or sections flagged with Template:Translateme (简体中文)</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=NFS_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=629122">https://wiki.archlinux.org/index.php?title=NFS_(简体中文)&amp;oldid=629122</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 4 August 2020, at 08:27.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
