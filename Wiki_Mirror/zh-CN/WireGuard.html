<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>WireGuard (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-WireGuard_简体中文 rootpage-WireGuard_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">WireGuard (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a><b>本文或本节需要<a href="../zh-CN/ArchWiki:Contributing.html#%E7%BF%BB%E8%AF%91" title="ArchWiki:Contributing (简体中文)">翻译</a>。要贡献翻译，请访问<a href="../zh-CN/ArchWiki:Translation_Team.html" class="mw-redirect" title="ArchWiki Translation Team (简体中文)">简体中文翻译团队</a>。</b><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>附注：</b> <span style="color:red;">请使用模板的第一个参数进行更详细的指示。</span>（在 <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:WireGuard_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:WireGuard (简体中文)#</a> 中讨论）</div>
</div>
<p>From the <a rel="nofollow" class="external text" href="https://www.wireguard.com/">WireGuard</a> project homepage: 
</p>
<dl><dd>Wireguard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPSec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it plans to be cross-platform and widely deployable. It is currently under heavy development, but already it might be regarded as the most secure, easiest to use, and simplest VPN solution in the industry.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> <i>WireGuard has not undergone proper degrees of security auditing and the protocol is still subject to change.</i><a rel="nofollow" class="external autonumber" href="https://www.wireguard.com/#work-in-progress">[1]</a>
</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%E5%AE%89%E8%A3%85"><span class="tocnumber">1</span> <span class="toctext">安装</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#%E4%BD%BF%E7%94%A8"><span class="tocnumber">2</span> <span class="toctext">使用</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Peer_A_%E9%85%8D%E7%BD%AE"><span class="tocnumber">2.1</span> <span class="toctext">Peer A 配置</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Peer_B_%E9%85%8D%E7%BD%AE"><span class="tocnumber">2.2</span> <span class="toctext">Peer B 配置</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#%E5%9F%BA%E6%9C%AC%E6%A3%80%E6%9F%A5"><span class="tocnumber">2.3</span> <span class="toctext">基本检查</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="tocnumber">2.4</span> <span class="toctext">配置持久化</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#%E7%A4%BA%E4%BE%8B_peer_%E9%85%8D%E7%BD%AE"><span class="tocnumber">2.5</span> <span class="toctext">示例 peer 配置</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8">
<a href="#%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%AA_VPN_%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">3</span> <span class="toctext">配置一个 VPN 服务器</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">3.1</span> <span class="toctext">服务器</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF_(%E8%BD%AC%E5%8F%91%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F)"><span class="tocnumber">3.2</span> <span class="toctext">客户端 (转发所有流量)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11">
<a href="#Troubleshooting"><span class="tocnumber">4</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="#DKMS_module_not_available"><span class="tocnumber">4.1</span> <span class="toctext">DKMS module not available</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-13">
<a href="#Tips_and_tricks"><span class="tocnumber">5</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-14"><a href="#Store_private_keys_in_encrypted_form"><span class="tocnumber">5.1</span> <span class="toctext">Store private keys in encrypted form</span></a></li>
</ul>
</li>
</ul>
</div>

<h2>
<span id=".E5.AE.89.E8.A3.85"></span><span class="mw-headline" id="安装">安装</span>
</h2>
<ol>
<li>
<a href="../zh-CN/Help:Reading.html#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85" class="mw-redirect" title="安装">安装</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span> 包</li>
<li>对于版本小于 5.6 的 Linux 内核，需要额外安装合适的内核模块（当使用默认的 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> 包时不需要）：
<ul><li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-dkms">wireguard-dkms</a></span> 用于其他版本小于 5.6 的 DKMS 变体<a href="../en/Kernel.html" title="Kernel">内核</a>。</li></ul>
</li>
</ol>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> <a href="../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a> 和 <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> 都为 WireGuard 接口设置提供原生支持，它们只需要内核模块。</div>
<h2>
<span id=".E4.BD.BF.E7.94.A8"></span><span class="mw-headline" id="使用">使用</span>
</h2>
<p>在 peer 上生成公钥和私钥：
</p>
<pre>$ wg genkey | tee privatekey | wg pubkey &gt; publickey
</pre>
<p>下面的指令会演示如何以表中的配置建立一条两个 peer 之间的隧道
</p>
<table class="wikitable">
<tbody>
<tr>
<th>
</th>
<th>Peer A
</th>
<th>Peer B
</th>
</tr>
<tr>
<td>External IP address
</td>
<td>10.10.10.1/24
</td>
<td>10.10.10.2/24
</td>
</tr>
<tr>
<td>Internal IP address
</td>
<td>10.0.0.1/24
</td>
<td>10.0.0.2/24
</td>
</tr>
<tr>
<td>wireguard listening port
</td>
<td>UDP/4857
</td>
<td>UDP/3981
</td>
</tr>
</tbody>
</table>
<p>Peer 应当已经拥有外网地址。例如，peer A 应当能够通过 <code>ping 10.10.10.2</code> ping 通 peer B，反之亦然。内部地址是由下文 <code>ip</code> 命令创建的新地址，并且将在 WireGuard 网络中共享。IP地址中 <code>/24</code> 的含义详见 <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation" class="extiw" title="wikipedia:Classless Inter-Domain Routing">CIDR</a>
</p>
<h4>
<span id="Peer_A_.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="Peer_A_配置">Peer A 配置</span>
</h4>
<p>这个 peer 将监听 UDP 端口 48574，通过将 peer B 的公钥与其内部和外部 IP 地址关联，接受来自 peer B 的连接。
</p>
<pre># ip link add dev wg0 type wireguard
# ip link set dev wg0 mtu 1420
# ip addr add 10.0.0.1/24 dev wg0
# wg set wg0 listen-port 4857 private-key ./privatekey
# wg set wg0 peer [Peer B public key] persistent-keepalive 25 allowed-ips 10.0.0.2/32 endpoint 10.10.10.2:3981
# ip link set wg0 up
</pre>
<p><code>[Peer B public key]</code> 的格式应当如同 <code>EsnHH9m6RthHSs+sd9uM6eCHe/mMVFaRh93GYadDDnM=</code>。<code>allowed-ips</code> 是 peer A 能够向之发送流量的地址列表。<code>allowed-ips 0.0.0.0/0</code> 将允许向任意地址发送流量。
</p>
<h4>
<span id="Peer_B_.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="Peer_B_配置">Peer B 配置</span>
</h4>
<p>如同 Peer A，只不过 wireguard 守护监听 UDP 端口 39814 并且只接受 peer A 的连接
</p>
<pre># ip link add dev wg0 type wireguard
# ip link set dev wg0 mtu 1420
# ip addr add 10.0.0.2/24 dev wg0
# wg set wg0 listen-port 3981 private-key ./privatekey
# wg set wg0 peer [Peer A public key] persistent-keepalive 25 allowed-ips 10.0.0.1/32 endpoint 10.10.10.1:4857
# ip link set wg0 up
</pre>
<h4>
<span id=".E5.9F.BA.E6.9C.AC.E6.A3.80.E6.9F.A5"></span><span class="mw-headline" id="基本检查">基本检查</span>
</h4>
<p>不带任何参数使用 wg 命令可以快速查看当前的配置。
</p>
<p>例如，当 peer A 配置好之后，我们可以看见它的身份和与之关联的 peers。
</p>
<pre> peer-a$ wg
 interface: wg0
   public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
   private key: (hidden)
   listening port: 4857
 
 peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
   endpoint: 10.10.10.2:3981
   allowed ips: 10.0.0.2/32
</pre>
<p>此时我们可以 ping 通隧道的另一端：
</p>
<pre> peer-a$ ping 10.0.0.2
</pre>
<h4>
<span id=".E9.85.8D.E7.BD.AE.E6.8C.81.E4.B9.85.E5.8C.96"></span><span class="mw-headline" id="配置持久化">配置持久化</span>
</h4>
<p>配置可以通过 <code>showconf</code> 来保存
</p>
<pre># wg showconf wg0 &gt; /etc/wireguard/wg0.conf
# wg setconf wg0 /etc/wireguard/wg0.conf
</pre>
<h4>
<span id=".E7.A4.BA.E4.BE.8B_peer_.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="示例_peer_配置">示例 peer 配置</span>
</h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
PrivateKey = [CLIENT PRIVATE KEY]
MTU = 1420

[Peer]
PublicKey = [SERVER PUBLICKEY]
AllowedIPs = 10.0.0.0/24, 10.123.45.0/24, 1234:4567:89ab::/48
Endpoint = [SERVER ENDPOINT]:5182
PersistentKeepalive = 25</pre>
<h2>
<span id=".E9.85.8D.E7.BD.AE.E4.B8.80.E4.B8.AA_VPN_.E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="配置一个_VPN_服务器">配置一个 VPN 服务器</span>
</h2>
<p>WireGuard 自带一个快速创建和销毁 VPN 服务器的工具，<code>wg-quick</code>。注意这里使用的配置文件不是一个能被 <code>wg setconf</code> 有效的配置文件，并且你可能至少要把 <code>eth0</code> 改成你实际使用的。
</p>
<h4>
<span id=".E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="服务器">服务器</span>
</h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0server.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.1/24  # This is the virtual IP address, with the subnet mask we will use for the VPN
PostUp   = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
ListenPort = 5182
PrivateKey = [SERVER PRIVATE KEY]
MTU = 1420

[Peer]
PublicKey = [CLIENT PUBLIC KEY]
AllowedIPs = 10.0.0.2/32  # 这表示客户端只有一个 IP。</pre>
<p>要使 iptables 规则生效，启用 IPv4 转发：
</p>
<pre># sysctl net.ipv4.ip_forward=1
</pre>
<p>永久保留这项改变，向 <code>/etc/sysctl.d/99-sysctl.conf</code> 添加 <code>net.ipv4.ip_forward = 1</code>。
</p>
<p>使用 <code>wg-quick up wg0server</code> 启用 Interface，<code>wg-quick down wg0server</code> 用以关闭
</p>
<h4>
<span id=".E5.AE.A2.E6.88.B7.E7.AB.AF_.28.E8.BD.AC.E5.8F.91.E6.89.80.E6.9C.89.E6.B5.81.E9.87.8F.29"></span><span class="mw-headline" id="客户端_(转发所有流量)">客户端 (转发所有流量)</span>
</h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.2/24  # The client IP from wg0server.conf with the same subnet mask
PrivateKey = [CLIENT PRIVATE KEY]
DNS = 10.0.0.1
MTU = 1420

[Peer]
PublicKey = [SERVER PUBLICKEY]
AllowedIPs = 0.0.0.0/0, ::0/0
Endpoint = [SERVER ENDPOINT]:5182
PersistentKeepalive = 25</pre>
<p>使用 <code>wg-quick up wg0</code> 来启用 Interface, 使用 <code>wg-quick down wg0</code> 来关闭。
</p>
<p>使用 <code>systemctl enable wg-quick@wg0</code> 来自动启动。
</p>
<p>如果你使用 <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a>, 可能有必要启用 NetworkManager-wait-online.service <code>systemctl enable NetworkManager-wait-online.service</code>
</p>
<p>或者你使用的是 systemd-networkd, 启用 systemd-networkd-wait-online.service <code>systemctl enable systemd-networkd-wait-online.service</code>
</p>
<p>等待所有设备就绪再尝试 WireGuard 连接
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="DKMS_module_not_available">DKMS module not available</span></h3>
<p>If the following command does not list any module after you installed <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-dkms">wireguard-dkms</a></span>,
</p>
<pre>$ modprobe wireguard &amp;&amp; lsmod | grep wireguard
</pre>
<p>or if creating a new link returns
</p>
<pre># ip link add dev wg0 type wireguard
RTNETLINK answers: Operation not supported
</pre>
<p>you probably miss the linux headers.
</p>
<p>These headers are available in <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-headers">linux-headers</a></span>.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Store_private_keys_in_encrypted_form">Store private keys in encrypted form</span></h3>
<p>It may be desirable to store private keys in encrypted form, such as through use of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pass">pass</a></span>. Just replace the PrivateKey line under [Interface] in your config file with:
</p>
<pre> PostUp = wg set %i private-key &lt;(su user -c "export PASSWORD_STORE_DIR=/path/to/your/store/; pass WireGuard/private-keys/%i")
</pre>
<p>where user is your username. See the `wg-quick(8)` man page for more details.
</p>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../zh-CN/Category:Virtual_Private_Network.html" title="Category:Virtual Private Network (简体中文)">Virtual Private Network (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../zh-CN/Category:Pages_or_sections_flagged_with_Template:Translateme.html" title="Category:Pages or sections flagged with Template:Translateme (简体中文)">Pages or sections flagged with Template:Translateme (简体中文)</a></li></ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=WireGuard_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=658852">https://wiki.archlinux.org/index.php?title=WireGuard_(简体中文)&amp;oldid=658852</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 10 April 2021, at 18:51.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
