<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Internet sharing (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Internet_sharing_简体中文 rootpage-Internet_sharing_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Internet sharing (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="/title/Android_tethering" title="Android tethering">Android tethering</a></li>
<li><a href="/title/Software_access_point" title="Software access point">Software access point</a></li>
<li><a href="/title/Bridge_with_netctl" title="Bridge with netctl">Bridge with netctl</a></li>
<li><a href="/title/Ad-hoc_networking" title="Ad-hoc networking">Ad-hoc networking</a></li>
<li><a href="/title/Sharing_PPP_Connection" title="Sharing PPP Connection">Sharing PPP Connection</a></li>
<li><a href="/title/Simple_stateful_firewall" title="Simple stateful firewall">Simple stateful firewall</a></li>
<li><a href="/title/Router" title="Router">Router</a></li>
<li><a href="/title/USB_3G_Modem" class="mw-redirect" title="USB 3G Modem">USB 3G Modem</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻译状态：</strong>本文是 <a href="/title/Internet_sharing" title="Internet sharing">Internet sharing</a> 的<a href="/title/ArchWiki:Translation_Team_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="ArchWiki:Translation Team (简体中文)">翻译</a>。上次翻译日期：2017-06-28。如果英文版本有所<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Internet_sharing&amp;diff=0&amp;oldid=480589">更改</a>，则您可以帮助同步翻译。</div>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a><b>本文或本节需要<a href="/title/ArchWiki:Contributing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)#%E7%BF%BB%E8%AF%91" title="ArchWiki:Contributing (简体中文)">翻译</a>。要贡献翻译，请访问<a href="/title/ArchWiki_Translation_Team_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" class="mw-redirect" title="ArchWiki Translation Team (简体中文)">简体中文翻译团队</a>。</b><a href="/title/File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>附注：</b> 初创页面，尚未翻译（在 <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Internet_sharing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Internet sharing (简体中文)#</a> 中讨论）</div>
</div>
<p>这篇文章解释了如何从一台机器向其他机器分享网络连接。 
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%E4%BE%9D%E8%B5%96"><span class="tocnumber">1</span> <span class="toctext">依赖</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#%E9%85%8D%E7%BD%AE"><span class="tocnumber">2</span> <span class="toctext">配置</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#%E9%9D%99%E6%80%81IP%E5%9C%B0%E5%9D%80"><span class="tocnumber">2.1</span> <span class="toctext">静态IP地址</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#%E5%90%AF%E7%94%A8%E5%8C%85%E8%BD%AC%E5%8F%91"><span class="tocnumber">2.2</span> <span class="toctext">启用包转发</span></a></li>
<li class="toclevel-2 tocsection-5">
<a href="#Enable_NAT"><span class="tocnumber">2.3</span> <span class="toctext">Enable NAT</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#With_iptables"><span class="tocnumber">2.3.1</span> <span class="toctext">With iptables</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#With_nftables"><span class="tocnumber">2.3.2</span> <span class="toctext">With nftables</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8">
<a href="#%E7%BB%99%E5%AE%A2%E6%88%B7%E6%9C%BA%E5%88%86%E9%85%8DIP%E5%9C%B0%E5%9D%80"><span class="tocnumber">2.4</span> <span class="toctext">给客户机分配IP地址</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#Manually_adding_an_IP"><span class="tocnumber">2.4.1</span> <span class="toctext">Manually adding an IP</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Troubleshooting"><span class="tocnumber">3</span> <span class="toctext">Troubleshooting</span></a></li>
<li class="toclevel-1 tocsection-11"><a href="#See_also"><span class="tocnumber">4</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2>
<span id=".E4.BE.9D.E8.B5.96"></span><span class="mw-headline" id="依赖">依赖</span>
</h2>
<p>作为服务器的机器应该有一个额外的网络设备。这个网络设备需要一个<a href="https://en.wikipedia.org/wiki/data_link_layer" class="extiw" title="w:data link layer">数据链路层</a>来连接到将要获得网络访问的机器：
</p>
<ul>
<li>如果想给若干台机器分享网络连接，<a href="https://en.wikipedia.org/wiki/Network_switch" class="extiw" title="wikipedia:Network switch">switch</a>可以提供数据连接。</li>
<li>一个无线设备同样可以给若干台机器分享网络访问，参见<a href="/title/Software_access_point" title="Software access point">Software access point</a>。</li>
<li>如果只需分享网络给一台机器，一根<a href="https://en.wikipedia.org/wiki/Ethernet_crossover_cable" class="extiw" title="wikipedia:Ethernet crossover cable">交叉网线</a>就可以了。 如果两台电脑的网卡支持<a href="https://en.wikipedia.org/wiki/Medium_Dependent_Interface#Auto_MDI-X" class="extiw" title="w:Medium Dependent Interface">MDI-X</a>，交叉网线也不是必须的，一根普通直连网线也可以。 运行 <code>ethtool <i>interface</i> | grep MDI</code> 确认网卡是否支持MDI-X。</li>
</ul>
<h2>
<span id=".E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="配置">配置</span>
</h2>
<p>这个章节假定，连接到客户机的网络设备被命名为 <i><b>net0</b></i>而连接到互联网的网络设备被命名为<i><b>internet0</b></i>。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> 为了此事，你可以使用<a href="/title/Udev#Setting_static_device_names" title="Udev">Udev#Setting static device names</a>所述的方法重命名你的设备。</div>
<p>所有的配置都是在服务器计算机上完成的，除了最后一步<a href="#%E7%BB%99%E5%AE%A2%E6%88%B7%E6%9C%BA%E5%88%86%E9%85%8DIP%E5%9C%B0%E5%9D%80">#给客户机分配IP地址</a>.
</p>
<h3>
<span id=".E9.9D.99.E6.80.81IP.E5.9C.B0.E5.9D.80"></span><span class="mw-headline" id="静态IP地址">静态IP地址</span>
</h3>
<p>在服务器计算机上，给要连接到其他机器的网卡分配一个静态的IP地址。IP地址的前3个字节不能和其他网卡的一模一样，除非两个网卡都有一个严格大于/24的子网掩码。
</p>
<pre># ip link set up dev net0
# ip addr add 192.168.123.100/24 dev net0 # arbitrary address
</pre>
<p>为了使你的静态IP在启动时被分配，你可以使用<a href="/title/Network_manager" class="mw-redirect" title="Network manager">network manager</a>。
</p>
<h3>
<span id=".E5.90.AF.E7.94.A8.E5.8C.85.E8.BD.AC.E5.8F.91"></span><span class="mw-headline" id="启用包转发">启用包转发</span>
</h3>
<p>检查当前的包转发设置：
</p>
<pre># sysctl -a | grep forward
</pre>
<p>你将会注意到控制每个默认值，每个网卡的包转发的选项都是存在的，同时每个网卡的IPv4和IPv6选项都是分开的。
</p>
<p>输入这条命令以在运行时临时启用包转发：
</p>
<pre># sysctl net.ipv4.ip_forward=1
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> 要想选择性地为某一个具体的网卡提供包转发，使用<code>sysctl net.ipv4.conf.<i>interface_name</i>.forwarding=1</code>来代替。</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>警告：</strong> 如果系统使用了<a href="/title/Systemd-networkd" title="Systemd-networkd">systemd-networkd</a>来控制网卡，就不可能为单个网卡配置IPv4的设置，换言之，systemd的操作规则会将所有配置过的转发发送到一个全局（针对所有网卡）的IPv4的设置。建议的变通方法是使用防火墙在选中的网卡上禁止转发。参考<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.network"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.network.5">systemd.network(5)</a></span>手册页以获取更多信息。在之前的systemd发行版本220/221中引入的执行内核设置的<code>IPForward=kernel</code>已不再适用。<a rel="nofollow" class="external autonumber" href="https://github.com/poettering/systemd/commit/765afd5c4dbc71940d6dd6007ecc3eaa5a0b2aa1">[1]</a> <a rel="nofollow" class="external autonumber" href="https://github.com/systemd/systemd/blob/a2088fd025deb90839c909829e27eece40f7fce4/NEWS">[2]</a>
</div>
<p>编辑<code>/etc/sysctl.d/30-ipforward.conf</code>来使得之前的改变可以永久地应用于所有接口上：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/sysctl.d/30-ipforward.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">net.ipv4.ip_forward=1
net.ipv6.conf.default.forwarding=1
net.ipv6.conf.all.forwarding=1
</pre>
<p>这之后，仍然建议在重启之后再次检查，以确认转发已经按需求启用。
</p>
<h3><span class="mw-headline" id="Enable_NAT">Enable NAT</span></h3>
<h4><span class="mw-headline" id="With_iptables">With iptables</span></h4>
<p><a href="/title/Install" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=iptables">iptables</a></span> package. Use iptables to enable NAT:
</p>
<pre># iptables -t nat -A POSTROUTING -o internet0 -j MASQUERADE
# iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# iptables -A FORWARD -i net0 -o internet0 -j ACCEPT
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Of course, this also works with a mobile broadband connection (usually called ppp0 on routing PC).</div>
<p>Read the <a href="/title/Iptables" title="Iptables">iptables</a> article for more information (especially saving the rule and applying it automatically on boot). There is also an excellent guide on iptables <a href="/title/Simple_stateful_firewall" title="Simple stateful firewall">Simple stateful firewall</a>.
</p>
<h4><span class="mw-headline" id="With_nftables">With nftables</span></h4>
<p><a href="/title/Install" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nftables">nftables</a></span> package. To enable NAT with <a href="/title/Nftables" title="Nftables">nftables</a>, you will have to create the prerouting and postrouting chains in a new/exisiting table (you need both chains even if they're empty):
</p>
<pre># nft add table ip nat
# nft add chain ip nat prerouting { type nat hook prerouting priority 0 \; }
# nft add chain ip nat postrouting { type nat hook postrouting priority 100 \; }
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  If you want to use IPv6, you have to replace all occurences of <code>ip</code> with <code>ip6</code>.</div>
<p>After that, you have to masquerade the <code>net0</code> adresses for <code>internet0</code>:
</p>
<pre># nft add rule nat postrouting oifname internet0 masquerade
</pre>
<p>You may want to add some more firewall restrictions on the forwarding (assuming the filter table already exists, like configured in <a href="/title/Nftables#Simple_IPv4/IPv6_firewall" title="Nftables">Nftables#Simple IPv4/IPv6 firewall</a><sup>[<a href="/title/ArchWiki:Requests#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>):
</p>
<pre># nft add chain inet filter forward { type filter hook forward priority 0 \; policy drop}
# nft add rule filter forward ct state related,established accept
# nft add rule filter forward iifname net0 oifname internet0 accept
</pre>
<p>You can find more information on NAT in nftables in the <a rel="nofollow" class="external text" href="https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)">nftables Wiki</a>. If you want to make these changes permanent, follow the instructions on <a href="/title/Nftables" title="Nftables">nftables</a>
</p>
<h3>
<span id=".E7.BB.99.E5.AE.A2.E6.88.B7.E6.9C.BA.E5.88.86.E9.85.8DIP.E5.9C.B0.E5.9D.80"></span><span class="mw-headline" id="给客户机分配IP地址">给客户机分配IP地址</span>
</h3>
<p>If you are planning to regularly have several machines using the internet shared by this machine, then is a good idea to install a <a href="https://en.wikipedia.org/wiki/DHCP" class="extiw" title="wikipedia:DHCP">DHCP</a> server, such as <a href="/title/Dhcpd" title="Dhcpd">dhcpd</a> or <a href="/title/Dnsmasq" title="Dnsmasq">dnsmasq</a>. Then configure a DHCP client (e.g. <a href="/title/Dhcpcd" title="Dhcpcd">dhcpcd</a>) on every client PC.
</p>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a><b>This article or section needs language, wiki syntax or style improvements. See <a href="/title/Help:Style" title="Help:Style">Help:Style</a> for reference.</b><a href="/title/File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> This is not an iptables guide. Expanding the chain with <code>iptables -I</code> might skip other important rules; if you need to script an ON/OFF switch for this, use custom chain with a jump placed carefully in the INPUT chain. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Internet_sharing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Internet sharing (简体中文)#</a>)</div>
</div>
<p>Incoming connections to UDP port 67 has to be allowed for DHCP server. It also necessary to allow incoming connections to UDP/TCP port 53 for DNS requests.
</p>
<pre># iptables -I INPUT -p udp --dport 67 -i net0 -j ACCEPT
# iptables -I INPUT -p udp --dport 53 -s 192.168.123.0/24 -j ACCEPT
# iptables -I INPUT -p tcp --dport 53 -s 192.168.123.0/24 -j ACCEPT
</pre>
<p>If you are not planing to use this setup regularly, you can manually add an IP to each client instead.
</p>
<h4><span class="mw-headline" id="Manually_adding_an_IP">Manually adding an IP</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a><b>This article or section needs language, wiki syntax or style improvements. See <a href="/title/Help:Style" title="Help:Style">Help:Style</a> for reference.</b><a href="/title/File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Duplicates <a href="/title/Network_configuration#Static_IP_address" title="Network configuration">Network configuration#Static IP address</a>. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Internet_sharing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Internet sharing (简体中文)#</a>)</div>
</div>
<p>Instead of using DHCP, on each client PC, add an IP address and the default route:
</p>
<pre># ip addr add 192.168.123.201/24 dev eth0  # arbitrary address, first three blocks must match the address from above
# ip link set up dev eth0
# ip route add default via 192.168.123.100 dev eth0   # same address as in the beginning
</pre>
<p>Configure a DNS server for each client, see <a href="/title/Resolv.conf" class="mw-redirect" title="Resolv.conf">resolv.conf</a> for details.
</p>
<p>That's it. The client PC should now have Internet.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<p>If you are able to connect the two PCs but cannot send data (for example, if the client PC makes a DHCP request to the server PC, the server PC receives the request and offers an IP to the client, but the client does not accept it, timing out instead), check that you do not have other <a href="/title/Iptables" title="Iptables">Iptables</a> rules <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1093208">interfering</a>.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://xyne.archlinux.ca/notes/network/dhcp_with_dns.html">Xyne's guide and scripts for launching a subnet with DHCP and DNS</a></li>
<li>
<a href="/title/NetworkManager" title="NetworkManager">NetworkManager</a> can be configured for internet sharing if used.</li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="/title/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="/title/Category:Network_sharing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="Category:Network sharing (简体中文)">Network sharing (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="/title/Category:Pages_or_sections_flagged_with_Template:Translateme_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="Category:Pages or sections flagged with Template:Translateme (简体中文)">Pages or sections flagged with Template:Translateme (简体中文)</a></li>
<li><a href="/title/Category:Pages_with_broken_section_links" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="/title/Category:Pages_or_sections_flagged_with_Template:Style" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Internet_sharing_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=668906">https://wiki.archlinux.org/index.php?title=Internet_sharing_(简体中文)&amp;oldid=668906</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 8 May 2021, at 10:54.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="/title/ArchWiki:Privacy_policy" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="/title/ArchWiki:About" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="/title/ArchWiki:General_disclaimer" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
