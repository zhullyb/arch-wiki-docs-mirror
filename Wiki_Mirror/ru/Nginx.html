<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>nginx (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Nginx_Русский rootpage-Nginx_Русский skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">nginx (Русский)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p><span></span>
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Nginx.html" title="Nginx">nginx</a>. Дата последней синхронизации: 2015-07-29. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Nginx&amp;diff=0&amp;oldid=388788">изменения</a>.</div>
<p><b><a href="https://en.wikipedia.org/wiki/ru:nginx" class="extiw" title="wikipedia:ru:nginx">nginx</a></b> (произносится "э́нжин-э́кс" или "э́нжин-и́кс") — это свободный высокопроизводительный HTTP-сервер с открытым исходным кодом, а также обратный прокси и IMAP/POP3 прокси-сервер, написанный Игорем Сысоевым в 2005 году. Согласно <a rel="nofollow" class="external text" href="http://news.netcraft.com/archives/2015/04/20/april-2015-web-server-survey.html">April 2015 Web Server Survey</a>, nginx используется на 14,48% доменов всего мира, в то время как <a href="../ru/Apache_HTTP_Server.html" title="Apache HTTP Server (Русский)">Apache</a> используется примерно на 38,39% доменов. nginx получил широкое распространение благодаря своей стабильности, богатой функциональности, простой настройке и низкому потреблению ресурсов.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0"><span class="tocnumber">1</span> <span class="toctext">Установка</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA"><span class="tocnumber">2</span> <span class="toctext">Запуск</span></a></li>
<li class="toclevel-1 tocsection-3">
<a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0"><span class="tocnumber">3</span> <span class="toctext">Настройка</span></a>
<ul>
<li class="toclevel-2 tocsection-4">
<a href="#%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8"><span class="tocnumber">3.1</span> <span class="toctext">Основные настройки</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#%D0%9F%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D1%8B_%D0%B8_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F"><span class="tocnumber">3.1.1</span> <span class="toctext">Процессы и соединения</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%BF%D0%BE%D0%B4_%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D0%BC_%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%BC"><span class="tocnumber">3.1.2</span> <span class="toctext">Запуск под другим пользователем</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#%D0%91%D0%BB%D0%BE%D0%BA%D0%B8_server"><span class="tocnumber">3.1.3</span> <span class="toctext">Блоки server</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#TLS/SSL"><span class="tocnumber">3.1.4</span> <span class="toctext">TLS/SSL</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-9">
<a href="#FastCGI"><span class="tocnumber">3.2</span> <span class="toctext">FastCGI</span></a>
<ul>
<li class="toclevel-3 tocsection-10">
<a href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_PHP"><span class="tocnumber">3.2.1</span> <span class="toctext">Реализация PHP</span></a>
<ul>
<li class="toclevel-4 tocsection-11">
<a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_PHP"><span class="tocnumber">3.2.1.1</span> <span class="toctext">Настройка PHP</span></a>
<ul>
<li class="toclevel-5 tocsection-12"><a href="#MariaDB"><span class="tocnumber">3.2.1.1.1</span> <span class="toctext">MariaDB</span></a></li>
</ul>
</li>
<li class="toclevel-4 tocsection-13">
<a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_nginx"><span class="tocnumber">3.2.1.2</span> <span class="toctext">Настройка nginx</span></a>
<ul>
<li class="toclevel-5 tocsection-14"><a href="#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BA_%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D0%BE%D0%B9_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8"><span class="tocnumber">3.2.1.2.1</span> <span class="toctext">Добавление к основной конфигурации</span></a></li>
<li class="toclevel-5 tocsection-15"><a href="#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%B8%D0%BC%D0%B8_%D0%B1%D0%BB%D0%BE%D0%BA%D0%B0%D0%BC%D0%B8_(%D0%BE%D0%BF%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE)"><span class="tocnumber">3.2.1.2.2</span> <span class="toctext">Управление несколькими блоками (опционально)</span></a></li>
</ul>
</li>
<li class="toclevel-4 tocsection-16"><a href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8"><span class="tocnumber">3.2.1.3</span> <span class="toctext">Проверка конфигурации</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-17">
<a href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_CGI"><span class="tocnumber">3.2.2</span> <span class="toctext">Реализация CGI</span></a>
<ul>
<li class="toclevel-4 tocsection-18">
<a href="#fcgiwrap"><span class="tocnumber">3.2.2.1</span> <span class="toctext">fcgiwrap</span></a>
<ul>
<li class="toclevel-5 tocsection-19"><a href="#%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE_%D1%80%D0%B0%D0%B1%D0%BE%D1%87%D0%B8%D1%85_%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%B2"><span class="tocnumber">3.2.2.1.1</span> <span class="toctext">Несколько рабочих потоков</span></a></li>
</ul>
</li>
<li class="toclevel-4 tocsection-20"><a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_nginx_2"><span class="tocnumber">3.2.2.2</span> <span class="toctext">Настройка nginx</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-21">
<a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B2_chroot"><span class="tocnumber">4</span> <span class="toctext">Установка в chroot</span></a>
<ul>
<li class="toclevel-2 tocsection-22"><a href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D0%BE%D0%B4%D0%B8%D0%BC%D1%8B%D1%85_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2"><span class="tocnumber">4.1</span> <span class="toctext">Создание необходимых устройств</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D0%BE%D0%B4%D0%B8%D0%BC%D1%8B%D1%85_%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2"><span class="tocnumber">4.2</span> <span class="toctext">Создание необходимых каталогов</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#%D0%97%D0%B0%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_chroot"><span class="tocnumber">4.3</span> <span class="toctext">Заполнение chroot</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="#%D0%9E%D1%82%D1%80%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D1%83%D0%B9%D1%82%D0%B5_nginx.service_%D0%B4%D0%BB%D1%8F_%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0_chroot"><span class="tocnumber">4.4</span> <span class="toctext">Отредактируйте nginx.service для запуска chroot</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-26">
<a href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC"><span class="tocnumber">5</span> <span class="toctext">Решение проблем</span></a>
<ul>
<li class="toclevel-2 tocsection-27"><a href="#%D0%92%D0%B0%D0%BB%D0%B8%D0%B4%D0%B0%D1%86%D0%B8%D1%8F_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8"><span class="tocnumber">5.1</span> <span class="toctext">Валидация конфигурации</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#%D0%9F%D1%80%D0%B8_%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B5_%D1%81_%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE_IP_%D0%BF%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D1%82%D1%81%D1%8F_%D0%BD%D0%B0_localhost"><span class="tocnumber">5.2</span> <span class="toctext">При доступе с локального IP перенаправляется на localhost</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0,_%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%83%D1%8E_%D0%B2%D1%8B_%D0%B8%D1%89%D0%B8%D1%82%D0%B5,_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE_%D0%BD%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%B0._%D0%9F%D0%BE%D0%B6%D0%B0%D0%BB%D1%83%D0%B9%D1%81%D1%82%D0%B0,_%D0%BF%D0%BE%D0%BF%D1%80%D0%BE%D0%B1%D1%83%D0%B9%D1%82%D0%B5_%D0%BF%D0%BE%D0%B7%D0%B6%D0%B5._(502_Bad_Gateway)"><span class="tocnumber">5.3</span> <span class="toctext">Ошибка: Страница, которую вы ищите, временно недоступна. Пожалуйста, попробуйте позже. (502 Bad Gateway)</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_No_input_file_specified"><span class="tocnumber">5.4</span> <span class="toctext">Ошибка: No input file specified</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_%22File_not_found%22_%D0%B2_%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D0%B5_%D0%B8%D0%BB%D0%B8_%22Primary_script_unknown%22_%D0%B2_%D0%BB%D0%BE%D0%B3-%D1%84%D0%B0%D0%B9%D0%BB%D0%B5"><span class="tocnumber">5.5</span> <span class="toctext">Ошибка: "File not found" в браузере или "Primary script unknown" в лог-файле</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_chroot:_'/usr/sbin/nginx'_No_such_file_or_directory"><span class="tocnumber">5.6</span> <span class="toctext">Ошибка: chroot: '/usr/sbin/nginx' No such file or directory</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#%D0%90%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D0%B9_%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82_%D0%B4%D0%BB%D1%8F_systemd"><span class="tocnumber">5.7</span> <span class="toctext">Альтернативный скрипт для systemd</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-34"><a href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5"><span class="tocnumber">6</span> <span class="toctext">Смотрите также</span></a></li>
</ul>
</div>

<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span>.
</p>
<p>Для установки Ruby on Rails с nginx смотрите раздел <a href="../en/Ruby_on_Rails.html#The_Perfect_Rails_Setup" title="Ruby on Rails">Ruby on Rails#The Perfect Rails Setup</a>.
</p>
<p>Если для обеспечения дополнительной безопасности вы хотите установить nginx в chroot-окружении, смотрите раздел <a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B2_chroot">#Установка в chroot</a>.
</p>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA"></span><span class="mw-headline" id="Запуск">Запуск</span>
</h2>
<p>Запустите/включите <code>nginx.service</code> <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" title="Systemd (Русский)">используя systemd</a>.
</p>
<p>Страница по умолчанию, доступная по адресу <a rel="nofollow" class="external free" href="http://127.0.0.1">http://127.0.0.1</a> располагается в <code>/usr/share/nginx/html/index.html</code>.
</p>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0"></span><span class="mw-headline" id="Настройка">Настройка</span>
</h2>
<p>Первые шаги по настройке и использованию nginx описаны в руководстве <a rel="nofollow" class="external text" href="http://nginx.org/ru/docs/beginners_guide.html">Beginner’s Guide</a>. Вы можете настроить сервер, редактируя файлы в <code>/etc/nginx/</code>; главный файл настроек расположен в <code>/etc/nginx/nginx.conf</code>.
</p>
<p>Более подробную информацию можно прочитать на странице <a rel="nofollow" class="external text" href="http://wiki.nginx.org/Configuration">Nginx Configuration Examples</a> и в <a rel="nofollow" class="external text" href="http://nginx.org/ru/docs/">официальной документации</a>.
</p>
<p>Приведенные далее примеры покрывают большинство типичных потребностей. Предполагается, что вы используете стандартное место расположения веб-документов (<code>/usr/share/nginx/html</code>). Если это не так, замените путь на свой.
</p>
<h3>
<span id=".D0.9E.D1.81.D0.BD.D0.BE.D0.B2.D0.BD.D1.8B.D0.B5_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B8"></span><span class="mw-headline" id="Основные_настройки">Основные настройки</span>
</h3>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.86.D0.B5.D1.81.D1.81.D1.8B_.D0.B8_.D1.81.D0.BE.D0.B5.D0.B4.D0.B8.D0.BD.D0.B5.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Процессы_и_соединения">Процессы и соединения</span>
</h4>
<p>Вы должны выбрать подходящее значение для <code>worker_processes</code>. Этот параметр определяет сколько одновременных соединений сможет принимать nginx и сколько процессоров он сможет при этом использовать. Как правило, это значение устанавливают равным количеству аппаратных потоков в системе. Однако, начиная с версий 1.3.8 и 1.2.5, в качестве значения <code>worker_processes</code> вы также можете задать <code>auto</code>, при этом nginx попытается автоматически подобрать оптимальное значение (<a rel="nofollow" class="external text" href="http://nginx.org/ru/docs/ngx_core_module.html#worker_processes">источник</a>).
</p>
<p>Максимальное количество одновременных соединений, которое nginx сможет принимать, вычисляется как <code>max_clients = worker_processes * worker_connections</code>.
</p>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.BF.D0.BE.D0.B4_.D0.B4.D1.80.D1.83.D0.B3.D0.B8.D0.BC_.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D1.82.D0.B5.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Запуск_под_другим_пользователем">Запуск под другим пользователем</span>
</h4>
<p>По умолчанию nginx выполняется от имени пользователя <i>nobody</i>. Чтобы запустить его от имени другого пользователя, измените строку <code>user</code> в <code>nginx.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user <i>пользователь</i> <i>группа</i>; # например http
</pre>
<p>Теперь Nginx должен работать от указанного имени пользователя <i>пользователь</i> и группы <i>группа</i>. Если используется группа, имя которой совпадает с именем пользователя, то ее название можно опустить.
</p>
<h4>
<span id=".D0.91.D0.BB.D0.BE.D0.BA.D0.B8_server"></span><span class="mw-headline" id="Блоки_server">Блоки server</span>
</h4>
<p>Посредством добавления блоков <code>server</code> в файл настроек возможно обслуживать сразу несколько доменов одновременно. Эти блоки работают аналогично "VirtualHosts" в <a href="../ru/Apache_HTTP_Server.html" title="Apache HTTP Server (Русский)">Apache</a>.
</p>
<p>В этом примере сервер принимает запросы для двух доменов: <code>domainname1.dom</code> и <code>domainname2.dom</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server {
        listen 80;
        server_name domainname1.dom;
        root /usr/share/nginx/domainname1.dom/html;
        ...
}

server {
        listen 80;
        server_name domainname2.dom;
        listen 443 ssl; # также прослушивать по HTTPS
        root /usr/share/nginx/domainname2.dom/html;
        ...
}
...
</pre>
<p><a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx</code>, чтобы изменения вступили в силу.
</p>
<p>Следует настроить DNS-сервер, например <a href="../en/BIND.html" title="BIND">BIND</a> или <a href="../en/Dnsmasq.html" title="Dnsmasq">dnsmasq</a>, чтобы у подключающихся клиентов эти доменные имена разрешались в IP-адрес сервера.
</p>
<p>А пока вы можете просто добавить их в ваш файл <code>/etc/hosts</code>, заменив <code>192.168.0.101</code> на фактический IP-адрес сервера:
</p>
<pre>192.168.0.101 domainname1.dom
192.168.0.101 domainname2.dom
</pre>
<h4>
<span id="TLS.2FSSL"></span><span class="mw-headline" id="TLS/SSL">TLS/SSL</span>
</h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssl">openssl</a></span> предоставляет поддержку TLS/SSL и установлен по умолчанию на установленных Arch.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Перед тем как настраивать SSL, вы можете почитать документацию <a rel="nofollow" class="external text" href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate">ngx_http_ssl_module</a>
</div>
<p>Создайте секретный ключ и самоподписанный сертификат. Это подходит для большинства случаев, в которых не требуется  <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" class="extiw" title="wikipedia:Certificate signing request">CSR</a>:
</p>
<pre># cd /etc/nginx/
# openssl req -new -x509 -nodes -newkey rsa:4096 -keyout nginx.key -out nginx.crt -days 1095
# chmod 400 nginx.key
# chmod 444 nginx.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong>  Опция -days является необязательной, а RSA keysize можно уменьшить до 2048 (по умолчанию).</div>
<p>Если же вам нужно создать <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" class="extiw" title="wikipedia:Certificate signing request">CSR</a>, то следуйте данным инструкциям по созданию ключа, вместо приведённых выше:
</p>
<pre># openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out nginx.key
# chmod 400 nginx.key
# openssl req -new -sha256 -key nginx.key -out nginx.csr
# openssl x509 -req -days 1095 -in nginx.csr -signkey nginx.key -out nginx.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong>  Для дополнительных опций openssl, прочтите <a rel="nofollow" class="external text" href="https://www.openssl.org/docs/apps/openssl.html">man страницу</a> или изучите <a rel="nofollow" class="external text" href="https://www.openssl.org/docs/">подробную документацию</a> по openssl.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Если вы планируете развернуть SSL/TLS, вы должны знать, что некоторые вариации и реализации <a rel="nofollow" class="external text" href="https://weakdh.org/#affected">всё ещё</a> <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Attacks_against_TLS.2FSSL" class="extiw" title="wikipedia:Transport Layer Security">подвержены атакам</a>. За дополнительной информацией о текущих подверженных версиях этих реализаций  SSL/TLS и как применить нужные настройки к nginx посетите <a rel="nofollow" class="external free" href="http://disablessl3.com/">http://disablessl3.com/</a> и <a rel="nofollow" class="external free" href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a>
</div>
<p>Пример <code>nginx.conf</code>, использующего SSL:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http {
        ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8 8.8.4.4 valid=300s; # Google DNS Servers
        resolver_timeout 5s;
}

server {
        #listen 80; # Раскомментируйте, чтобы также слушать HTTP запросы
        listen 443 ssl;
        server_name localhost;

        ssl_certificate nginx.crt;
        ssl_certificate_key nginx.key;

	root /usr/share/nginx/html;
        location / {
            index  index.html index.htm index.php;
        }
}</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> У Mozilla есть полезная <a rel="nofollow" class="external text" href="https://wiki.mozilla.org/Security/Server_Side_TLS">SSL/TLS статья</a>, которая описывает рекомендации по настройке <a rel="nofollow" class="external text" href="https://wiki.mozilla.org/Security/Server_Side_TLS#Nginx">специально для nginx</a>, а также <a rel="nofollow" class="external text" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">автоматизированный инструмент</a>, который поможет вам создать более безопасную конфигурацию.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> <a rel="nofollow" class="external text" href="https://cipherli.st">Cipherli.st</a><sup>[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">устаревшая ссылка</a> 2020-08-04]</sup> показывает примеры надёжных настроек SSL и инструкции для наиболее современных веб серверов.</div>
<p><a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx</code>, чтобы изменения вступили в силу.
</p>
<h3><span class="mw-headline" id="FastCGI">FastCGI</span></h3>
<p>FastCGI или просто FCGI — это протокол, являющийся интерфейсом между веб-сервером и интерактивными программами. Это модифицированный CGI (<i>Common Gateway Interface</i>), главная цель которого — снизить накладные расходы, связанные со взаимодействием веб сервера и CGI программ, тем самым позволяя серверу обрабатывать большее количество запросов одновременно.
</p>
<p>Технология FastCGI встроена в nginx для работы со многими внешними инструментами, например, Perl, <a href="../en/PHP.html" title="PHP">PHP</a> и <a href="../ru/Python.html" title="Python (Русский)">Python</a>.
</p>
<h4>
<span id=".D0.A0.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D1.8F_PHP"></span><span class="mw-headline" id="Реализация_PHP">Реализация PHP</span>
</h4>
<p>В качестве FastCGI-сервера для PHP рекомендуется использовать <a rel="nofollow" class="external text" href="http://php-fpm.org/">PHP-FPM</a>.
</p>
<h5>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_PHP"></span><span class="mw-headline" id="Настройка_PHP">Настройка PHP</span>
</h5>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакеты <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php">php</a></span> и <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-fpm">php-fpm</a></span>.
</p>
<p>Опция <code>open_basedir</code> в <code>/etc/php/php.ini</code> должна содержать список всех каталогов, с файлами PHP, которые должны быть доступны серверу. Например, для <code>/usr/share/nginx/html/</code> и <code>/usr/share/webapps/</code>:
</p>
<pre>open_basedir = /usr/share/webapps/:/srv/http/:/usr/share/nginx/html/:/home/:/tmp/:/usr/share/pear/
</pre>
<p>После этого настройте нужные вам модули. Например, для использования sqlite3 нужно установить <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-sqlite">php-sqlite</a></span>. Затем включите этот модуль в файле <code>/etc/php/php.ini</code>, раскомментировав следующую строку:
</p>
<pre>extension=sqlite3.so
</pre>
<p>Основным конфигурационным файлом PHP-FPM является <code>/etc/php/php-fpm.conf</code>. <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Включите">Включите</a> и <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Запустите">запустите</a> <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a> службу <code>php-fpm</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вы запускаете nginx в изолированном окружении (к примеру, chroot находится в <code>/srv/nginx-jail</code>, веб-документы расположены в <code>/srv/nginx-jail/www</code>), то вы должны в <code>/etc/php/php-fpm.conf</code> добавить опции <code>chroot /srv/nginx-jail</code> и <code>listen = /srv/nginx-jail/run/php-fpm/php-fpm.sock</code> внутри секции пула (по умолчанию это <code>[www]</code>). Создайте каталог для файла сокета, если его нет.</div>
<h6><span class="mw-headline" id="MariaDB">MariaDB</span></h6>
<p>Настройте MySQL/MariaDB как описано в <a href="../en/MariaDB.html" title="MariaDB">MariaDB</a>.
</p>
<p>Раскомментируйте <a rel="nofollow" class="external text" href="http://www.php.net/manual/en/mysqlinfo.api.choosing.php">хотя бы одну</a> из следующих строк в <code>/etc/php/php.ini</code>:
</p>
<pre>extension=pdo_mysql.so
extension=mysqli.so
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Начиная с PHP 5.5, <code>mysql.so</code> объявлен <a rel="nofollow" class="external text" href="http://www.php.net/manual/de/migration55.deprecated.php">устаревшим</a>, ваши лог файлы будут переполнены.</div>
<p>Вы можете добавить менее привилегированных MySQL пользователей для ваших веб скриптов. Вы можете также захотеть отредактировать <code>/etc/mysql/my.cnf</code> и раскомментировать строку <code>skip-networking</code>, чтобы MySQL сервер был доступен только из localhost. Вы должны перезапустить MySQL, чтобы изменения вступили в силу.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Вы можете захотеть установить инструменты вроде <a href="../en/PhpMyAdmin.html" title="PhpMyAdmin">phpMyAdmin</a>, <a href="../en/Adminer.html" title="Adminer">Adminer</a> или <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mysql-workbench">mysql-workbench</a></span>, чтобы работать с вашими базами данных.</div>
<h5>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_nginx"></span><span class="mw-headline" id="Настройка_nginx">Настройка nginx</span>
</h5>
<h6>
<span id=".D0.94.D0.BE.D0.B1.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA_.D0.BE.D1.81.D0.BD.D0.BE.D0.B2.D0.BD.D0.BE.D0.B9_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Добавление_к_основной_конфигурации">Добавление к основной конфигурации</span>
</h6>
<p>Внутри каждого блока <code>server</code>, который обслуживает веб-приложение PHP должен находиться блок <code>location</code>:
</p>
<pre>location ~ \.php$ {
     fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
     fastcgi_index  index.php;
     include        fastcgi.conf;
}
</pre>
<p>Если требуется обрабатывать другие расширения наряду с PHP (например <i>.html</i> и <i>.htm</i>):
</p>
<pre>location ~ \.(php<b>|html|htm</b>)$ {
     fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
     fastcgi_index  index.php;
     include        fastcgi.conf;
}
</pre>
<p>Все расширения, обрабатываемые в php-fpm должны быть также явно добавлены в
<code>/etc/php/php-fpm.conf</code>:
</p>
<pre>security.limit_extensions = .php .html .htm
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Аргумент <code>fastcgi_pass</code> должен быть определен как TCP-сокет или сокет Unix выбранным FastCGI сервером в его конфигурационном файле. <b>По умолчанию</b> для <code>php-fpm</code> используется сокет
<pre>fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
</pre>
<p>Вы можете использовать также общий TCP-сокет:
</p>
<pre>fastcgi_pass 127.0.0.1:9000;
</pre>
Однако, доменные сокеты Unix должны работать быстрее.</div>
<p>Пример, показанный ниже, является копией рабочей конфигурации. Заметьте, что в этом примере путь к <code>root</code> определен непосредственно в <code>server</code>, а не внутри <code>location</code> (как это сделано в конфигурации по умолчанию).
</p>
<pre>server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    location / {
        index index.html index.htm index.php;
    }

    location ~ \.php$ {
        #fastcgi_pass 127.0.0.1:9000; (depending on your php-fpm socket configuration)
        fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi.conf;
    }
}
</pre>
<h6>
<span id=".D0.A3.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D1.81.D0.BA.D0.BE.D0.BB.D1.8C.D0.BA.D0.B8.D0.BC.D0.B8_.D0.B1.D0.BB.D0.BE.D0.BA.D0.B0.D0.BC.D0.B8_.28.D0.BE.D0.BF.D1.86.D0.B8.D0.BE.D0.BD.D0.B0.D0.BB.D1.8C.D0.BD.D0.BE.29"></span><span class="mw-headline" id="Управление_несколькими_блоками_(опционально)">Управление несколькими блоками (опционально)</span>
</h6>
<p>Если вы добавляете однотипную конфигурацию для PHP сразу во множество блоков <code>server</code>, может оказаться удобнее использовать для этого внешний файл:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/php.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">location ~ \.php$ {
        fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi.conf;
}
</pre>
<p>Теперь включите файл <code>php.conf</code> в каждый из блоков <code>server</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> server = {
     ...
     include php.conf;
 }
</pre>
<h5>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Проверка_конфигурации">Проверка конфигурации</span>
</h5>
<p><a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Перезапустите">Перезапустите</a> службы <code>php-fpm</code> и <code>nginx</code> после изменения настроек, чтобы изменения вступили в силу.
</p>
<p>Чтобы проверить работу FastCGI, создайте новый файл <i>.php</i> внутри каталога веб-документов, содержащий:
</p>
<pre>&lt;?php
  phpinfo();
?&gt;
</pre>
<p>При открытии файла в браузере должна отобразиться информационная страница с текущими настройками PHP.
</p>
<p>Смотрите <a href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC">#Решение проблем</a>, если новая конфигурация не работает.
</p>
<h4>
<span id=".D0.A0.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D1.8F_CGI"></span><span class="mw-headline" id="Реализация_CGI">Реализация CGI</span>
</h4>
<p>Эта реализация нужна для CGI-приложений.
</p>
<h5><span class="mw-headline" id="fcgiwrap">fcgiwrap</span></h5>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=fcgiwrap">fcgiwrap</a></span>. Файл настроек находится в <code>/usr/lib/systemd/system/fcgiwrap.socket</code>. <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Включите">Включите</a> и <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Запустите">запустите</a> <code>fcgiwrap.socket</code>.
</p>
<h6>
<span id=".D0.9D.D0.B5.D1.81.D0.BA.D0.BE.D0.BB.D1.8C.D0.BA.D0.BE_.D1.80.D0.B0.D0.B1.D0.BE.D1.87.D0.B8.D1.85_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.B2"></span><span class="mw-headline" id="Несколько_рабочих_потоков">Несколько рабочих потоков</span>
</h6>
<p>Если вы хотите породить несколько рабочих потоков, вам рекомендуется использовать <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>, который умеет отслеживать упавшие подпроцессы и перезапускать их. Вам нужно использовать <code>spawn-fcgi</code>, чтобы создать доменный сокет Unix, так как multiwatch не может обрабатывать сокеты, созданные <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a>, однако, <i>fcgiwrap</i> сама по себе не вызывает никаких проблем, если вызывается непосредственно из юнит-файла.
</p>
<p>Скопируйте юнит-файл из <code>/usr/lib/systemd/system/fcgiwrap.service</code> в <code>/etc/systemd/system/fcgiwrap.service</code> (и юнит <code>fcgiwrap.socket</code>, если он есть), и отредактируйте строку <code>ExecStart</code> в соответствии с вашими нуждами. В примере показан юнит файл, который использует <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>. Убедитесь, что <code>fcgiwrap.socket</code> не включен и не запущен, потому что он будет конфликтовать с этим юнитом:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/fcgiwrap.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Simple CGI Server
After=nss-user-lookup.target

[Service]
ExecStartPre=/bin/rm -f /run/fcgiwrap.socket
ExecStart=/usr/bin/spawn-fcgi -u http -g http -s /run/fcgiwrap.sock -n -- /usr/bin/multiwatch -f 10 -- /usr/sbin/fcgiwrap
ExecStartPost=/usr/bin/chmod 660 /run/fcgiwrap.sock
PrivateTmp=true
Restart=on-failure

[Install]
WantedBy=multi-user.target</pre>
<p>Выберите подходящий <code>-f 10</code>, чтобы изменить количество порождаемых подпроцессов.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Строка <code>ExecStartPost</code> требуется из-за странного поведения, которое я наблюдаю при использовании опции <code>-M 660</code> для <code>spawn-fcgi</code>. Устанавливается неправильный режим. Может это баг?</div>
<h5>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_nginx_2"></span><span class="mw-headline" id="Настройка_nginx_2">Настройка nginx</span>
</h5>
<p>Внутри каждого блока <code>server</code> CGI-приложения должен находиться вложенный блок <code>location</code>:
</p>
<pre> location ~ \.cgi$ {
      root           /path/to/server/cgi-bin;
      fastcgi_pass   unix:/run/fcgiwrap.sock;
      include        fastcgi.conf;
 }
</pre>
<p>Стандартным сокетом для <code>fcgiwrap</code> является <code>/run/fcgiwrap.sock</code>.
</p>
<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0_.D0.B2_chroot"></span><span class="mw-headline" id="Установка_в_chroot">Установка в chroot</span>
</h2>
<p>Установка nginx в <a href="../ru/Chroot.html" class="mw-redirect" title="Change root (Русский)">chroot</a> добавляет дополнительный уровень безопасности. Для максимальной безопасности chroot должен включать только файлы, необходимые для запуска сервера nginx, при этом все файлы должны иметь по возможности максимально ограниченные права доступа. Например, как можно больше файлов должно принадлежать пользователю root, а таким каталогам, как <code>/usr/bin</code> должен быть установлен запрет на чтение и запись.
</p>
<p>Arch поставляется с пользователем <code>http</code> и группой по умолчанию, от имени которых запускается сервер. Измененный корневой каталог будет находиться в <code>/srv/http</code>.
</p>
<p>Существует perl-скрипт для создания chroot-окружения, который доступен в <a rel="nofollow" class="external text" href="https://gist.github.com/4365696">jail.pl gist</a>. Вы можете либо использовать его, либо следовать дальнейшим инструкциям из этой статьи. Скрипт требует прав суперпользователя для работы. Вам нужно будет раскомментировать строку, перед тем, как он сможет выполнять какие-либо изменения.
</p>
<h3>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D0.BE.D0.B1.D1.85.D0.BE.D0.B4.D0.B8.D0.BC.D1.8B.D1.85_.D1.83.D1.81.D1.82.D1.80.D0.BE.D0.B9.D1.81.D1.82.D0.B2"></span><span class="mw-headline" id="Создание_необходимых_устройств">Создание необходимых устройств</span>
</h3>
<p>Для nginx нужны <code>/dev/null</code>, <code>/dev/random</code> и <code>/dev/urandom</code>. Чтобы установить их в chroot мы создадим каталог <code>/dev</code> и добавим устройства с помощью <i>mknod</i>. Избегайте монтирования всех устройств в <code>/dev</code>: тогда, даже если chroot будет скомпрометирован, атакующий должен будет выбраться из chroot-окружения чтобы добраться до важных устройств, например <code>/dev/sda1</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Убедитесь, что <code>/src/http</code> примонтирован без опции no-dev</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Смотрите <span class="plainlinks archwiki-template-man" title="$ man 1 mknod"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mknod.1">mknod(1)</a></span> и <code>ls -l /dev/{null,random,urandom}</code>, чтобы лучше понять опции <i>mknod</i>.</div>
<pre># export JAIL=/srv/http
# mkdir $JAIL/dev
# mknod -m 0666 $JAIL/dev/null c 1 3
# mknod -m 0666 $JAIL/dev/random c 1 8
# mknod -m 0444 $JAIL/dev/urandom c 1 9
</pre>
<h3>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D0.BE.D0.B1.D1.85.D0.BE.D0.B4.D0.B8.D0.BC.D1.8B.D1.85_.D0.BA.D0.B0.D1.82.D0.B0.D0.BB.D0.BE.D0.B3.D0.BE.D0.B2"></span><span class="mw-headline" id="Создание_необходимых_каталогов">Создание необходимых каталогов</span>
</h3>
<p>Для работы nginx требует определенный набор файлов. Перед тем, как их копировать, создайте для них соответствующие каталоги. Предполагается, что ваш корневой каталог веб-документов nginx находится в <code>/srv/http/www</code>.
</p>
<pre># mkdir -p $JAIL/etc/nginx/logs
# mkdir -p $JAIL/usr/{lib,bin}
# mkdir -p $JAIL/usr/share/nginx
# mkdir -p $JAIL/var/{log,lib}/nginx
# mkdir -p $JAIL/www/cgi-bin
# mkdir -p $JAIL/{run,tmp}
# cd $JAIL; ln -s usr/lib lib
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вы используете 64-битное ядро, вам нужно создать символические ссылки для <code>lib64</code> и <code>usr/lib64</code> в <code>usr/lib</code>: <code>cd $JAIL; ln -s usr/lib lib64</code> и <code>cd $JAIL/usr; ln -s lib lib64</code>.</div>
<p>Затем смонтируйте <code>$JAIL/tmp</code> и <code>$JAIL/run</code> как tmpfs-ы. Размер должен быть ограничен, чтобы быть уверенным, что атакующий не сможет занять всю доступную RAM.
</p>
<pre># mount -t tmpfs none $JAIL/run -o 'noexec,size=1M'
# mount -t tmpfs none $JAIL/tmp -o 'noexec,size=100M'
</pre>
<p>Для того, чтобы монтирование выполнялось автоматически при загрузке системы, добавьте следующие записи в <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> tmpfs   /srv/http/run   tmpfs   rw,noexec,relatime,size=1024k   0       0
 tmpfs   /srv/http/tmp   tmpfs   rw,noexec,relatime,size=102400k 0       0
</pre>
<h3>
<span id=".D0.97.D0.B0.D0.BF.D0.BE.D0.BB.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_chroot"></span><span class="mw-headline" id="Заполнение_chroot">Заполнение chroot</span>
</h3>
<p>Сначала скопируйте простые файлы.
</p>
<pre># cp -r /usr/share/nginx/* $JAIL/usr/share/nginx
# cp -r /usr/share/nginx/html/* $JAIL/www
# cp /usr/bin/nginx $JAIL/usr/bin/
# cp -r /var/lib/nginx $JAIL/var/lib/nginx
</pre>
<p>Теперь скопируйте нужные библиотеки. Используйте <i>ldd</i>, чтобы отобразить их и скопируйте все файлы в правильное место. Копирование предпочтительнее, чем создание жестких ссылок, потому, что даже если атакующий получит права записи в файлы, они не смогут уничтожить или изменить системные файлы вне chroot-окружения.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ldd /usr/bin/nginx</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">linux-vdso.so.1 (0x00007fffc41fe000)
libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f57ec3e8000)
libcrypt.so.1 =&gt; /usr/lib/libcrypt.so.1 (0x00007f57ec1b1000)
libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x00007f57ebead000)
libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f57ebbaf000)
libpcre.so.1 =&gt; /usr/lib/libpcre.so.1 (0x00007f57eb94c000)
libssl.so.1.0.0 =&gt; /usr/lib/libssl.so.1.0.0 (0x00007f57eb6e0000)
libcrypto.so.1.0.0 =&gt; /usr/lib/libcrypto.so.1.0.0 (0x00007f57eb2d6000)
libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f57eb0d2000)
libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007f57eaebc000)
libGeoIP.so.1 =&gt; /usr/lib/libGeoIP.so.1 (0x00007f57eac8d000)
libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f57eaa77000)
libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f57ea6ca000)
/lib64/ld-linux-x86-64.so.2 (0x00007f57ec604000)</pre>
<pre># cp /lib64/ld-linux-x86-64.so.2 $JAIL/lib
</pre>
<p>Для файлов, находящихся в <code>/usr/lib</code>, вы можете воспользоваться следующей командой:
</p>
<pre># cp $(ldd /usr/bin/nginx | grep /usr/lib | sed -sre 's/(.+)(\/usr\/lib\/\S+).+/\2/g') $JAIL/usr/lib
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Не пытайтесь скопировать <code>linux-vdso.so</code> — это не настоящая библиотека и ее не существует в <code>/usr/lib</code>. Аналогично <code>ld-linux-x86-64.so</code> также будет отображена в <code>/lib64</code> для 64-битной системы.</div>
<p>Копируйте другие необходимые библиотеки и системные файлы.
</p>
<pre># cp /usr/lib/libnss_* $JAIL/usr/lib
# cp -rfvL /etc/{services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf,nginx} $JAIL/etc
</pre>
<p>Создайте файлы пользователей и групп в chroot-окружении. Таким образом, в chroot-окружении будут доступны только указанные пользователи, и никакая информация о пользователях из основной системы не будет доступна атакующему, получившему доступ в chroot-окружение.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/group</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:
nobody:x:99:
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/passwd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:33:http:/:/bin/false
nobody:x:99:99:nobody:/:/bin/false
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/shadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:14871::::::
nobody:x:14871::::::
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/gshadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:::
nobody:::
</pre>
<pre># touch $JAIL/etc/shells
# touch $JAIL/run/nginx.pid
</pre>
<p>Наконец, сделайте права доступа максимально ограниченными. Как можно больше должно принадлежать суперпользователю и быть закрытым для записи.
</p>
<pre># chown -R root:root $JAIL/

# chown -R http:http $JAIL/www
# chown -R http:http $JAIL/etc/nginx
# chown -R http:http $JAIL/var/{log,lib}/nginx
# chown http:http $JAIL/run/nginx.pid

# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs sudo chmod -rw
# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs sudo chmod +x
# find $JAIL/etc -gid 0 -uid 0 -type f -print | xargs sudo chmod -x
# find $JAIL/usr/bin -type f -print | xargs sudo chmod ug+rx
# find $JAIL/ -group http -user http -print | xargs sudo chmod o-rwx
# chmod +rw $JAIL/tmp
# chmod +rw $JAIL/run
</pre>
<p>Если ваш сервер будет принимать входящие соединения на 80 порту (или любому другому порту в диапазоне [1-1023]), дайте исполнителю chroot права на соединение с этими портами без необходимости прав суперпользователя.
</p>
<pre># setcap 'cap_net_bind_service=+ep' $JAIL/usr/bin/nginx
</pre>
<h3>
<span id=".D0.9E.D1.82.D1.80.D0.B5.D0.B4.D0.B0.D0.BA.D1.82.D0.B8.D1.80.D1.83.D0.B9.D1.82.D0.B5_nginx.service_.D0.B4.D0.BB.D1.8F_.D0.B7.D0.B0.D0.BF.D1.83.D1.81.D0.BA.D0.B0_chroot"></span><span class="mw-headline" id="Отредактируйте_nginx.service_для_запуска_chroot">Отредактируйте nginx.service для запуска chroot</span>
</h3>
<p>Перед редактированием юнит-файла <code>nginx.service</code> неплохо будет скопировать его в <code>/etc/systemd/system/</code>, так как там юнит файлы имеют приоритет над теми, что в <code>/usr/lib/systemd/system/</code>. Это значит, что обновление nginx не перезапишет ваш собственный файл <i>.service</i>.
</p>
<pre># cp /usr/lib/systemd/system/nginx.service /etc/systemd/system/nginx.service
</pre>
<p>Юнит systemd должен быть настроен так, чтобы запускать nginx в chroot от имени пользователя http и хранить pid-файл в chroot.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Я не уверен, нужно ли хранить pid-файл в chroot.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> [Unit]
 Description=A high performance web server and a reverse proxy server
 After=syslog.target network.target
 
 [Service]
 Type=forking
 PIDFile=/srv/http/run/nginx.pid
 ExecStartPre=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -t -q -g 'pid /run/nginx.pid; daemon on; master_process on;'
 ExecStart=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;'
 ExecReload=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;' -s reload
 ExecStop=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid;' -s quit
 
 [Install]
 WantedBy=multi-user.target</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Обновление nginx с помощью pacman не обновит установленную в chroot копию. Вы должны вручную выполнять обновления, повторяя указанные выше шаги по переносу файлов. Не забудьте также обновить библиотеки, которые использует nginx.</div>
<p>Теперь вы можете спокойно удалить установленный вне chroot nginx.
</p>
<pre># pacman -Rsc nginx
</pre>
<p>Если вы не удалили установленный вне chroot nginx, проверьте, что работающий процесс nginx — это действительно именно тот, что в находится chroot. Для этого посмотрите, куда указывает символическая ссылка <code>/proc/{PID}/root</code>: она должен указывать на <code>/srv/http</code>, а не на <code>/</code>.
</p>
<pre># ps -C nginx | awk '{print $1}' | sed 1d | while read -r PID; do ls -l /proc/$PID/root; done
</pre>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<h3>
<span id=".D0.92.D0.B0.D0.BB.D0.B8.D0.B4.D0.B0.D1.86.D0.B8.D1.8F_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Валидация_конфигурации">Валидация конфигурации</span>
</h3>
<pre># nginx -t
</pre>
<pre>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre>
<h3>
<span id=".D0.9F.D1.80.D0.B8_.D0.B4.D0.BE.D1.81.D1.82.D1.83.D0.BF.D0.B5_.D1.81_.D0.BB.D0.BE.D0.BA.D0.B0.D0.BB.D1.8C.D0.BD.D0.BE.D0.B3.D0.BE_IP_.D0.BF.D0.B5.D1.80.D0.B5.D0.BD.D0.B0.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D1.8F.D0.B5.D1.82.D1.81.D1.8F_.D0.BD.D0.B0_localhost"></span><span class="mw-headline" id="При_доступе_с_локального_IP_перенаправляется_на_localhost">При доступе с локального IP перенаправляется на localhost</span>
</h3>
<p>Решение с <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=780561#p780561">форума Arch Linux</a>.
</p>
<p>В файле <code>/etc/nginx/nginx.conf</code> найдите незакомментированную строку <code>server_name localhost</code> (без <code>#</code> вначале) и добавьте под ней:
</p>
<pre>server_name_in_redirect off;
</pre>
<p>По умолчанию, nginx перенаправляет любые запросы на указанное в опции <code>server_name</code> имя.
</p>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_.D0.A1.D1.82.D1.80.D0.B0.D0.BD.D0.B8.D1.86.D0.B0.2C_.D0.BA.D0.BE.D1.82.D0.BE.D1.80.D1.83.D1.8E_.D0.B2.D1.8B_.D0.B8.D1.89.D0.B8.D1.82.D0.B5.2C_.D0.B2.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D0.BD.D0.BE_.D0.BD.D0.B5.D0.B4.D0.BE.D1.81.D1.82.D1.83.D0.BF.D0.BD.D0.B0._.D0.9F.D0.BE.D0.B6.D0.B0.D0.BB.D1.83.D0.B9.D1.81.D1.82.D0.B0.2C_.D0.BF.D0.BE.D0.BF.D1.80.D0.BE.D0.B1.D1.83.D0.B9.D1.82.D0.B5_.D0.BF.D0.BE.D0.B7.D0.B6.D0.B5._.28502_Bad_Gateway.29"></span><span class="mw-headline" id="Ошибка:_Страница,_которую_вы_ищите,_временно_недоступна._Пожалуйста,_попробуйте_позже._(502_Bad_Gateway)">Ошибка: Страница, которую вы ищите, временно недоступна. Пожалуйста, попробуйте позже. (502 Bad Gateway)</span>
</h3>
<p>Это из-за того, что сервер FastCGI не запущен или используемый сокет имеет неправильные права доступа.
</p>
<p>Попробуйте <a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/4252368/nginx-502-bad-gateway/16497957#16497957">этот ответ</a>, чтобы исправить 502 ошибку.
</p>
<p>В Archlinux, файлом настройки, упомянутом по ссылке выше, является <code>/etc/php/php-fpm.conf</code>.
</p>
<p>При определённых обстоятельствах, <code>fcgiwrap.socket</code> может не запуститься правильно и создать бесполезный сокет юникс домена <code>/run/fcgiwrap.sock</code>.
</p>
<p>Попробуйте <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Остановить">остановить</a> службу <code>fcgiwrap.socket</code> и удалить файл доменного юникс сокета по умолчанию.
</p>
<pre><code># rm /run/fcgiwrap.sock</code>
</pre>
<p>Затем <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Запустите">запустите</a> <code>fcgiwrap.service</code> вместо него.
Проверьте статус <code>fcgiwrap.service</code> и нового доменного юникс сокета <code>/run/fcgiwrap.sock</code>:
</p>
 <pre>$ systemctl status fcgiwrap.service
$ ls /run/fcgiwrap.sock</pre>
<p>Если это сработало, <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Отключите">отключите</a> <code>fcgiwrap.socket</code> и <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Включите">включите</a> <code>fcgiwrap.service</code>.
</p>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_No_input_file_specified"></span><span class="mw-headline" id="Ошибка:_No_input_file_specified">Ошибка: No input file specified</span>
</h3>
<p>1. Скорее всего у вас не установлена переменная <code>SCRIPT_FILENAME</code>, содержащая полный путь до ваших скриптов. Если конфигурация nginx (<code>fastcgi_param SCRIPT_FILENAME</code>) правильная, то эта ошибка означает, что php не смог загрузить запрашиваемый скрипт. Часто это просто оказывается ошибкой прав доступа, и вы можете запустить php-cgi с правами root:
</p>
<pre># spawn-fcgi -a 127.0.0.1 -p 9000 -f /usr/bin/php-cgi
</pre>
<p>или вам следует создать группу и пользователя для запуска php-cgi:
</p>
<pre># groupadd www
# useradd -g www www
# chmod +w /srv/www/nginx/html
# chown -R www:www /srv/www/nginx/html
# spawn-fcgi -a 127.0.0.1 -p 9000 -u www -g www -f /usr/bin/php-cgi
</pre>
<p>2. Другой причиной может быть то, что задан неправильный аргумент <code>root</code> в секции <code>location ~ \.php$</code> в <code>nginx.conf</code>. Убедитесь, что <code>root</code> указывает на ту же директорию, что и в <code>location /</code> на том же сервере. Либо вы можете просто задать абсолютный путь до корневого каталога, не определяя его в каких-либо location секциях.
</p>
<p>3. Убедитесь, что переменная <code>open_basedir</code> в <code>/etc/php/php.ini</code> также содержит путь, который соответствует аргументу <code>root</code> в <code>nginx.conf</code>.
</p>
<p>4. Также обратите внимание, что не только php-скрипты должны иметь права на чтение, но также и вся структура каталогов должна иметь право на исполнение, чтобы пользователь PHP мог добраться до этого каталога.
</p>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_.22File_not_found.22_.D0.B2_.D0.B1.D1.80.D0.B0.D1.83.D0.B7.D0.B5.D1.80.D0.B5_.D0.B8.D0.BB.D0.B8_.22Primary_script_unknown.22_.D0.B2_.D0.BB.D0.BE.D0.B3-.D1.84.D0.B0.D0.B9.D0.BB.D0.B5"></span><span class="mw-headline" id='Ошибка:_"File_not_found"_в_браузере_или_"Primary_script_unknown"_в_лог-файле'>Ошибка: "File not found" в браузере или "Primary script unknown" в лог-файле</span>
</h3>
<p>Убедитесь, что вы определили <code>root</code> и <code>index</code> в ваших директивах <code>server</code> или <code>location</code>:
</p>
<pre> location ~ \.php$ {
      root           /srv/http/root_dir;
      index          index.php;
      fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
      include        fastcgi.conf;
 }
</pre>
<p>Также убедитесь, что запрашиваемый файл существует на сервере.
</p>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_chroot:_.27.2Fusr.2Fsbin.2Fnginx.27_No_such_file_or_directory"></span><span class="mw-headline" id="Ошибка:_chroot:_'/usr/sbin/nginx'_No_such_file_or_directory">Ошибка: chroot: '/usr/sbin/nginx' No such file or directory</span>
</h3>
<p>Если у вас возникает эта ошибка при запуске демона <i>nginx</i> в chroot, скорее всего, это происходит из-за отсутствующих 64-битных библиотек в изолированном окружении.
</p>
<p>Если ваш chroot запущен в <code>/srv/http</code>, вам нужно добавить требуемые 64-битные библиотеки.
</p>
<p>Сначала создайте каталоги:
</p>
<pre># mkdir /srv/http/usr/lib64
# cd /srv/http; ln -s usr/lib64 lib64
</pre>
<p>Затем скопируйте требуемые 64-битные библиотеки, перечисленные командой <code>ldd /usr/sbin/nginx</code> в <code>/srv/http/usr/lib64</code>.
</p>
<p>При запуске от root, на библиотеки должны быть права чтения и исполнения для всех пользователей, так что изменения не требуются.
</p>
<h3>
<span id=".D0.90.D0.BB.D1.8C.D1.82.D0.B5.D1.80.D0.BD.D0.B0.D1.82.D0.B8.D0.B2.D0.BD.D1.8B.D0.B9_.D1.81.D0.BA.D1.80.D0.B8.D0.BF.D1.82_.D0.B4.D0.BB.D1.8F_systemd"></span><span class="mw-headline" id="Альтернативный_скрипт_для_systemd">Альтернативный скрипт для systemd</span>
</h3>
<p>На чистой systemd вы можете получить преимущества при использовании связки chroot и systemd <a rel="nofollow" class="external autonumber" href="http://0pointer.de/blog/projects/changing-roots.html">[1]</a>. На основе заданных <a rel="nofollow" class="external text" href="http://wiki.nginx.org/CoreModule#user">пользователя и группы</a> и pid:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user http;
pid /run/nginx.pid;</pre>
<p>абсолютным путем к файлу является <code>/srv/http/etc/nginx/nginx.conf</code>.3
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot)
After=syslog.target network.target

[Service]
Type=forking
PIDFile=/srv/http/run/nginx.pid
RootDirectory=/srv/http
ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf
ExecReload=/usr/sbin/nginx -c /etc/nginx/nginx.conf -s reload
ExecStop=/usr/sbin/nginx -c /etc/nginx/nginx.conf -s stop

[Install]
WantedBy=multi-user.target</pre>
<p>Нет необходимости задавать расположение по умолчанию, nginx по умолчанию загружает <code> -c /etc/nginx/nginx.conf</code>, хотя вообще это хорошая идея.
</p>
<p>Также можно запускать <b>только</b> <code>ExecStart</code> как chroot с параметром <code>RootDirectoryStartOnly</code> заданным как <code>yes</code> <a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">man systemd service</a> или запустить его до точки монтирования в качестве эффективного или <a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/systemd.path.html">пути systemd</a>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.path</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot) path
[Path]
PathExists=/srv/http/site/Public_html
[Install]
WantedBy=default.target</pre>
<p><a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Включите">Включите</a> <code>nginx.path</code> и замените <code>WantedBy=default.target</code> на <code>WantedBy=nginx.path</code> in <code>/etc/systemd/system/nginx.service</code>.
</p>
<p>Ссылка <code>PIDFile</code> в файле юнита позволяет systemd следить за процессом (необходим абсолютный путь). Если это нежелательно, вы можете изменить тип one-shoot по умолчанию и удалить ссылку из файла юнита.
</p>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://calomel.org/nginx.html">Very good in-depth 2014 look at Nginx security and Reverse Proxying</a></li>
<li><a rel="nofollow" class="external text" href="http://nginx.org/">Nginx Official Site</a></li>
<li><a rel="nofollow" class="external text" href="http://calomel.org/nginx.html">Nginx HowTo</a></li>
<li>
<a rel="nofollow" class="external text" href="http://blog.gotux.net/tutorial/custom-nginx-indexer/">Custom Nginx Indexer</a><sup>[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">устаревшая ссылка</a> 2020-08-04]</sup>
</li>
<li><a rel="nofollow" class="external text" href="http://www.tecmint.com/install-nginx-php-mysql-with-mariadb-engine-and-phpmyadmin-in-arch-linux/">Installing LEMP (Nginx, PHP, MySQL with MariaDB engine and PhpMyAdmin) in Arch Linux</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../ru/Category:Web_server.html" title="Category:Web server (Русский)">Web server (Русский)</a></li></ul>
</div></div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Nginx_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=629685">https://wiki.archlinux.org/index.php?title=Nginx_(Русский)&amp;oldid=629685</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 5 August 2020, at 06:56.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
