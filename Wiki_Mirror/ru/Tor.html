<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Tor (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Tor_Русский rootpage-Tor_Русский skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Tor (Русский)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Ссылки по теме</p>
<ul>
<li><a href="/title/GNUnet" title="GNUnet">GNUnet</a></li>
<li><a href="/title/I2P_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="I2P (Русский)">I2P (Русский)</a></li>
<li><a href="/title/Freenet" title="Freenet">Freenet</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="/title/Tor" title="Tor">Tor</a>. Дата последней синхронизации: 7 мая 2021. Вы можете <a href="/title/ArchWiki:Translation_Team_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Tor&amp;diff=0&amp;oldid=668165">изменения</a>.</div>
<p><a rel="nofollow" class="external text" href="https://www.torproject.org">Tor Project</a> (<i>T</i>he <i>o</i>nion <i>r</i>outing) — открытая реализация <a href="https://en.wikipedia.org/wiki/ru:%D0%9B%D1%83%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F" class="extiw" title="wikipedia:ru:Луковая маршрутизация">луковой маршрутизации</a>, предоставляющая доступ к анонимной прокси-сети. Основная цель — сохранить <a href="https://en.wikipedia.org/wiki/ru:%D0%90%D0%BD%D0%BE%D0%BD%D0%B8%D0%BC%D0%BD%D0%BE%D1%81%D1%82%D1%8C#.D0.98.D0.BD.D1.82.D0.B5.D1.80.D0.BD.D0.B5.D1.82_.D0.B8_.D0.90.D0.BD.D0.BE.D0.BD.D0.B8.D0.BC.D0.BD.D0.BE.D1.81.D1.82.D1.8C" class="extiw" title="wikipedia:ru:Анонимность">анонимность</a> пользователя в интернете, обеспечив защиту от <a href="https://en.wikipedia.org/wiki/ru:%D0%90%D1%82%D0%B0%D0%BA%D0%B0_%D1%81_%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC_%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0_%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0" class="extiw" title="wikipedia:ru:Атака с использованием анализа трафика">анализа трафика</a>.
</p>
<p>Пользователи сети Tor запускают на своих машинах "луковый прокси" (onion proxy), который предоставляет программам-клиентам SOCKS-интерфейс. Прокси подключается к сети Tor, периодически согласовывая виртуальный канал через неё. Tor использует многослойную криптографию (отсюда "луковые" аналогии), последовательно обеспечивая секретность на каждом промежуточном маршрутизаторе.
</p>
<p>В процессе работы луковый прокси управляет сетевым трафиком, обеспечивая анонимность конечного пользователя. Трафик зашифровывается, пересылается через узлы сети Tor и дешифруется на последнем узле перед отправкой на целевой сервер. Цена обеспечения анонимности — низкая скорость работы по сравнению с обычным прямым соединением из-за большого количества перенаправлений трафика. Кроме того, хотя Tor обеспечивает защиту от анализа трафика, невозможно избежать подтверждения трафика на границах сети Tor (т.е. в точках входа и выхода из сети). Подробнее см. <a href="https://en.wikipedia.org/wiki/ru:Tor" class="extiw" title="wikipedia:ru:Tor">Wikipedia:ru:Tor</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Сам по себе Tor <b>не</b> обеспечивает полную анонимность. Существует целый ряд проблем и возможных ошибок (см. <a rel="nofollow" class="external text" href="https://en.calameo.com/read/005242387ef11d44d4ae7">Want Tor To Really Work?</a>).</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0"><span class="tocnumber">1</span> <span class="toctext">Установка</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5"><span class="tocnumber">2</span> <span class="toctext">Использование</span></a></li>
<li class="toclevel-1 tocsection-3">
<a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0"><span class="tocnumber">3</span> <span class="toctext">Настройка</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_Tor_Relay"><span class="tocnumber">3.1</span> <span class="toctext">Настройка Tor Relay</span></a></li>
<li class="toclevel-2 tocsection-5">
<a href="#Tor_ControlPort"><span class="tocnumber">3.2</span> <span class="toctext">Tor ControlPort</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#Cookie-%D1%84%D0%B0%D0%B9%D0%BB_Tor_Control"><span class="tocnumber">3.2.1</span> <span class="toctext">Cookie-файл Tor Control</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C_Tor_Control"><span class="tocnumber">3.2.2</span> <span class="toctext">Пароль Tor Control</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Tor_ControlSocket"><span class="tocnumber">3.2.3</span> <span class="toctext">Tor ControlSocket</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_Tor_Control"><span class="tocnumber">3.2.4</span> <span class="toctext">Проверка Tor Control</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_Chroot"><span class="tocnumber">4</span> <span class="toctext">Запуск Tor в Chroot</span></a></li>
<li class="toclevel-1 tocsection-11">
<a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B5_systemd-nspawn"><span class="tocnumber">5</span> <span class="toctext">Запуск Tor в контейнере systemd-nspawn</span></a>
<ul>
<li class="toclevel-2 tocsection-12">
<a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B8_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D1%85%D0%BE%D1%81%D1%82%D0%B0"><span class="tocnumber">5.1</span> <span class="toctext">Установка и настройка хоста</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="#%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B9_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81"><span class="tocnumber">5.1.1</span> <span class="toctext">Виртуальный сетевой интерфейс</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B8_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_systemd-nspawn"><span class="tocnumber">5.1.2</span> <span class="toctext">Запуск и включение systemd-nspawn</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-15">
<a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0"><span class="tocnumber">5.2</span> <span class="toctext">Настройка контейнера</span></a>
<ul>
<li class="toclevel-3 tocsection-16"><a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B8_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_systemd-networkd"><span class="tocnumber">5.2.1</span> <span class="toctext">Запуск и включение systemd-networkd</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-17"><a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_Tor"><span class="tocnumber">5.3</span> <span class="toctext">Настройка Tor</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-18">
<a href="#%D0%92%D0%B5%D0%B1-%D1%81%D1%91%D1%80%D1%84%D0%B8%D0%BD%D0%B3"><span class="tocnumber">6</span> <span class="toctext">Веб-сёрфинг</span></a>
<ul>
<li class="toclevel-2 tocsection-19"><a href="#Firefox"><span class="tocnumber">6.1</span> <span class="toctext">Firefox</span></a></li>
<li class="toclevel-2 tocsection-20">
<a href="#Chromium"><span class="tocnumber">6.2</span> <span class="toctext">Chromium</span></a>
<ul>
<li class="toclevel-3 tocsection-21"><a href="#%D0%9E%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0"><span class="tocnumber">6.2.1</span> <span class="toctext">Отладка</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="#%D0%A0%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D1%8F"><span class="tocnumber">6.2.2</span> <span class="toctext">Расширения</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-23"><a href="#Luakit"><span class="tocnumber">6.3</span> <span class="toctext">Luakit</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-24">
<a href="#HTTP-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8"><span class="tocnumber">7</span> <span class="toctext">HTTP-прокси</span></a>
<ul>
<li class="toclevel-2 tocsection-25"><a href="#Tor"><span class="tocnumber">7.1</span> <span class="toctext">Tor</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#Firefox_2"><span class="tocnumber">7.2</span> <span class="toctext">Firefox</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Polipo"><span class="tocnumber">7.3</span> <span class="toctext">Polipo</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Privoxy"><span class="tocnumber">7.4</span> <span class="toctext">Privoxy</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-29">
<a href="#%D0%9E%D0%B1%D0%BC%D0%B5%D0%BD_%D0%BC%D0%B3%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%D0%B8_%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F%D0%BC%D0%B8"><span class="tocnumber">8</span> <span class="toctext">Обмен мгновенными сообщениями</span></a>
<ul>
<li class="toclevel-2 tocsection-30"><a href="#Pidgin"><span class="tocnumber">8.1</span> <span class="toctext">Pidgin</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Irssi"><span class="tocnumber">8.2</span> <span class="toctext">Irssi</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-32"><a href="#Pacman"><span class="tocnumber">9</span> <span class="toctext">Pacman</span></a></li>
<li class="toclevel-1 tocsection-33"><a href="#Java"><span class="tocnumber">10</span> <span class="toctext">Java</span></a></li>
<li class="toclevel-1 tocsection-34">
<a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0_Tor"><span class="tocnumber">11</span> <span class="toctext">Запуск сервера Tor</span></a>
<ul>
<li class="toclevel-2 tocsection-35"><a href="#%D0%9C%D0%BE%D1%81%D1%82"><span class="tocnumber">11.1</span> <span class="toctext">Мост</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="#%D0%9F%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%8E%D1%89%D0%B8%D0%B9_%D1%83%D0%B7%D0%B5%D0%BB"><span class="tocnumber">11.2</span> <span class="toctext">Передающий узел</span></a></li>
<li class="toclevel-2 tocsection-37">
<a href="#%D0%92%D1%8B%D1%85%D0%BE%D0%B4%D0%BD%D0%BE%D0%B9_%D1%83%D0%B7%D0%B5%D0%BB"><span class="tocnumber">11.3</span> <span class="toctext">Выходной узел</span></a>
<ul>
<li class="toclevel-3 tocsection-38"><a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_2"><span class="tocnumber">11.3.1</span> <span class="toctext">Настройка</span></a></li>
<li class="toclevel-3 tocsection-39">
<a href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8_100-%D0%BC%D0%B5%D0%B3%D0%B0%D0%B1%D0%B8%D1%82%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B2%D1%8B%D1%85%D0%BE%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE_%D1%83%D0%B7%D0%BB%D0%B0"><span class="tocnumber">11.3.2</span> <span class="toctext">Пример настройки 100-мегабитного выходного узла</span></a>
<ul>
<li class="toclevel-4 tocsection-40">
<a href="#Tor_2"><span class="tocnumber">11.3.2.1</span> <span class="toctext">Tor</span></a>
<ul>
<li class="toclevel-5 tocsection-41"><a href="#%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9"><span class="tocnumber">11.3.2.1.1</span> <span class="toctext">Количество соединений</span></a></li>
<li class="toclevel-5 tocsection-42"><a href="#%D0%9F%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5_%D0%BF%D0%BE%D1%80%D1%82%D1%8B"><span class="tocnumber">11.3.2.1.2</span> <span class="toctext">Привилегированные порты</span></a></li>
<li class="toclevel-5 tocsection-43"><a href="#%D0%9A%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F"><span class="tocnumber">11.3.2.1.3</span> <span class="toctext">Конфигурация</span></a></li>
</ul>
</li>
<li class="toclevel-4 tocsection-44"><a href="#nyx"><span class="tocnumber">11.3.2.2</span> <span class="toctext">nyx</span></a></li>
<li class="toclevel-4 tocsection-45"><a href="#iptables"><span class="tocnumber">11.3.2.3</span> <span class="toctext">iptables</span></a></li>
<li class="toclevel-4 tocsection-46"><a href="#Haveged"><span class="tocnumber">11.3.2.4</span> <span class="toctext">Haveged</span></a></li>
<li class="toclevel-4 tocsection-47">
<a href="#pdnsd"><span class="tocnumber">11.3.2.5</span> <span class="toctext">pdnsd</span></a>
<ul>
<li class="toclevel-5 tocsection-48"><a href="#Uncensored_DNS"><span class="tocnumber">11.3.2.5.1</span> <span class="toctext">Uncensored DNS</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-49">
<a href="#TorDNS"><span class="tocnumber">12</span> <span class="toctext">TorDNS</span></a>
<ul>
<li class="toclevel-2 tocsection-50"><a href="#%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_DNS-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2_%D1%87%D0%B5%D1%80%D0%B5%D0%B7_TorDNS"><span class="tocnumber">12.1</span> <span class="toctext">Перенаправление DNS-запросов через TorDNS</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-51"><a href="#Torsocks"><span class="tocnumber">13</span> <span class="toctext">Torsocks</span></a></li>
<li class="toclevel-1 tocsection-52"><a href="#%22%D0%A2%D0%BE%D1%80%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F%22"><span class="tocnumber">14</span> <span class="toctext">"Торификация"</span></a></li>
<li class="toclevel-1 tocsection-53">
<a href="#%D0%A1%D0%BE%D0%B2%D0%B5%D1%82%D1%8B_%D0%B8_%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8"><span class="tocnumber">15</span> <span class="toctext">Советы и рекомендации</span></a>
<ul>
<li class="toclevel-2 tocsection-54"><a href="#%D0%92%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D0%B8_%D1%8F%D0%B4%D1%80%D0%B0"><span class="tocnumber">15.1</span> <span class="toctext">Возможности ядра</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-55">
<a href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC"><span class="tocnumber">16</span> <span class="toctext">Решение проблем</span></a>
<ul>
<li class="toclevel-2 tocsection-56"><a href="#%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%B0_%D1%81_%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BC_User"><span class="tocnumber">16.1</span> <span class="toctext">Проблема с параметром User</span></a></li>
<li class="toclevel-2 tocsection-57"><a href="#%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B_%D1%81_%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8_tor-browser"><span class="tocnumber">16.2</span> <span class="toctext">Проблемы с прокси tor-browser</span></a></li>
<li class="toclevel-2 tocsection-58"><a href="#%D0%9F%D1%83%D1%81%D1%82%D0%BE%D0%B9_%D1%87%D1%91%D1%80%D0%BD%D1%8B%D0%B9_%D1%8D%D0%BA%D1%80%D0%B0%D0%BD_%D0%B2_tor-browser"><span class="tocnumber">16.3</span> <span class="toctext">Пустой чёрный экран в tor-browser</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-59"><a href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5"><span class="tocnumber">17</span> <span class="toctext">Смотрите также</span></a></li>
</ul>
</div>

<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="/title/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tor">tor</a></span>.
</p>
<p>Как правило, с его помощью осуществляется <a href="#%D0%92%D0%B5%D0%B1-%D1%81%D1%91%D1%80%D1%84%D0%B8%D0%BD%D0%B3">#Веб-сёрфинг</a>.
</p>
<p><i>Nyx</i> — консольная утилита для мониторинга Tor. Позволяет отслеживать использование пропускной способности, детали соединений, а также редактировать настройки "на лету". Для его использования <a href="/title/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Установите">установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span>.
</p>
<h2>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Использование">Использование</span>
</h2>
<p><a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5/%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>tor.service</code>. В качестве альтернативы можно запустить Tor командой <code>sudo -u tor /usr/bin/tor</code>.
</p>
<p>Чтобы программа работала через Tor, настройте её использовать <code>127.0.0.1</code> или <code>localhost</code> в качестве SOCKS5-прокси на порте 9050 (для Tor со стандартными настройками).
</p>
<p>Прокси позволяет удалённо выполнять разрешение доменных имён: используйте <code>socks5<b>h</b>://localhost:9050</code> для отправки DNS-запросов с выходного узла (вместо <code>socks5</code> для локальных запросов).
</p>
<p>Проверить работу Tor можно на странице <a rel="nofollow" class="external free" href="https://check.torproject.org/">https://check.torproject.org/</a> или <a rel="nofollow" class="external free" href="https://torcheck.xenobite.eu/">https://torcheck.xenobite.eu/</a>.
</p>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0"></span><span class="mw-headline" id="Настройка">Настройка</span>
</h2>
<p>По умолчанию Tor считывает настройки из файла <code>/etc/tor/torrc</code>, или, если последний не обнаружен, из <code>$HOME/.torrc</code>. Настройки объясняются в руководстве <span class="plainlinks archwiki-template-man" title="$ man 1 tor"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/tor.1">tor(1)</a></span> и на <a rel="nofollow" class="external text" href="https://www.torproject.org/docs/tor-manual.html.en">сайте Tor</a>. Настройки по умолчанию должны работать для большинства пользователей.
</p>
<p>После изменения настроек службу <code>tor.service</code> необходимо <a href="/title/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Перезагрузите">перезагрузить</a>.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_Tor_Relay"></span><span class="mw-headline" id="Настройка_Tor_Relay">Настройка Tor Relay</span>
</h3>
<p>Максимальное количество дескрипторов файлов, одновременно открытых Tor, задаётся параметром <code>LimitNOFILE</code> в файле <code>tor.service</code>. Для быстрых ретрансляторов имеет смысл увеличить это значение.
</p>
<p>Если на вашей системе не запущен веб-сервер и вы не задавали значение <code>AccountingMax</code> (определяет максимальный объём передаваемых данных), рассмотрите возможность установки параметра <code>ORPort</code> в значение <code>443</code> и/или <code>DirPort</code> в значение <code>80</code>. Многие пользователи Tor находятся за жёсткими межсетевыми экранами, которые разрешают им только веб-сёрфинг, и такая настройка позволит им использовать ваш ретранслятор. Если порты <code>80</code> и <code>443</code> уже заняты, то подойдут <code>22</code>, <code>110</code>, <code>143</code> и <code>9001</code> <a rel="nofollow" class="external autonumber" href="https://trac.torproject.org/projects/tor/wiki/TorRelayGuide#TorRelaySetup:InstallationandConfiguration">[1]</a>. Порты с номерами до 1024 являются системными и при работе через них Tor должен быть запущен с привилегиями суперпользователя; задайте параметры <code>User=root</code> и <code>User tor</code> в файлах <code>tor.service</code> и <code>torrc</code> соответственно.
</p>
<p>Также будет полезно прочитать статью о <a rel="nofollow" class="external text" href="https://blog.torproject.org/blog/lifecycle-of-a-new-relay">жизненном цикле</a> ретрансляторов в документации Tor.
</p>
<h3><span class="mw-headline" id="Tor_ControlPort">Tor ControlPort</span></h3>
<p>Как правило, особой необходимости открывать <i>ControlPort</i> не возникает, но некоторым программам это может потребоваться для получения низкоуровневого доступа к узлу.
</p>
<p>Через открытый ControlPort внешние приложения смогут отслеживать состояние вашего узла, корректировать настройки, а также получать информацию о состоянии сети Tor и виртуальных каналов.
</p>
<p>Добавьте следующую строку в файл <code>torrc</code>:
</p>
<pre>ControlPort 9051
</pre>
<p>Разумеется, доступ к ControlPort должен предоставляться только доверенным пользователям. Ограничение доступа осуществляется либо с помощью cookie-файла, либо паролем, либо обоими способами одновременно.
</p>
<h4>
<span id="Cookie-.D1.84.D0.B0.D0.B9.D0.BB_Tor_Control"></span><span class="mw-headline" id="Cookie-файл_Tor_Control">Cookie-файл Tor Control</span>
</h4>
<p>Добавьте к файлу <code>torrc</code> следующие строки:
</p>
<pre>CookieAuthentication 1
CookieAuthFile /var/lib/tor/control_auth_cookie
CookieAuthFileGroupReadable 1
DataDirectoryGroupReadable 1
</pre>
<p>Доступ к ControlPort будет ограничен набором файловых разрешений cookie-файла и каталога data. Доступ к cookie-файлу Tor Control получат все пользователи группы <code>tor</code>.
</p>
<p>Добавьте пользователя в группу <code>tor</code>:
</p>
<pre># usermod -a -G tor <i>пользователь</i>
</pre>
<p>Перезагрузите настройки группы:
</p>
<pre>$ newgrp tor
</pre>
<p><a href="/title/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Перезапустите">Перезапустите</a> Tor:
</p>
<pre># systemctl restart tor
</pre>
<p>Теперь <i>пользователь</i> имеет доступ к файлу сookie. Команда
</p>
<pre>$ stat -c%a /var/lib/tor /var/lib/tor/control_auth_cookie
</pre>
<p>должна вывести значения <code>750</code> и <code>640</code>.
</p>
<h4>
<span id=".D0.9F.D0.B0.D1.80.D0.BE.D0.BB.D1.8C_Tor_Control"></span><span class="mw-headline" id="Пароль_Tor_Control">Пароль Tor Control</span>
</h4>
<p>Преобразуйте пароль из представления в виде открытого текста в хэш:
</p>
<pre># set +o history                          # отключить историю команд bash
# tor --hash-password <i>пароль</i>
# set -o history                          # включить историю команд bash
</pre>
<p>Добавьте этот хэш к файлу <code>torrc</code>:
</p>
<pre>HashedControlPassword <i>хэш</i>
</pre>
<p>Команда <code>set +o history</code> отключает сохранение истории в файл <code>$HISTFILE</code>, чтобы при выполнении команды <code>tor --hash-password</code> в нём не сохранилось значение пароля открытым текстом.
</p>
<h4><span class="mw-headline" id="Tor_ControlSocket">Tor ControlSocket</span></h4>
<p>Tor ControlSocket имеет примерно то же назначение, что и <a href="#Tor_ControlPort">#Tor ControlPort</a>, с той лишь разницей, что прослушивается не TCP-сокет, а <a href="https://en.wikipedia.org/wiki/ru:%D0%A1%D0%BE%D0%BA%D0%B5%D1%82_%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B0_Unix" class="extiw" title="wikipedia:ru:Сокет домена Unix">сокет домена</a> Unix.
</p>
<p>Если какой-то программе нужен доступ к Tor ControlSocket, добавьте следующие строки к файлу <code>torrc</code>:
</p>
<pre>ControlSocket /var/lib/tor/control_socket
ControlSocketsGroupWritable 1
DataDirectoryGroupReadable 1
CacheDirectoryGroupReadable 1             # обходное решение для бага #26913
</pre>
<p>Добавьте запускающего программу пользователя в группу <code>tor</code>:
</p>
<pre># usermod -a -G tor <i>пользователь</i>
</pre>
<p>Перезагрузите настройки группы:
</p>
<pre>$ newgrp tor
</pre>
<p>Затем <a href="/title/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Перезапустите">перезапустите</a> Tor
</p>
<pre># systemctl restart tor
</pre>
<p>и перезапустите программу.
</p>
<p>Чтобы проверить состояние контрольного сокета, выполните
</p>
<pre># stat -c%a /var/lib/tor /var/lib/tor/control_socket
</pre>
<p>Команда должна вывести значения <code>750</code> и <code>660</code>.
</p>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_Tor_Control"></span><span class="mw-headline" id="Проверка_Tor_Control">Проверка Tor Control</span>
</h4>
<p>Чтобы проверить настройки ControlPort, используйте входящую в пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=gnu-netcat">gnu-netcat</a></span> утилиту <i>nc</i>:
</p>
<pre>$ echo -e 'PROTOCOLINFO\r\n' | nc 127.0.0.1 9051
</pre>
<p>Также запустите <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=socat">socat</a></span>:
</p>
<pre>$ echo -e 'PROTOCOLINFO\r\n' | sudo -u <i>пользователь</i> socat - UNIX-CLIENT:/var/lib/tor/control_socket
</pre>
<p>Обе команды должны вывести
</p>
<pre>250-PROTOCOLINFO 1
250-AUTH METHODS=COOKIE,SAFECOOKIE,HASHEDPASSWORD COOKIEFILE="/var/lib/tor/control_auth_cookie"
250-VERSION Tor="0.3.4.8"
250 OK
514 Authentication required.
</pre>
<p>Дополнительную информацию можно найти в описании <a rel="nofollow" class="external text" href="https://gitweb.torproject.org/torspec.git/tree/control-spec.txt">протокола Tor Control</a>.
</p>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_Tor_.D0.B2_Chroot"></span><span class="mw-headline" id="Запуск_Tor_в_Chroot">Запуск Tor в Chroot</span>
</h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Подключение по telnet на локальный ControlPort окажется невозможным, если Tor был запущен в chroot.</div>
<p>По соображениям безопасности желательно запускать Tor в <a href="/title/Chroot_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Chroot (Русский)">chroot</a>. Следующий скрипт создаст подходящее окружение chroot в каталоге <code>/opt/torchroot</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/torchroot-setup.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash
export TORCHROOT=/opt/torchroot

mkdir -p $TORCHROOT
mkdir -p $TORCHROOT/etc/tor
mkdir -p $TORCHROOT/dev
mkdir -p $TORCHROOT/usr/bin
mkdir -p $TORCHROOT/usr/lib
mkdir -p $TORCHROOT/usr/share/tor
mkdir -p $TORCHROOT/var/lib
mkdir -p $TORCHROOT/var/log/tor/

ln -s /usr/lib  $TORCHROOT/lib
cp /etc/hosts           $TORCHROOT/etc/
cp /etc/host.conf       $TORCHROOT/etc/
cp /etc/localtime       $TORCHROOT/etc/
cp /etc/nsswitch.conf   $TORCHROOT/etc/
cp /etc/resolv.conf     $TORCHROOT/etc/

cp /usr/bin/tor         $TORCHROOT/usr/bin/
cp /usr/share/tor/geoip* $TORCHROOT/usr/share/tor/
cp /lib/libnss* /lib/libnsl* /lib/ld-linux-*.so* /lib/libresolv* /lib/libgcc_s.so* $TORCHROOT/usr/lib/
cp $(ldd /usr/bin/tor | awk '{print $3}'|grep --color=never "^/") $TORCHROOT/usr/lib/

## /var/log/tor/notices.log необходим только в том случае, если вы запускаете hidden service
# cp /var/log/tor/notices.log $TORCHROOT/var/log/tor/

cp -r /var/lib/tor      $TORCHROOT/var/lib/
cp /etc/tor/torrc       $TORCHROOT/etc/tor/

chown tor:tor $TORCHROOT
chmod 700 $TORCHROOT
chown -R tor:tor $TORCHROOT/var/lib/tor
chown -R tor:tor $TORCHROOT/var/log/tor

sh -c "grep --color=never ^tor /etc/passwd &gt; $TORCHROOT/etc/passwd"
sh -c "grep --color=never ^tor /etc/group &gt; $TORCHROOT/etc/group"

mknod -m 644 $TORCHROOT/dev/random c 1 8
mknod -m 644 $TORCHROOT/dev/urandom c 1 9
mknod -m 666 $TORCHROOT/dev/null c 1 3

if [[ "$(uname -m)" == "x86_64" ]]; then
  cp /usr/lib/ld-linux-x86-64.so* $TORCHROOT/usr/lib/.
  ln -sr /usr/lib64 $TORCHROOT/lib64
  ln -s $TORCHROOT/usr/lib ${TORCHROOT}/usr/lib64
fi
</pre>
<p>Выполнив скрипт от пользователя root, вы можете запустить Tor в окружении chroot командой:
</p>
<pre># chroot --userspec=tor:tor /opt/torchroot /usr/bin/tor
</pre>
<p>Или же, если вы используете systemd, то можете создать <a href="/title/Drop-in_%D1%84%D0%B0%D0%B9%D0%BB" class="mw-redirect" title="Drop-in файл">drop-in файл</a> для службы <code>tor.service</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/chroot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=root
ExecStart=
ExecStart=/usr/bin/sh -c "chroot --userspec=tor:tor /opt/torchroot /usr/bin/tor -f /etc/tor/torrc"
KillSignal=SIGINT
</pre>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_Tor_.D0.B2_.D0.BA.D0.BE.D0.BD.D1.82.D0.B5.D0.B9.D0.BD.D0.B5.D1.80.D0.B5_systemd-nspawn"></span><span class="mw-headline" id="Запуск_Tor_в_контейнере_systemd-nspawn">Запуск Tor в контейнере systemd-nspawn</span>
</h2>
<p>В этом примере мы создадим контейнер systemd-nspawn с виртуальным сетевым macvlan-интерфейсом. Контейнер будет называться <code>tor-exit</code>.
</p>
<p>В статьях <a href="/title/Systemd-nspawn" title="Systemd-nspawn">systemd-nspawn</a> и <a href="/title/Systemd-networkd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Systemd-networkd (Русский)">systemd-networkd</a> можно найти полную информацию о работе и настройке соответствующих программ.
</p>
<h3>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0_.D0.B8_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D1.85.D0.BE.D1.81.D1.82.D0.B0"></span><span class="mw-headline" id="Установка_и_настройка_хоста">Установка и настройка хоста</span>
</h3>
<p>Контейнер будет размещаться в каталоге <code>/srv/container</code>:
</p>
<pre># mkdir -p /srv/container/tor-exit
</pre>
<p><a href="/title/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=arch-install-scripts">arch-install-scripts</a></span>, чтобы получить доступ к утилите <i>pacstrap</i>.
</p>
<p>С помощью <i>pacstrap</i> установите в каталог контейнера пакеты <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=base">base</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tor">tor</a></span> и <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> (подробнее см. статью об <a href="/title/Systemd-nspawn#Create_and_boot_a_minimal_Arch_Linux_container" title="Systemd-nspawn">установке Arch Linux в контейнер</a>):
</p>
<pre># pacstrap -сi /srv/container/tor-exit base tor nyx
</pre>
<p>Если зарегистрировать контейнер на хосте, то в дальнейшем с ним можно будет взаимодействовать извне с помощью команды <code>machinectl</code>. Для этого необходимо создать символическую ссылку на контейнер в каталоге <code>/var/lib/container/</code>. Создайте каталог, если он отсутствует:
</p>
<pre># mkdir -p /var/lib/container
</pre>
<p>и поместите в него символическую ссылку на контейнер (см. <a href="/title/Systemd-nspawn#Management" title="Systemd-nspawn">systemd-nspawn#Management</a>):
</p>
<pre># ln -s /srv/container/tor-exit /var/lib/container/tor-exit
</pre>
<h4>
<span id=".D0.92.D0.B8.D1.80.D1.82.D1.83.D0.B0.D0.BB.D1.8C.D0.BD.D1.8B.D0.B9_.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D0.BE.D0.B9_.D0.B8.D0.BD.D1.82.D0.B5.D1.80.D1.84.D0.B5.D0.B9.D1.81"></span><span class="mw-headline" id="Виртуальный_сетевой_интерфейс">Виртуальный сетевой интерфейс</span>
</h4>
<p>Создайте drop-in-файл настроек контейнера:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/nspawn/tor-exit.nspawn</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
MACVLAN=<i>интерфейс</i>

[Exec]
LimitNOFILE=32768</pre>
<p>Опция <code>MACVLAN=<i>интерфейс</i></code> создаёт macvlan-интерфейс с названием <code>mv-<i>интерфейс</i></code> и привязывает его к контейнеру, подробнее см. <a href="/title/Systemd-nspawn#Use_a_%22macvlan%22_or_%22ipvlan%22_interface" title="Systemd-nspawn">systemd-nspawn#Use a "macvlan" or "ipvlan" interface</a>. Это полезно с точки зрения безопасности, поскольку контейнеру можно назначить приватный IP-адрес, а настоящий адрес машины из контейнера виден не будет. Так можно, например, скрыть DNS-запросы.
</p>
<p>Опция <code>LimitNOFILE=32768</code> позволит открывать большее <a href="#%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9">#Количество соединений</a> одновременно.
</p>
<p>Наконец, сохраните сетевые настройки <a href="/title/Systemd-networkd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Systemd-networkd (Русский)">systemd-networkd</a> в файле <code>/srv/container/tor-exit/etc/systemd/network/mv-<i>интерфейс</i>.network</code>.
</p>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B8_.D0.B2.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_systemd-nspawn"></span><span class="mw-headline" id="Запуск_и_включение_systemd-nspawn">Запуск и включение systemd-nspawn</span>
</h4>
<p><a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5/%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>systemd-nspawn@tor-exit.service</code>.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BD.D1.82.D0.B5.D0.B9.D0.BD.D0.B5.D1.80.D0.B0"></span><span class="mw-headline" id="Настройка_контейнера">Настройка контейнера</span>
</h3>
<p>Чтобы войти в контейнер, выполните (см. <a href="/title/Systemd-nspawn#machinectl" title="Systemd-nspawn">systemd-nspawn#machinectl</a>):
</p>
<pre># machinectl login tor-exit
</pre>
<p>Если выполнить вход не удаётся, см. <a href="/title/Systemd-nspawn#Root_login_fails" title="Systemd-nspawn">systemd-nspawn#Root login fails</a>.
</p>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B8_.D0.B2.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_systemd-networkd"></span><span class="mw-headline" id="Запуск_и_включение_systemd-networkd">Запуск и включение systemd-networkd</span>
</h4>
<p><a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5/%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>systemd-networkd.service</code>. Команда <code>networkctl</code> отобразит список сетевых интерфейсов контейнера, если <code>systemd-networkd</code> настроен корректно.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_Tor"></span><span class="mw-headline" id="Настройка_Tor">Настройка Tor</span>
</h3>
<p>Смотри раздел <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0_Tor">#Запуск сервера Tor</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Файлы контейнера удобнее редактировать с хоста, вашим любимым редактором.</div>
<h2>
<span id=".D0.92.D0.B5.D0.B1-.D1.81.D1.91.D1.80.D1.84.D0.B8.D0.BD.D0.B3"></span><span class="mw-headline" id="Веб-сёрфинг">Веб-сёрфинг</span>
</h2>
<p>Единственный способ оставаться анонимным при просмотре страниц в интернете — использовать <i>Tor Browser Bundle</i>, который использует пропатченную версию <a href="/title/Firefox_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Firefox (Русский)">Firefox</a>. Его можно установить с пакетом <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=torbrowser-launcher">torbrowser-launcher</a></span> или <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/tor-browser/">tor-browser</a></span><sup><small>AUR</small></sup>.
</p>
<p>Также можно использовать Tor с обычными браузерами: в разделах <a href="#Firefox">#Firefox</a> и <a href="#Chromium">#Chromium</a> объясняется, как настроить их на работу через Tor. Обратите внимание, что даже в режиме приватного просмотра это не гарантирует анонимности: отпечатки, плагины, DNS-утечки и прочие дефекты могут стать причиной разглашения вашего IP-адреса или личности <a rel="nofollow" class="external autonumber" href="https://www.torproject.org/docs/faq.html.en#TBBOtherBrowser">[2]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Чтобы makepkg мог проверить подпись загруженного из AUR tar-архива с исходниками <i>Tor Browser</i>, импортируйте <a rel="nofollow" class="external text" href="https://www.torproject.org/docs/signing-keys.html.en">ключи подписей Tor Project</a> по инструкции из статьи <a href="/title/GnuPG#Use_a_keyserver" title="GnuPG">GnuPG#Use a keyserver</a>.</div>
<h3><span class="mw-headline" id="Firefox">Firefox</span></h3>
<p><i>Preferences &gt; General &gt; Network Settings &gt; Settings...</i> , выберите пункт <i>Manual proxy configuration</i>, после чего укажите: SOCKS Host <code>localhost</code> на порте <code>9050</code> (SOCKS v5). Чтобы перенаправить все DNS-запросы в сеть Tor, выберите пункт <i>Proxy DNS when using SOCKS v5</i>.
</p>
<h3><span class="mw-headline" id="Chromium">Chromium</span></h3>
<p>Запустите Chromium:
</p>
<pre>$ chromium --proxy-server="socks5://<i>мой-прокси</i>:8080" --host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE <i>мой-прокси</i>"
</pre>
<p>Флаг <code>--proxy-server="socks5://<i>мой-прокси</i>:8080"</code> означает, что все <code>http://</code> и <code>https://</code> запросы будут посылаться через прокси-сервер <code>"<i>мой-прокси</i>:8080"</code> посредством протокола SOCKS пятой версии. Разрешение имён для этих запросов будет выполняться прокси-сервером, а не браузером локально.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Проксирование <code>ftp://</code> через SOCKS-прокси на данный момент не реализовано <a rel="nofollow" class="external autonumber" href="https://www.chromium.org/developers/design-documents/network-stack/socks-proxy">[3]</a>.</div>
<p>Флаг <code>--proxy-server</code> влияет только на загрузку URL-страниц. Однако в Chromium есть и другие компоненты, которые могут попытаться выполнить DNS-разрешение напрямую. Наиболее важный их этих компонентов — <i>DNS-prefetcher</i>. Если DNS-prefetcher не отключён, то браузер будет посылать DNS-запросы напрямую, минуя SOCKS5-сервер. Prefetcher и другие компоненты можно отключить, но такой подход неудобен и ненадёжен, поскольку придётся отслеживать каждый элемент Chromium, который может захотеть  посылать DNS-запросы самостоятельно.
</p>
<p>Для комплексного решения этой проблемы используется флаг <code>--host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE <i>мой-прокси</i>"</code>, который представляет собой ловушку для посылаемых через обычную сеть DNS-запросов. Каждое выполяемое локально разрешение DNS теперь будет привязано к (нерабочему) адресу  <code>~NOTFOUND</code> (можно представить его как адрес <code>0.0.0.0</code>). Указание <code>"EXCLUDE"</code> создаёт исключение для прокси-сервера <code>"<i>мой-прокси</i>"</code>, потому что без этого Chromium не сможет выполнять разрешение адреса самого прокси-сервера SOCKS и все запросы будут завершаться неудачей с ответом <code>PROXY_CONNECTION_FAILED</code>.
</p>
<p>Также, чтобы предотвратить <a rel="nofollow" class="external text" href="https://ipleak.net/#webrtcleak">утечки WebRTC</a>, можно установить расширение браузера <a rel="nofollow" class="external text" href="https://chrome.google.com/webstore/detail/webrtc-network-limiter/npeicpdbkakmehahjeeohfdhnlpdklia">WebRTC Network Limiter</a>.
</p>
<h4>
<span id=".D0.9E.D1.82.D0.BB.D0.B0.D0.B4.D0.BA.D0.B0"></span><span class="mw-headline" id="Отладка">Отладка</span>
</h4>
<p>В случае возникновения каких-либо проблем в первую  очередь нужно проверить настройки прокси, введя адрес <code>chrome://net-internals/#proxy</code>.
</p>
<p>Затем нужно изучить вкладку настроек DNS, чтобы убедиться, что Chromium не выполняет локальное разрешение DNS: <code>chrome://net-internals/#dns</code>.
</p>
<h4>
<span id=".D0.A0.D0.B0.D1.81.D1.88.D0.B8.D1.80.D0.B5.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Расширения">Расширения</span>
</h4>
<p>Как и для Firefox, вы можете установить удобный переключатель прокси вроде <a rel="nofollow" class="external text" href="https://chrome.google.com/webstore/detail/dpplabbmogkhghncfbfdeeokoefdjegm">Proxy SwitchySharp</a>.
</p>
<p>После установки перейдите на его панель настроек. Под вкладкой <i>Proxy Profiles</i> добавьте новый профиль <i>Tor</i>, уберите отметку с опции <i>Use the same proxy server for all protocols</i>, затем добавьте <i>localhost</i> в качестве хоста SOCKS, порт <i>9050</i>, и выберите <i>SOCKS v5</i>.
</p>
<p>При желании можно включить опцию быстрого переключения на вкладке настроек <i>General</i>. Тогда переключаться между нормальной навигацией и сетью Tor можно будет одним кликом на иконке Proxy SwitchySharp.
</p>
<h3><span class="mw-headline" id="Luakit">Luakit</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Вас будет легко опознать по редкой строке <code>user-agent</code>; также могут возникнуть проблемы с Flash, JavaScript и т.д.</div>
<p>Выполните:
</p>
<pre>$ torsocks luakit
</pre>
<h2>
<span id="HTTP-.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8"></span><span class="mw-headline" id="HTTP-прокси">HTTP-прокси</span>
</h2>
<p>В Tor может работать через встроенный туннелированный HTTP-прокси или сторонний прокси вроде <a href="/title/Privoxy" title="Privoxy">Privoxy</a>. Тем не менее, разработчики Tor рекомендуют использовать библиотеку SOCKS5, если ваш браузер её поддерживает.
</p>
<h3><span class="mw-headline" id="Tor">Tor</span></h3>
<p>Добавьте следующую строку в файл <code>torrc</code>, чтобы использовать порт <code>8118</code> на <code>localhost</code> в качестве http-прокси:
</p>
<pre>HTTPTunnelPort 127.0.0.1:8118
</pre>
<p>Подробнее смотрите <a rel="nofollow" class="external text" href="https://www.torproject.org/docs/tor-manual.html.en#HTTPTunnelPort">руководство Tor</a>.
</p>
<h3><span class="mw-headline" id="Firefox_2">Firefox</span></h3>
<p>Расширение браузера <a rel="nofollow" class="external text" href="https://addons.mozilla.org/firefox/addon/foxyproxy-standard/">FoxyProxy</a> позволяет назначить прокси-сервер как для всех HTTP-запросов в целом, так и для обращения по отдельным веб-адресам. После установки расширения перезапустите браузер и вручную настройте использование прокси по адресу <code>localhost:8118</code>, где должен работать <a href="/title/Polipo" title="Polipo">Polipo</a> или <a href="/title/Privoxy" title="Privoxy">Privoxy</a>. Эти настройки находятся в меню <i>Add &gt; Standard proxy type</i>. Выберите метку прокси-сервера (например, <code>Tor</code>) и введите хост и порт в поля <i>HTTP Proxy</i> и <i>SSL Proxy</i>. Для проверки правильности работы Tor посетите страницу <a rel="nofollow" class="external text" href="https://check.torproject.org/">Tor Check</a>.
</p>
<h3><span class="mw-headline" id="Polipo">Polipo</span></h3>
<p>Командой The Tor Project был создан стандартный <a rel="nofollow" class="external text" href="https://gitweb.torproject.org/torbrowser.git/plain/build-scripts/config/polipo.conf?id=1ffcd9dafb9dd76c3a29dd686e05a71a95599fb5">файл настроек</a> Polipo, чтобы избежать возможных проблем и обеспечить анонимность пользователей.
</p>
<p>Обратите внимание, что если вы можете использовать SOCKS5-прокси, который Tor запускает автоматически на порте <code>9050</code>, то нет необходимости использовать Polipo. Если вы хотите использовать Chromium в связке с Tor, то Polipo тоже не требуется (см. <a href="#Chromium">#Chromium</a>).
</p>
<h3><span class="mw-headline" id="Privoxy">Privoxy</span></h3>
<p>Privoxy можно использовать для обмена сообщениями (<a href="/title/Jabber" class="mw-redirect" title="Jabber">Jabber</a>, <a href="/title/IRC" class="mw-redirect" title="IRC">IRC</a>) и других приложений. Приложения, которые поддерживают HTTP-прокси, можно подключить к Privoxy (например, на адрес <code>127.0.0.1:8118</code>). Чтобы использовать SOCKS-прокси, направьте ваше приложение в Tor (адрес <code>127.0.0.1:9050</code>). Следует иметь в виду, что приложение может самостоятельно выполнять DNS-разрешение, что приведет к утечке информации. В этом случае можно попробовать использовать SOCKS4A (например, с Privoxy).
</p>
<h2>
<span id=".D0.9E.D0.B1.D0.BC.D0.B5.D0.BD_.D0.BC.D0.B3.D0.BD.D0.BE.D0.B2.D0.B5.D0.BD.D0.BD.D1.8B.D0.BC.D0.B8_.D1.81.D0.BE.D0.BE.D0.B1.D1.89.D0.B5.D0.BD.D0.B8.D1.8F.D0.BC.D0.B8"></span><span class="mw-headline" id="Обмен_мгновенными_сообщениями">Обмен мгновенными сообщениями</span>
</h2>
<p>Для использования мессенджера через Tor не нужен HTTP-прокси вроде <a href="/title/Polipo" title="Polipo">Polipo</a>/<a href="/title/Privoxy" title="Privoxy">Privoxy</a>. Мы используем напрямую демон Tor, по умолчанию прослушивающий порт 9050.
</p>
<h3><span class="mw-headline" id="Pidgin">Pidgin</span></h3>
<p><a href="/title/Pidgin" title="Pidgin">Pidgin</a> можно настроить на работу через Tor глобально или для отдельных аккаунтов. Для глобальных настроек используйте пункт меню <i>Tools -&gt; Preferences -&gt; Proxy</i>. Чтобы настроить использование Tor для одного аккаунта, перейдите в <i>Accounts &gt; Manage Accounts</i>, выберите нужный аккаунт, нажмите <i>Modify</i>, после чего на вкладке <i>Proxy</i> укажите следующие параметры:
</p>
<pre>Proxy type SOCKS5
Host 127.0.0.1
Port 9150
</pre>
<p>Заметьте, что <a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/ticket/8135">в 2013 году</a> значение Port для Tor Browser Bundle изменилось с 9050 на 9150. Если вы получили ошибку <i>Connection refused</i>, попробуйте изменить номер порта на прежний.
</p>
<h3><span class="mw-headline" id="Irssi">Irssi</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="/title/File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="/title/File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> <code>cap_sasl.pl</code> сломался с обновлением <i>perl</i> 5.20; кроме того, SSL не работает с <code>torsocks</code>. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/title/Talk:Tor_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)">Talk:Tor (Русский)#</a>)</div>
</div>
<p>Freenode рекомендует подключаться напрямую к <code>.onion</code>. Для этого также потребуется charybdis и механизм ircd-seven's SASL для идентификации сервером имён (nickserv) в процессе соединения; подробности можно найти в статье <a href="/title/Irssi#Authenticating_with_SASL" title="Irssi">Irssi#Authenticating with SASL</a>. Запустите irssi:
</p>
<pre>$ torsocks irssi
</pre>
<p>Задайте ваши индентификационные данные для сервиса <a href="https://en.wikipedia.org/wiki/ru:IRC-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B" class="extiw" title="wikipedia:ru:IRC-сервисы">nickserv</a>, которые будут считываться при создании соединения. Поддерживаются механизмы аутентификации ECDSA-NIST256P-CHALLENGE (см. <a rel="nofollow" class="external text" href="https://github.com/kaniini/ecdsatool/blob/master/example-for-cap_sasl.pl">ecdsatool</a>) и PLAIN. DH-BLOWFISH больше <a rel="nofollow" class="external text" href="https://freenode.net/kb/answer/irssi">не поддерживается</a>.
</p>
<pre>/sasl set <i>сеть</i> <i>имя-пользователя</i> <i>пароль</i> <i>механизм</i>
</pre>
<p>Отключите CTCP и DCC и задайте фальшивое имя хоста, чтобы чтобы скрыть настоящее <a rel="nofollow" class="external autonumber" href="https://encrypteverything.ca/IRC_Anonymity_Guide">[4]</a>:
</p>
<pre>/ignore * CTCPS
/ignore * DCC
/set hostname <i>фальшивый_хост</i>
</pre>
<p>Подключитесь к Freenode:
</p>
<pre>/connect -network <i>сеть</i> freenodeok2gncmy.onion
</pre>
<p>Дополнительную информацию можно найти в статьях <a rel="nofollow" class="external text" href="https://freenode.net/kb/answer/chat#accessing-freenode-via-tor">Accessing freenode Via Tor</a>, <a rel="nofollow" class="external text" href="https://freenode.net/kb/answer/sasl">SASL README</a> или <a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO/IrcSilc">IRC/SILC Wiki article</a>.
</p>
<h2><span class="mw-headline" id="Pacman">Pacman</span></h2>
<p>Через сеть Tor можно выполнять загрузочные операции <a href="/title/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Pacman (Русский)">pacman</a> — синхронизировать базы данных репозиториев, скачивать пакеты и открытые ключи.
</p>
<p>Преимущества:
</p>
<ul>
<li>Если кто-то отслеживает Интернет-соединение вашей машины, то он не увидит выполняемые обновления. Соответственно, нельзя будет определить, какие пакеты установлены, какие из них устарели и как часто выполяется обновление. Но следует учитывать, что атакующий всё ещё может опознать используемое программное обеспечение и узнать его версию другими способами. Например, проанализировав исходящие пакеты вашего HTTP-сервера и просканировав его порт можно будет определить, что а) это работающий HTTP-сервер и б) его версию.</li>
<li>Если зеркало для скачивания находится не в onion-домене, то скомпроментированный выходной узел может обнаружить попытку обновления и решить атаковать вашу машину. Однако при этом атакующий скорее всего не будет знать, какую именно машину он атакует.</li>
<li>Атакующий может попытаться убедить вашу машину, что доступных обновлений нет, чтобы не позволить применить обновления безопасности. При обновлении через Tor сделать это будет крайне непросто, поскольку в анонимной сети почти невозможно определить конкретно вашу машину.</li>
</ul>
<p>Недостатки:
</p>
<ul><li>Более длительное время обновления из-за высокого значения задержки и низкой пропускной способности сети Tor. Это может быть значительным недостатком с точки зрения безопасности, если обновление нужно выполнить как можно быстрее, особенно на машинах, непосредственно подключённых к сети Интернет. Например, если уязвимость серьёзная и её легко обнаружить и использовать, то злоумышленники часто стараются атаковать как можно больше уязвимых систем  максимально быстро, чтобы успеть до применения обновлений безопасности.</li></ul>
<p>Надёжность обновлений через Tor:
</p>
<ul>
<li>Не нужно использовать DNS.</li>
<li>Вы зависите от состояния сети Tor и особенно выходных узлов (например, они могут блокировать обновления).</li>
<li>Вы зависите от правильной работы демона Tor. Например, если на диске закончилось свободное место, то демон Tor может отказать работать. "Reserved blocks gid:" в ext4, квоты на использование дискового пространства и некоторые другие меры помогут решить эту проблему.</li>
<li>Если вы находитесь в стране, где Tor блокируется, или в которой почти или совсем нет пользователей Tor, то вам придётся использовать мост (Tor bridge).</li>
</ul>
<p>Замечание по поводу gpg:
</p>
<p>Pacman считает надёжными только те ключи, которые подписаны либо лично вами (делается командой <code>pacman-key --lsign-key</code>), либо тремя из пяти мастер-ключей Arch. Если вредоносная выходная нода попробует заменить пакет на другой, подписаный её ключом, pacman не позволит пользователю установить такой пакет.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Для других дистрибутивов на основе Arch, а также неофициальных репозиториев и AUR это утверждение может оказаться неверным.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pacman.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
XferCommand = /usr/bin/curl --socks5-hostname localhost:9050 --continue-at - --fail --output %o %u
...
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Во время обработки подписей баз данных иногда можно получить ошибку 404. Это зависит от <a href="/title/Pacman/%D0%9F%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D1%8C_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%B0#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_pacman" class="mw-redirect" title="Pacman/Подпись пакета">настроек pacman</a> и как правило безвредно.
</div>
<h2><span class="mw-headline" id="Java">Java</span></h2>
<p>Чтобы заставить приложение Java <a rel="nofollow" class="external text" href="https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">проксировать</a> все соединения через Tor, задайте следующую опцию командной строки:
</p>
<pre>export JAVA_OPTIONS="$JAVA_OPTIONS -DsocksProxyHost=localhost -DsocksProxyPort=9050"
</pre>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0_Tor"></span><span class="mw-headline" id="Запуск_сервера_Tor">Запуск сервера Tor</span>
</h2>
<p>Сеть Tor существует благодаря пользователям, которые создают и обслуживают узлы сети, предлагая свою пропускную способность, и запускают onion-сервисы. Есть несколько способов внести свой вклад в работу сети.
</p>
<h3>
<span id=".D0.9C.D0.BE.D1.81.D1.82"></span><span class="mw-headline" id="Мост">Мост</span>
</h3>
<p>Мост Tor (Tor bridge) — передающий узел сети, адрес которого не содержится в открытом каталоге узлов Tor. По этой причине мост останется доступным для желающих подключиться к Tor, даже если правительство или интернет-провайдер блокирует все публичные передатчики. На странице <a rel="nofollow" class="external free" href="https://bridges.torproject.org/">https://bridges.torproject.org/</a> объясняется, как узнать адреса мостов.
</p>
<p>Для запуска моста файл <code>torrc</code> должен содержать только следующие четыре строки (см. также <a rel="nofollow" class="external autonumber" href="https://2019.www.torproject.org/docs/bridges#RunningABridge">[5]</a>):
</p>
<pre>SocksPort 0
ORPort 443
BridgeRelay 1
Exitpolicy reject *:*
</pre>
<h3>
<span id=".D0.9F.D0.B5.D1.80.D0.B5.D0.B4.D0.B0.D1.8E.D1.89.D0.B8.D0.B9_.D1.83.D0.B7.D0.B5.D0.BB"></span><span class="mw-headline" id="Передающий_узел">Передающий узел</span>
</h3>
<p>В режиме передатчика (relay) ваша машина будет работать в качестве входного (guard relay) или промежуточного (middle relay) узла сети. В отличие от моста, адрес передающей машины будет опубликован в каталоге узлов Tor. Задача передающего узла заключается в пересылке пакетов к другим передатчикам или выходным узлам, но не в сеть Интернет.
</p>
<p>Файл настроек передающего узла с пропускной способностью не менее 20 Кбит/с должен выглядеть так:
</p>
<pre>Nickname <i>название-узла-Tor</i>
ORPort 9001                    # Этот TCP-порт должен быть открыт или проброшен в вашем сетевом экране
BandwidthRate 20 KB            # Ограничить скорость передачи величиной 20 Kбит/с
BandwidthBurst 50 KB           # Но разрешить пиковые значения до 50 Kбит/с
ExitPolicy reject *:*          # Запретить отправку пакетов в обычную сеть
</pre>
<h3>
<span id=".D0.92.D1.8B.D1.85.D0.BE.D0.B4.D0.BD.D0.BE.D0.B9_.D1.83.D0.B7.D0.B5.D0.BB"></span><span class="mw-headline" id="Выходной_узел">Выходной узел</span>
</h3>
<p>Чтобы запрос из сети Tor попал в обычную сеть Интернет, необходим выходной узел (exit relay). Важно понимать, что кто бы ни посылал запрос, для получателя всё будет выглядеть так, будто отправителем является именно выходной узел. Поэтому запуск выходной ноды считается наименее безопасным с точки зрения законности. Если вы размышляете над запуском выходного узла, то стоит изучить <a rel="nofollow" class="external text" href="https://blog.torproject.org/tips-running-exit-node">советы и рекомендации</a> от создателей проекта.
</p>
<h4>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_2"></span><span class="mw-headline" id="Настройка_2">Настройка</span>
</h4>
<p>В файле <code>torrc</code> можно настроить перечень разрешённых на выходном узле сервисов. Например, разрешить весь трафик:
</p>
<pre>ExitPolicy accept *:*
</pre>
<p>Разрешить только соединения через IRC-порты 6660-6667 и запретить всё остальное:
</p>
<pre>ExitPolicy accept *:6660-6667,reject *:*
</pre>
<p>По умолчанию Tor настроен блокировать определённые порты. В файле <code>torrc</code> можно внести корректировки в этот список:
</p>
<pre>ExitPolicy accept *:119
</pre>
<h4>
<span id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B8_100-.D0.BC.D0.B5.D0.B3.D0.B0.D0.B1.D0.B8.D1.82.D0.BD.D0.BE.D0.B3.D0.BE_.D0.B2.D1.8B.D1.85.D0.BE.D0.B4.D0.BD.D0.BE.D0.B3.D0.BE_.D1.83.D0.B7.D0.BB.D0.B0"></span><span class="mw-headline" id="Пример_настройки_100-мегабитного_выходного_узла">Пример настройки 100-мегабитного выходного узла</span>
</h4>
<p>Ниже даны рекомендации по настройке быстрого (более 100 Мбит/с) выходного узла Tor, на котором устанавливается межсетевой экран <a href="/title/Iptables_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Iptables (Русский)">iptables</a>, <a href="/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Haveged (Русский)">Haveged</a> для повышения энтропии системы и DNS-кэш <a href="/title/Pdnsd" title="Pdnsd">pdnsd</a>. Настоятельно рекомендуется <i>предварительно</i> изучить статью <a rel="nofollow" class="external text" href="https://community.torproject.org/relay/setup/exit/">о настройке выходного узла</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> В разделе <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B5_systemd-nspawn">#Запуск Tor в контейнере systemd-nspawn</a> описана установка Tor в контейнер <code>systemd-nspawn</code>. <a href="/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Haveged (Русский)">Haveged</a> должен быть установлен на хосте.</div>
<h5><span class="mw-headline" id="Tor_2">Tor</span></h5>
<h6>
<span id=".D0.9A.D0.BE.D0.BB.D0.B8.D1.87.D0.B5.D1.81.D1.82.D0.B2.D0.BE_.D1.81.D0.BE.D0.B5.D0.B4.D0.B8.D0.BD.D0.B5.D0.BD.D0.B8.D0.B9"></span><span class="mw-headline" id="Количество_соединений">Количество соединений</span>
</h6>
<p>По умолчанию, Tor может обрабатывать до 8192 соединений одновременно. Можно увеличить это значение до 32768 <a rel="nofollow" class="external autonumber" href="https://www.torproject.org/docs/faq.html.en#PackagedTor">[6]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/increase-file-limits.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
LimitNOFILE=32768
</pre>
<p>Также нужно скорректировать системный параметр <code>nofile</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/security/limits.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
tor     soft    nofile    32768
tor     hard    nofile    32768
@tor    soft    nofile    32768
@tor    hard    nofile    32768
</pre>
<p>Узнать текущее значение <code>nofile</code> можно командой <code># sudo -u tor 'ulimit -Hn'</code> (или разбив её на две: <code># sudo -u tor bash</code> и <code># ulimit -Hn</code>).
</p>
<h6>
<span id=".D0.9F.D1.80.D0.B8.D0.B2.D0.B8.D0.BB.D0.B5.D0.B3.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.BD.D1.8B.D0.B5_.D0.BF.D0.BE.D1.80.D1.82.D1.8B"></span><span class="mw-headline" id="Привилегированные_порты">Привилегированные порты</span>
</h6>
<p>Чтобы разрешить Tor использовать привилегированные порты, службу <code>tor.service</code> нужно запускать от root. Не забудьте также добавить параметр <code>User tor</code> в файле <code>/etc/tor/torrc</code>, чтобы понизить привилегии после запуска.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/start-as-root.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=root
</pre>
<h6>
<span id=".D0.9A.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D1.8F"></span><span class="mw-headline" id="Конфигурация">Конфигурация</span>
</h6>
<p>Образец файла настроек выходного узла Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tor/torrc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">SocksPort 0                                       ## Обычный передатчик без использования локального прокси-сервера SOCKS

Log notice stdout                                 ## Стандартное поведение Tor

ControlPort 9051                                  ## Для соединения nyx
CookieAuthentication 1                            ## Для соединения nyx
DisableDebuggerAttachment 0                       ## Для соединения nyx

ORPort 443                                        ## Служба tor.service должна быть запущена от root

Address $IP                                       ## IP-адрес или FQDN
Nickname $NICKNAME                                ## Название узла

RelayBandwidthRate 500 Mbits                      ## bytes/KBytes/MBytes/GBytes/KBits/MBits/GBits
RelayBandwidthBurst 1000 MBits                    ## bytes/KBytes/MBytes/GBytes/KBits/MBits/GBits

ContactInfo $E-MAIL - $BTC-ADDRESS                ## Контактная информация

DirPort 80                                        ## Служба tor.service должна быть запущена от root
DirPortFrontPage /etc/tor/tor-exit-notice.html    ## Демонстрация веб-страницы на порте 80

MyFamily $($KEYID),$($KEYID)...                   ## Не забудьте знак $ перед keyid ;)

ExitPolicy reject XXX.XXX.XXX.XXX/XX:*            ## Заблокировать отдельный домен или IP-адрес в дополнение к стандартной политике

User tor                                          ## Изменяет пользователя на tor, если служба была запущена от root


### Производительность ###
AvoidDiskWrites 1                                 ## Уменьшение износа SSD
DisableAllSwap 1                                  ## Служба tor.service должна быть запущена от root
HardwareAccel 1                                   ## Использование аппаратной поддержки OpenSSL
NumCPUs 2                                         ## Запуск в двух потоках
</pre>
<p>Информацию об использованных здесь опциях можно найти в <a rel="nofollow" class="external text" href="https://www.torproject.org/docs/tor-manual.html.en">руководстве Tor</a>. 
</p>
<p>Tor по умолчанию запускает SOCKS-прокси на порте 9050 — даже если вы не не говорили ему этого делать. Укажите параметр <code>SocksPort 0</code>, если планируете использовать Tor только в качестве передатчика без запуска работающих через прокси-сервер локальных приложений.
</p>
<p><code>Log notice stdout</code> перенаправляет логи в поток стандартного вывода stdout, что тоже является настройкой Tor по умолчанию.
</p>
<p><code>ControlPort 9051</code>, <code>CookieAuthentication 1</code> и <code>DisableDebuggerAttachment 0</code> позволит использовать <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> для мониторинга.
</p>
<p><code>ORPort 443</code> и <code>DirPort 80</code> говорит Tor прослушивать порты 443 и 80, а <code>DirPortFrontPage</code> выводит <a rel="nofollow" class="external text" href="https://gitweb.torproject.org/tor.git/plain/contrib/operator-tools/tor-exit-notice.html">страницу приветствия</a> при установлении соединения на порте 80.
</p>
<p><code>ExitPolicy reject XXX.XXX.XXX.XXX/XX:*</code> позволяет заблокировать соединения с определённого адреса или домена; можно использовать для блокировки соседних с выходным узлом хостов, чтобы злоумышленник не смог воспользоваться ими для обхода правил сетевого экрана.
</p>
<p><code>AvoidDiskWrites 1</code> уменьшает количество записей на диск и износ SSD. <code>DisableAllSwap 1</code> заблокирует все текущие и будущие страницы памяти, чтобы её нельзя было выгрузить.
</p>
<p>Если команда <code>grep aes /proc/cpuinfo</code> возвращает какой-то результат, то ваш CPU поддерживает AES-инструкции. Если соответствующий модуль был загружен (<code>lsmod | grep aes</code>), то параметр <code>HardwareAccel 1</code> включит встроенное аппаратное ускорение шифрования <a rel="nofollow" class="external autonumber" href="https://www.torservers.net/wiki/setup/server#aes-ni_crypto_acceleration">[7]</a>.
</p>
<p><code>ORPort 443</code>, <code>DirPort 80</code> и <code>DisableAllSwap 1</code> требуют запуска службы Tor от root, как описано в разделе <a href="#%D0%9F%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5_%D0%BF%D0%BE%D1%80%D1%82%D1%8B">#Привилегированные порты</a>.
</p>
<h5><span class="mw-headline" id="nyx">nyx</span></h5>
<p>Если в файле <code>/etc/tor/torrc</code> указаны параметры <code>ControlPort 9051</code> и <code>CookieAuthentication 1</code>, то можно запустить <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> командой <code>sudo -u tor nyx</code>.
</p>
<p>Чтобы просматривать список соединений Tor с помощью <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span>, нужно также указать параметр <code>DisableDebuggerAttachment 0</code>.
</p>
<p>Чтобы запустить <code>nyx</code> от другого пользователя (не <code>tor</code>), изучите раздел <a href="#Cookie-%D1%84%D0%B0%D0%B9%D0%BB_Tor_Control">#Cookie-файл Tor Control</a>.
</p>
<h5><span class="mw-headline" id="iptables">iptables</span></h5>
<p>Установите и изучите работу с <a href="/title/Iptables_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Iptables (Русский)">iptables</a>. Вместо использования <a href="/title/Simple_stateful_firewall_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Simple stateful firewall (Русский)">экрана с контекстной фильтрацией</a>, которому на выходном узле пришлось бы отслеживать тысячи соединений, мы настроим межсетевой экран без отслеживания контекста.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">*raw
-A PREROUTING -j NOTRACK
-A OUTPUT -j NOTRACK
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p tcp ! --syn -j ACCEPT
-A INPUT -p udp -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -i lo -j ACCEPT
COMMIT
</pre>
<p><code>-A PREROUTING -j NOTRACK</code> и <code>-A OUTPUT -j NOTRACK</code> отключит отслеживание соединений в таблице <code>raw</code>.
</p>
<p><code>:INPUT DROP [0:0]</code> — цель (target) цепочки <code>INPUT</code> по умолчанию; отбрасывает входящий трафик, который не был отдельно разрешён опцией <code>ACCEPT</code>.
</p>
<p><code>:FORWARD DROP [0:0]</code> — цель цепочки <code>FORWARD</code> по умолчанию; используется для обычных маршрутизаторов, но не подходит для "луковых".
</p>
<p><code>:OUTPUT ACCEPT [0:0]</code> — цель цепочки <code>OUTPUT</code> по умолчанию; разрешает все исходящие соединения.
</p>
<p><code>-A INPUT -p tcp ! --syn -j ACCEPT</code> разрешает уже установленные по перечисленным ниже правилам входящие TCP соединения, а также TCP соединения от выходного узла.
</p>
<p><code>-A INPUT -p udp -j ACCEPT</code> разрешает все входящие UDP соединения, т.к. мы не используем отслеживание соединений (connection tracking).
</p>
<p><code>-A INPUT -p icmp -j ACCEPT</code> разрешает <a href="https://en.wikipedia.org/wiki/ru:ICMP" class="extiw" title="wikipedia:ru:ICMP">ICMP</a>-пакеты.
</p>
<p><code>-A INPUT -p tcp --dport 443 -j ACCEPT</code> разрешает входящие соединения на <code>ORPort</code>.
</p>
<p><code>-A INPUT -p tcp --dport 80 -j ACCEPT</code> разрешает входящие соединения на <code>DirPort</code>.
</p>
<p><code>-A INPUT -i lo -j ACCEPT</code> разрешает входящие соединения на петлевой интерфейс.
</p>
<h5><span class="mw-headline" id="Haveged">Haveged</span></h5>
<p>В статье <a href="/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Haveged (Русский)">Haveged</a> описано, как определить, генерирует ли ваша система достаточно энтропии для управления большим количеством OpenSSL соединений; документация и советы: <a rel="nofollow" class="external autonumber" href="https://www.issihosts.com/haveged/">[8]</a>, <a rel="nofollow" class="external autonumber" href="https://www.digitalocean.com/community/tutorials/how-to-setup-additional-entropy-for-cloud-servers-using-haveged">[9]</a>.
</p>
<h5><span class="mw-headline" id="pdnsd">pdnsd</span></h5>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Предполагается, что у вас доверенный (не цензурируемый) DNS-сервер.</div>
<p>Вы можете использовать <a href="/title/Pdnsd" title="Pdnsd">pdnsd</a> для локального кэширования DNS-запросов, тогда выходной узел сможет быстрее выполнять разрешение и посылать меньшее количество запросов внешнему DNS-серверу.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pdnsd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
perm_cache=102400                       ## (Значение по умолчанию)*100 = 1 Мбайт * 100 = 100 Мбайт
...
server {
    label= "resolvconf";
    file = "/etc/pdnsd-resolv.conf";    ## Чтобы не использовать файл /etc/resolv.conf
    timeout=4;                          ## Период ожидания ответа сервера; может быть значительно меньше, чем глобальное время ожидания
    uptest=query;                       ## Проверять доступность сервера, посылая пустые DNS-запросы
    query_test_name=".";                ## Используется, если удалённый сервер игнорирует пустые запросы
    interval=10m;                       ## Выполнять тестирование каждые 10 минут
    purge_cache=off;                    ## Игнорировать парамет TTL
    edns_query=yes;                     ## Использовать EDNS для исходящих запросов, чтобы разрешить UDP-сообщения длиннее 512 байт; может вызвать проблемы на некоторых устаревших системах
    preset=off;                         ## Перед проверкой состояния сервера предполагать, что он выключен
 }
...
</pre>
<p>Такая настройка позволит кэшировать локально до 100 Мбайт DNS-запросов.
</p>
<h6><span class="mw-headline" id="Uncensored_DNS">Uncensored DNS</span></h6>
<p>Если ваш обычный DNS-сервер каким-то образом цензурируется или работает нестабильно, в статье <a href="/title/Alternative_DNS_services" title="Alternative DNS services">Alternative DNS services</a> описаны альтернативные сервера; добавьте нужное в отдельный server-разделе файла <code>/etc/pdnsd.conf</code> (см. <a href="/title/Pdnsd#DNS_servers" title="Pdnsd">Pdnsd#DNS servers</a>).
</p>
<h2><span class="mw-headline" id="TorDNS">TorDNS</span></h2>
<p>Начиная с версий 0.2.x в Tor появился механизм перенаправления DNS-запросов. Чтобы его включить, добавьте строки ниже в файл настроек и <a href="/title/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Перезапустите">перезапустите</a> демон Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tor/torrc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">DNSPort 9053
AutomapHostsOnResolve 1
AutomapHostsSuffixes .exit,.onion
</pre>
<p>Теперь Tor будет принимать запросы на порт 9053 как обычный DNS-сервер и выполнять разрешение доменов через сеть Tor. К сожалению, через Tor выполняется разрешение только A-записей; MX и NS запросы будут проигнорированы. Дополнительную информацию можно найти в <a rel="nofollow" class="external text" href="https://techstdout.boum.org/TorDns/">документации TorDNS</a> для Debian.
</p>
<p>Кроме того, появилась возможность посылать DNS-запросы посредством командного интерпретатора, командой <code>tor-resolve</code>. Например:
</p>
<pre>$ tor-resolve archlinux.org
66.211.214.131
</pre>
<h3>
<span id=".D0.9F.D0.B5.D1.80.D0.B5.D0.BD.D0.B0.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_DNS-.D0.B7.D0.B0.D0.BF.D1.80.D0.BE.D1.81.D0.BE.D0.B2_.D1.87.D0.B5.D1.80.D0.B5.D0.B7_TorDNS"></span><span class="mw-headline" id="Перенаправление_DNS-запросов_через_TorDNS">Перенаправление DNS-запросов через TorDNS</span>
</h3>
<p>Вашу систему можно настроить посылать <i>все</i> запросы через TorDNS вне зависимости от того, используется ли Tor для соединения с конечной целью. Для этого настройте систему использовать адрес <code>127.0.0.1</code> в качестве DNS-сервера и отредактируйте строку <code>DNSPort</code> в файле <code>/etc/tor/torrc</code>:
</p>
<pre>DNSPort 53
</pre>
<p>Альтернативное решение — использовать локальный кэширующий DNS-сервер, вроде <a href="/title/Dnsmasq" title="Dnsmasq">dnsmasq</a> или <a href="/title/Pdnsd" title="Pdnsd">pdnsd</a>. Кэш DNS позволит несколько компенсировать низкую скорость TorDNS по сравнению с обычными DNS-серверами. Далее приведены инструкции по настройке <i>dnsmasq</i>.
</p>
<p><a href="/title/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnsmasq">dnsmasq</a></span> и укажите Tor прослушивать DNS запросы на порте 9053.
</p>
<p>Задайте следующую конфигурацию dnsmasq:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dnsmasq.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">no-resolv
port=53
server=127.0.0.1#9053
listen-address=127.0.0.1
</pre>
<p>Теперь dnsmasq будет ожидать локальных запросов и использовать TorDNS в качестве посредника. Отредактируйте файл <code>/etc/resolv.conf</code>, чтобы система опрашивала только сервер dnsmasq:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver 127.0.0.1
</pre>
<p><a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите">Запустите</a> демон dnsmasq.
</p>
<p>Наконец, если вы используете <a href="/title/Dhcpcd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Dhcpcd (Русский)">dhcpcd</a>, укажите ему не изменять настройки в файле <code>resolv.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dhcpcd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nohook resolv.conf
</pre>
<p>Если строка <code>nohook</code> уже есть, то добавьте <b>resolv.conf</b> через запятую.
</p>
<h2><span class="mw-headline" id="Torsocks">Torsocks</span></h2>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=torsocks">torsocks</a></span> позволяет заставить приложение работать через сеть Tor без необходимости корректировать настройки самого приложения. Выдержка из руководства:
</p>
<p><i>torsocks — обёртка между библиотекой torsocks и приложением с целью сделать каждое Интернет-соединение проходящим через сеть Tor.</i>
</p>
<p>Примеры использования:
</p>
<pre>$ torsocks elinks checkip.dyndns.org
$ torsocks wget -qO- <a rel="nofollow" class="external free" href="https://check.torproject.org/">https://check.torproject.org/</a> | grep -i congratulations
</pre>
<h2>
<span id=".22.D0.A2.D0.BE.D1.80.D0.B8.D1.84.D0.B8.D0.BA.D0.B0.D1.86.D0.B8.D1.8F.22"></span><span class="mw-headline" id='"Торификация"'>"Торификация"</span>
</h2>
<p>В некоторых случаях более безопасно (и часто проще) выполнить сквозную "торифицикацию" всей системы вместо настройки отдельных приложений на использование SOCKS-порта Tor и отслеживания утечек DNS. Для полной торификации сетевой экран <a href="/title/Iptables_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Iptables (Русский)">iptables</a> настраивают на пересылку всех исходящих пакетов (помимо собственно трафика Tor) на <i>TransPort</i>. В этом случае приложения не нужно настраивать для работы через Tor, хотя работа через <i>SocksPort</i> всё ещё возможна. Торификация также работает и для DNS (<i>DNSPort</i>), но при этом нужно учитывать, что Tor поддерживает только протокол TCP, и, за исключением DNS-запросов, UDP-пакеты через Tor посылаться не могут. Следовательно, они должны блокироваться для предотвращения утечек.
</p>
<p>Торификация через iptables даёт сравнительно надёжную защиту, но она не является полноценной заменой приложениям виртуализированной торификации вроде Whonix или TorVM <a rel="nofollow" class="external autonumber" href="https://www.whonix.org/wiki/Comparison_with_Others">[10]</a>. Торификация также не позволяет скрыть отпечаток браузера (fingerprint), поэтому рекомендуется воспользоваться "амнезийным" решением вроде <a rel="nofollow" class="external text" href="https://tails.boum.org/">Tails</a>. Приложения всё ещё могут узнать имя хоста, MAC-адрес, серийный номер, временную зону вашего компьютера и другие данные, а с root-привилегиями смогут даже отключить сетевой экран целиком. Другими словами, полная торификация через iptables защищает от случайных соединений и DNS-утечек неправильно настроенного программного обеспечения, но не от вредоносных программ или ПО с серьёзными уязвимостями.
</p>
<p>При работе через <a href="https://en.wikipedia.org/wiki/ru:%D0%9F%D1%80%D0%BE%D0%BA%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80#.D0.92.D0.B8.D0.B4.D1.8B_.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8-.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.BE.D0.B2" class="extiw" title="wikipedia:ru:Прокси-сервер">прозрачный прокси-сервер</a> можно запустить сеанс Tor дважды, на клиенте и на прокси, в режиме "Tor поверх Tor". Такая схема работы обладает непредсказуемым поведением и потенциально небезопасна. В теории, трафик пользователя будет выполнять шесть прыжков вместо обычных трёх, но нет никакой гарантии, что дополнительные прыжки не совпадут с тремя изначальными — например, в другом порядке. Разработчики Tor Project считают, что это небезопасно <a rel="nofollow" class="external autonumber" href="https://2019.www.torproject.org/docs/faq.html.en#ChoosePathLength">[11]</a>, <a rel="nofollow" class="external autonumber" href="https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO#ToroverTor">[12]</a>.
</p>
<p>Ниже приведён файл настроек для утилит <code>iptables-restore</code> и <code>ip6tables-restore</code> (используются <a href="/title/Systemd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Systemd (Русский)">службами</a> <code>iptables.service</code> и <code>ip6tables.service</code> соответственно).
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Правила в таблице nat принудительно перенаправляют исходящие соединения на TransPort или DNSPort, и блокируют всё, что торифицировать не удаётся.
<ul>
<li>Флагами <code>--ipv6</code> и <code>--ipv4</code> задаются правила для конкретных версий протокола <a href="https://en.wikipedia.org/wiki/ru:IP" class="extiw" title="wikipedia:ru:IP">IP</a>. Таким образом, утилиты <code>iptables-restore</code> и <code>ip6tables-restore</code> могут использовать один и тот же файл настроек.</li>
<li>В случае явного указания флага <code>--ipv6</code> или <code>--ipv4</code>, утилита <code>ip*tables-restore</code> будет игнорировать правило, если оно установлено для другой версии протокола.</li>
<li>
<code>ip6tables</code> не поддерживает флаг <code>--reject-with</code>.</li>
</ul>
<p>Убедитесь, что в файле <code>torrc</code> есть следующие строки:
</p>
<pre>SocksPort 9050
DNSPort 5353
TransPort 9040
</pre>
<p>Подробнее смотрите руководство <span class="plainlinks archwiki-template-man" title="$ man 8 iptables"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/iptables.8">iptables(8)</a></span>.
</p>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вы получили ошибку <code>iptables-restore: unable to initialize table 'nat'</code>, то нужно загрузить некоторые модули ядра:
<pre># modprobe ip_tables iptable_nat ip_conntrack iptable-filter ipt_state
</pre>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">*nat
:PREROUTING ACCEPT [6:2126]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [17:6239]
:POSTROUTING ACCEPT [6:408]

-A PREROUTING ! -i lo -p udp -m udp --dport 53 -j REDIRECT --to-ports 5353
-A PREROUTING ! -i lo -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040
-A OUTPUT -o lo -j RETURN
--ipv4 -A OUTPUT -d 192.168.0.0/16 -j RETURN
-A OUTPUT -m owner --uid-owner "tor" -j RETURN
-A OUTPUT -p udp -m udp --dport 53 -j REDIRECT --to-ports 5353
-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
--ipv4 -A INPUT -p tcp -j REJECT --reject-with tcp-reset
--ipv4 -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
--ipv4 -A INPUT -j REJECT --reject-with icmp-proto-unreachable
--ipv6 -A INPUT -j REJECT
--ipv4 -A OUTPUT -d 127.0.0.0/8 -j ACCEPT
--ipv4 -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
--ipv6 -A OUTPUT -d ::1/8 -j ACCEPT
-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m owner --uid-owner "tor" -j ACCEPT
--ipv4 -A OUTPUT -j REJECT --reject-with icmp-port-unreachable
--ipv6 -A OUTPUT -j REJECT
COMMIT
</pre>
<p>Данный файл также подходит для утилиты <code>ip6tables-restore</code>. Создайте символическую ссылку на него:
</p>
<pre># ln -s /etc/iptables/iptables.rules /etc/iptables/ip6tables.rules
</pre>
<p>Убедитесь, что Tor работает, и <a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5/%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите/включите">запустите/включите</a> службы <code>iptables</code> и <code>ip6tables</code>.
</p>
<p>При необходимости можно <a href="/title/%D0%9E%D1%82%D1%80%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D1%83%D0%B9%D1%82%D0%B5" class="mw-redirect" title="Отредактируйте">добавить указания</a> <code>Requires=iptables.service</code> и <code>Requires=ip6tables.service</code> к любому юниту systemd, чтобы выбранный процесс запускался строго после включения межсетевого экрана.
</p>
<h2>
<span id=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B_.D0.B8_.D1.80.D0.B5.D0.BA.D0.BE.D0.BC.D0.B5.D0.BD.D0.B4.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Советы_и_рекомендации">Советы и рекомендации</span>
</h2>
<h3>
<span id=".D0.92.D0.BE.D0.B7.D0.BC.D0.BE.D0.B6.D0.BD.D0.BE.D1.81.D1.82.D0.B8_.D1.8F.D0.B4.D1.80.D0.B0"></span><span class="mw-headline" id="Возможности_ядра">Возможности ядра</span>
</h3>
<p>Если необходимо запустить Tor от обычного пользователя, и в то же время использовать порты меньше 1024, то можно воспользоваться функциональностью ядра для выдачи процессу <code>/usr/bin/tor</code> разрешения выполнять привязку привилегированных портов:
</p>
<pre># setcap CAP_NET_BIND_SERVICE=+eip /usr/bin/tor
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> После обновления пакета Tor эти разрешения сбросятся. Создайте <a href="/title/Pacman_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#%D0%A5%D1%83%D0%BA%D0%B8" title="Pacman (Русский)">хук</a> для автоматической выдачи разрешений после обновлений.</div>
<p>Если вы используете службу systemd, то выдать Tor соответствующие разрешения можно также через настройки системного демона. Это удобно тем, что разрешения не нужно возобновлять после каждого обновления Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/netcap.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
CapabilityBoundingSet=
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=
AmbientCapabilities=CAP_NET_BIND_SERVICE
</pre>
<p>Подробности можно найти на странице <a rel="nofollow" class="external text" href="https://superuser.com/questions/710253/allow-non-root-process-to-bind-to-port-80-and-443">superuser.com</a>.
</p>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D0.B0_.D1.81_.D0.BF.D0.B0.D1.80.D0.B0.D0.BC.D0.B5.D1.82.D1.80.D0.BE.D0.BC_User"></span><span class="mw-headline" id="Проблема_с_параметром_User">Проблема с параметром User</span>
</h3>
<p>Если не удалось запустить демон Tor, выполните следующую команду от root (или воспользуйтесь утилитой <a href="/title/Sudo" title="Sudo">sudo</a>):
</p>
<pre># tor
</pre>
<p>Ошибка
</p>
<pre>May 23 00:27:24.624 [warn] Error setting groups to gid 43: "Operation not permitted".
May 23 00:27:24.624 [warn] If you set the "User" option, you must start Tor as root.
May 23 00:27:24.624 [warn] Failed to parse/validate config: Problem with User value. See logs for details.
May 23 00:27:24.624 [err] Reading config failed--see warnings above.
</pre>
<p>означает проблемы с параметром User. Скорее всего, один или несколько файлов/каталогов в  каталоге <code>/var/lib/tor</code> не принадлежат пользователю <code>tor</code>. Это можно определить с помощью команды <i>find</i>: 
</p>
<pre>find /var/lib/tor/ ! -user tor
</pre>
<p>Для всех выведенных файлов и каталогов нужно поменять параметр владельца. Можно сделать это индивидуально для каждого файла
</p>
<pre># chown tor:tor /var/lib/tor/<i>имя_файла</i>
</pre>
<p>или отредактировать все сразу командой
</p>
<pre># chown -R -v tor:tor /var/lib/tor
</pre>
<p>Теперь Tor должен запуститься без проблем.
</p>
<p>Если запустить службу всё же не удаётся, запустите её от root. Измените имя пользователя в файле <code>/etc/tor/torrc</code>:
</p>
<pre>User tor
</pre>
<p>Затем отредактируйте файл службы systemd <code>/usr/lib/systemd/system/tor.service</code>:
</p>
<pre>[Service]
User=root
Group=root
Type=simple
</pre>
<p>В дальнейшем процесс будет запускаться от пользователя <code>tor</code>, поэтому измените UID и GID файлов на <code>tor</code> и добавьте разрешение на запись:
</p>
<pre># chown -R tor:tor /var/lib/tor/
# chmod -R 700 /var/lib/tor
</pre>
<p>Сохраните изменения:
</p>
<pre># systemctl --system daemon-reload
</pre>
<p>Наконец, <a href="/title/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D1%82%D0%B8%D1%82%D0%B5" class="mw-redirect" title="Запустите">запустите</a> <code>tor.service</code>.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D1.8B_.D1.81_.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8_tor-browser"></span><span class="mw-headline" id="Проблемы_с_прокси_tor-browser">Проблемы с прокси tor-browser</span>
</h3>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/tor-browser/">tor-browser</a></span><sup><small>AUR</small></sup> обычно нормально работает без дополнительных настроек. Если  установленный/настроенный прокси выдаёт ошибку <code>proxy server is refusing connections</code> при любой попытке установить соединение, попробуйте сбросить настройки, переместив или удалив каталог <code>~/.tor-browser</code>.
</p>
<h3>
<span id=".D0.9F.D1.83.D1.81.D1.82.D0.BE.D0.B9_.D1.87.D1.91.D1.80.D0.BD.D1.8B.D0.B9_.D1.8D.D0.BA.D1.80.D0.B0.D0.BD_.D0.B2_tor-browser"></span><span class="mw-headline" id="Пустой_чёрный_экран_в_tor-browser">Пустой чёрный экран в tor-browser</span>
</h3>
<p>При работе с <a href="/title/AppArmor" title="AppArmor">AppArmor</a> для доступа к ресурсам необходимо внести изменения в профиль Tor Browser <a rel="nofollow" class="external autonumber" href="https://unix.stackexchange.com/questions/550074/debian-tor-browser-showing-a-black-screen/550246#550246">[13]</a>, <a rel="nofollow" class="external autonumber" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=942901">[14]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/apparmor.d/local/torbrowser.Browser.firefox</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">owner /{dev,run}/shm/org.mozilla.*.* rw,
</pre>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://www.torproject.org/docs/tor-doc-unix.html.en">Запуск клиента Tor на Linux/BSD/Unix</a></li>
<li><a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/wiki#Unixish">Список статей о Tor для Unix</a></li>
<li><a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/wiki/doc/SupportPrograms">Программы с интеграцией Tor</a></li>
<li><a rel="nofollow" class="external text" href="https://www.torproject.org/docs/tor-hidden-service.html.en">Как включить Tor <i>Hidden Service</i></a></li>
<li><a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/wiki/doc/PluggableTransports">Pluggable Transports для обфускации трафика Tor</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="/title/Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="/title/Category:Anonymity_networks_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)" title="Category:Anonymity networks (Русский)">Anonymity networks (Русский)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="/title/Category:Pages_or_sections_flagged_with_Template:Out_of_date" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li></ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Tor_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=669453">https://wiki.archlinux.org/index.php?title=Tor_(Русский)&amp;oldid=669453</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 8 May 2021, at 11:50.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="/title/ArchWiki:Privacy_policy" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="/title/ArchWiki:About" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="/title/ArchWiki:General_disclaimer" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
