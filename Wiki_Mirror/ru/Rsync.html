<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>rsync (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Rsync_Русский rootpage-Rsync_Русский skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">rsync (Русский)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p><span></span>
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Rsync.html" title="Rsync">rsync</a>. Дата последней синхронизации: 3 января 2021. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Rsync&amp;diff=0&amp;oldid=646584">изменения</a>.</div>
<div class="archwiki-template-meta-related-articles-start">
<p>Ссылки по теме</p>
<ul>
<li><a href="../en/System_backup.html" title="System backup">System backup</a></li>
<li><a href="../ru/Synchronization_and_backup_programs.html" class="mw-redirect" title="Программы синхронизации и резервного копирования">Программы синхронизации и резервного копирования</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="https://rsync.samba.org/">rsync</a> — утилита с открытым исходным кодом для быстрого инкрементного перемещения файлов.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0"><span class="tocnumber">1</span> <span class="toctext">Установка</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#%D0%A4%D1%80%D0%BE%D0%BD%D1%82%D0%B5%D0%BD%D0%B4%D1%8B"><span class="tocnumber">1.1</span> <span class="toctext">Фронтенды</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3">
<a href="#%D0%9A%D0%B0%D0%BA_%D0%B0%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%B0_cp/mv"><span class="tocnumber">2</span> <span class="toctext">Как альтернатива cp/mv</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#%D0%9F%D1%80%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D0%B5%D1%80%D0%B5%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BE_%D0%B7%D0%B0%D0%BC%D1%8B%D0%BA%D0%B0%D1%8E%D1%89%D0%B5%D0%BC_%D1%81%D0%BB%D1%8D%D1%88%D0%B5"><span class="tocnumber">2.1</span> <span class="toctext">Предостережение о замыкающем слэше</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5">
<a href="#%D0%9A%D0%B0%D0%BA_%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D0%B0_%D0%B4%D0%BB%D1%8F_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"><span class="tocnumber">3</span> <span class="toctext">Как утилита для резервного копирования</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5"><span class="tocnumber">3.1</span> <span class="toctext">Автоматическое резервное копирование</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE_SSH"><span class="tocnumber">3.2</span> <span class="toctext">Автоматическое резервное копирование по SSH</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81_%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E_NetworkManager"><span class="tocnumber">3.3</span> <span class="toctext">Автоматическое резервное копирование с помощью NetworkManager</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81_%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E_systemd_%D0%B8_inotify"><span class="tocnumber">3.4</span> <span class="toctext">Автоматическое резервное копирование с помощью systemd и inotify</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#%D0%94%D0%B8%D1%84%D1%84%D0%B5%D1%80%D0%B5%D0%BD%D1%86%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B2_%D1%82%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D0%B4%D0%B5%D0%BB%D0%B8"><span class="tocnumber">3.5</span> <span class="toctext">Дифференциальное резервное копирование в течение недели</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#%D0%A0%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%B8_%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D0%B8_%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F_%D1%81%D0%BD%D0%B8%D0%BC%D0%BA%D0%BE%D0%B2"><span class="tocnumber">3.6</span> <span class="toctext">Резервное копирование при помощи создания снимков</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#%D0%9F%D0%BE%D0%BB%D0%BD%D0%B0%D1%8F_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%B0%D1%8F_%D0%BA%D0%BE%D0%BF%D0%B8%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B"><span class="tocnumber">3.7</span> <span class="toctext">Полная резервная копия системы</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#%D0%92%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B9_%D0%BA%D0%BE%D0%BF%D0%B8%D0%B8"><span class="tocnumber">3.8</span> <span class="toctext">Восстановление резервной копии</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="#%D0%9A%D0%BB%D0%BE%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B"><span class="tocnumber">4</span> <span class="toctext">Клонирование файловой системы</span></a></li>
<li class="toclevel-1 tocsection-15">
<a href="#%D0%94%D0%B5%D0%BC%D0%BE%D0%BD_rsync"><span class="tocnumber">5</span> <span class="toctext">Демон rsync</span></a>
<ul>
<li class="toclevel-2 tocsection-16">
<a href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8"><span class="tocnumber">5.1</span> <span class="toctext">Пример конфигурации</span></a>
<ul>
<li class="toclevel-3 tocsection-17"><a href="#%D0%A0%D0%B0%D0%B7%D0%B4%D0%B0%D1%87%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D0%BF%D0%BE_%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D1%83"><span class="tocnumber">5.1.1</span> <span class="toctext">Раздача файлов по списку</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-18"><a href="#%D0%A1%D0%BC._%D1%82%D0%B0%D0%BA%D0%B6%D0%B5"><span class="tocnumber">6</span> <span class="toctext">См. также</span></a></li>
</ul>
</div>

<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rsync">rsync</a></span>.
</p>
<p><i>rsync</i> должен быть установлен как на устройстве-отправителе, так и на устройстве-получателе.
</p>
<h3>
<span id=".D0.A4.D1.80.D0.BE.D0.BD.D1.82.D0.B5.D0.BD.D0.B4.D1.8B"></span><span class="mw-headline" id="Фронтенды">Фронтенды</span>
</h3>
<ul><li>
<b>Grsync</b> — GTK-фронтенд.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="http://www.opbyte.it/grsync/">http://www.opbyte.it/grsync/</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grsync">grsync</a></span>
</dd></dl>
<ul><li>
<b>gutback</b> — обёртка над rsync, написанная на Shell.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/gutenye/gutbackup">https://github.com/gutenye/gutbackup</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/gutbackup/">gutbackup</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>JotaSync</b> — графический пользовательский интерфейс Java Swing для rsync со встроенным планировщиком.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://trixon.se/projects/jotasync/">https://trixon.se/projects/jotasync/</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/jotasync/">jotasync</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>luckyBackup</b> — Qt-фронтенд, написанный на C++.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="http://luckybackup.sourceforge.net/index.html">http://luckybackup.sourceforge.net/index.html</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/luckybackup/">luckybackup</a></span><sup><small>AUR</small></sup>
</dd></dl>
<p>Другие утилиты, использующие rsync: <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rdiff-backup">rdiff-backup</a></span> и <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/osync/">osync</a></span><sup><small>AUR</small></sup>.
</p>
<h2>
<span id=".D0.9A.D0.B0.D0.BA_.D0.B0.D0.BB.D1.8C.D1.82.D0.B5.D1.80.D0.BD.D0.B0.D1.82.D0.B8.D0.B2.D0.B0_cp.2Fmv"></span><span class="mw-headline" id="Как_альтернатива_cp/mv">Как альтернатива cp/mv</span>
</h2>
<p>rsync может использоваться как продвинутая альтернатива команде <code>cp</code> или <code>mv</code>, особенно при копировании больших файлов.
</p>
<pre>$ rsync -P источник назначение
</pre>
<p>Опция <code>-P</code> эквивалентна <code>--partial --progress</code>, которая оставляет частично перемещённые файлы и показывает шкалу прогресса во время перемещения. 
</p>
<p>Используйте опцию <code>-r</code>/<code>--recursive</code> для рекурсивного обхода каталогов.
</p>
<p>Файлы могут копироваться локально, как при помощи cp, но rsync интересна прежде всего возможностью удалённого копирования файлов, то есть между двумя разными хостами. Удалённые расположения могут быть указаны при помощи синтаксиса хост-двоеточие:
</p>
<pre>$ rsync источник хост:назначение
</pre>
<p>или
</p>
<pre>$ rsync хост:источник назначение
</pre>
<p>Передача файлов по сети по умолчанию использует протокол <a href="../ru/OpenSSH.html" class="mw-redirect" title="SSH (Русский)">SSH</a> и <code>хост</code> может быть как реальным именем хоста, так и предопределённым профилем/псевдонимом из <code>.ssh/config</code>.
</p>
<p>При локальном или удалённом перемещении файлов, rsync сперва создаёт список файлов, содержащий информацию (по умолчанию это размер файла и время его последнего изменения), которая затем будет использована для определения, нуждается ли файл в построении. Для каждого файла, нуждающегося в построении, находится слабая и сильная контрольная сумма для каждого блока так, что каждый блок имеет длину <b>S</b> байт, не пересекается с другими и имеет сдвиг, который делится на <b>S</b>. Благодаря этой информации, большие файлы могут быть построены с помощью rsync без необходимости перемещения файла целиком. Для более детального практического и математического объяснения см. <a rel="nofollow" class="external text" href="https://rsync.samba.org/how-rsync-works.html">как работает rsync</a> (англ.) и <a rel="nofollow" class="external text" href="https://rsync.samba.org/tech_report/tech_report.html">алгоритм rsync</a> (англ.) соответственно.
</p>
<p>Для быстрого использования разумных значений по умолчанию, можете использовать следующие псевдонимы:
</p>
<pre>function cpr() {
  rsync --archive -hh --partial --info=stats1,progress2 --modify-window=1 "$@"
} 
function mvr() {
  rsync --archive -hh --partial --info=stats1,progress2 --modify-window=1 --remove-source-files "$@"
}</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Использование термина <i>контрольная сумма</i> <i>не</i> соответствует поведению опции <code>--checksum</code>. Опция <code>--checksum</code> ответственна за использование эвристики пропуска файла перед передачей любого файла. Независимо от <code>--checksum</code>, <i>контрольная сумма</i> всегда используется для поблочного построения файла, при помощи которого rsync перемещает файл.</div>
<h3>
<span id=".D0.9F.D1.80.D0.B5.D0.B4.D0.BE.D1.81.D1.82.D0.B5.D1.80.D0.B5.D0.B6.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BE_.D0.B7.D0.B0.D0.BC.D1.8B.D0.BA.D0.B0.D1.8E.D1.89.D0.B5.D0.BC_.D1.81.D0.BB.D1.8D.D1.88.D0.B5"></span><span class="mw-headline" id="Предостережение_о_замыкающем_слэше">Предостережение о замыкающем слэше</span>
</h3>
<p>По умолчанию Arch использует GNU cp (часть GNU <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=coreutils">coreutils</a></span>). Однако rsync следует соглашениям BSD cp, которые особо обрабатывают каталоги источника с замыкающим слэшем "/". Несмотря на то, что
</p>
<pre>$ rsync -r источник назначение
</pre>
<p>создаёт каталог "назначение/источник" с содержимым "источника", команда
</p>
<pre>$ rsync -r источник/ назначение
</pre>
<p>копирует все файлы из "источник/" напрямую в "назначение", без промежуточного каталога - так же, как при вызове
</p>
<pre>$ rsync -r источник/. назначение
</pre>
<p>Это поведение отличается от такового в GNU cp, которая одинаково обрабатывает "источник" и "источник/" (но не "источник/."). Кроме того, некоторые оболочки автоматически добавляют замыкающий слэш при tab-дополнении имён каталогов. В виду этих обстоятельств, новые или нечастые пользователи rsync могут зачастую забывать про разное поведение rsync и случайно создавать беспорядок или даже перезаписывать важные файлы, оставляя замыкающий слэш в командной строке.
</p>
<p>Поэтому имеет смысл использовать сценарий-обёртку, чтобы автоматически удалять замыкающий слэш перед вызовом rsync:
</p>
<pre>#!/bin/zsh
new_args=();
for i in "$@"; do
    case $i in /) i=/;; */) i=${i%/};; esac
    new_args+=$i;
done
exec rsync "${(@)new_args}"
</pre>
<p>Этот сценарий может быть размещён где-нибудь в <code>$PATH</code> и назначен псевдонимом для rsync в файле инициализации оболочки.
</p>
<h2>
<span id=".D0.9A.D0.B0.D0.BA_.D1.83.D1.82.D0.B8.D0.BB.D0.B8.D1.82.D0.B0_.D0.B4.D0.BB.D1.8F_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B3.D0.BE_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Как_утилита_для_резервного_копирования">Как утилита для резервного копирования</span>
</h2>
<p>Протокол rsync легко может использоваться для резервного копирования, перемещая только файлы, изменённые с момента последней резервной копии. Этот раздел описывает очень простой сценарий, выполняемый по расписанию, использующий rsync, обычно используемый для копирования на извлекаемый носитель.
</p>
<h3>
<span id=".D0.90.D0.B2.D1.82.D0.BE.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Автоматическое_резервное_копирование">Автоматическое резервное копирование</span>
</h3>
<p>В этом примере сценарий будет создан в каталоге <code>/etc/cron.daily</code> и будет запускаться ежедневно, если <a href="../ru/Daemons.html" class="mw-redirect" title="Daemon (Русский)">демон</a> cron должным образом установлен и настроен. Настройка и использование <a href="../en/Cron.html" class="mw-redirect" title="Cron (Русский)">cron</a> выходит за рамки этой статьи.
</p>
<p>Сперва создайте сценарий, содержащий подходящие опции команды:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/cron.daily/backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash
rsync -a --delete --quiet /каталог/для/резервного/копирования /расположение/резервной/копии</pre>
<dl>
<dt><code>-a</code></dt>
<dd>означает, что файлы должны быть архивированы, то есть большинство их характеристик сохранятся (но <b>не</b> список контроля доступа, жёсткие ссылки или расширенные атрибуты, такие как их возможности)</dd>
<dt><code>--delete</code></dt>
<dd>означает, что файлы, удалённые в источнике должны быть удалены и из резервной копии</dd>
</dl>
<p>Здесь <code>/каталог/для/резервного/копирования</code> следует заменить на каталог, нуждающийся в резервной копии (например <code>/home</code>), а <code>/расположение/резервной/копии</code> на каталог, куда следует сохранять резервную копию (например <code>/media/disk</code>).
</p>
<p>В конце надо сделать сценарий исполняемым:
</p>
<pre># chmod +x /etc/cron.daily/backup
</pre>
<h3>
<span id=".D0.90.D0.B2.D1.82.D0.BE.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE_SSH"></span><span class="mw-headline" id="Автоматическое_резервное_копирование_по_SSH">Автоматическое резервное копирование по SSH</span>
</h3>
<p>Для резервного копирования на удалённый хост при помощи <a href="../ru/OpenSSH.html" class="mw-redirect" title="SSH (Русский)">SSH</a>, используйте следующий сценарий:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/cron.daily/backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash
rsync -a --delete --quiet -e ssh /каталог/для/резервного/копирования пользователь@хост:/расположение/резервной/копии
</pre>
<dl>
<dt><code>-e ssh</code></dt>
<dd>указывает rsync использовать SSH</dd>
<dt><code>пользователь</code></dt>
<dd>пользователь на <code>хост</code>
</dd>
<dt><code>-a</code></dt>
<dd>включает опции <code>-rlptgoD</code> (рекурсивно, ссылки, разрешения, времена, группы, владелец, устройства)</dd>
</dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
Rsync попытается изменить любые файлы с существующими резервными копиями на целевом устройстве, чтобы они соответствовали их состоянию на устройстве-источнике, при каждом инкрементном резервном копировании. Это означает, что при резервном копировании файлов, владеемых root, при помощи SSH (и когда включено сохранение разрешений и владения например опцией <code>-a</code>), требуются root права на целевом устройстве. Предпочтительный способ достижения этого при автоматизации — настроить демон SSH, разрешив вход для root, используя <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/a/92397">публичный ключ без пароля</a> (англ.) и запустить команды rsync с правами root.</div>
<h3>
<span id=".D0.90.D0.B2.D1.82.D0.BE.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81_.D0.BF.D0.BE.D0.BC.D0.BE.D1.89.D1.8C.D1.8E_NetworkManager"></span><span class="mw-headline" id="Автоматическое_резервное_копирование_с_помощью_NetworkManager">Автоматическое резервное копирование с помощью NetworkManager</span>
</h3>
<p>Этот сценарий запускает резервное копирование при установлении сетевого соединения.
</p>
<p>Сперва создайте сценарий, содержащий подходящие опции команды:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/dispatcher.d/backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

if [ x"$2" = "xup" ] ; then
        rsync --force --ignore-errors -a --delete --bwlimit=2000 --files-from=files.rsync /каталог/для/резервного/копирования /расположение/резервных/копий
fi</pre>
<dl>
<dt><code>-a</code></dt>
<dd>включает опции <code>-rlptgoD</code> (рекурсивно, ссылки, разрешения, времена, группы, владелец, устройства)</dd>
<dt><code>--files-from</code></dt>
<dd>считывает относительный путь <i>/каталога/для/резервного/копирования</i> из этого файла</dd>
<dt><code>--bwlimit</code></dt>
<dd>ограничивает пропускную способность ввода/вывода; КБайт в секунду</dd>
</dl>
<p>Root должен владеть сценарием (для изучения подробностей см. <a href="../en/NetworkManager.html#Network_services_with_NetworkManager_dispatcher" title="NetworkManager">NetworkManager#Network services with NetworkManager dispatcher</a> (англ.))
</p>
<h3>
<span id=".D0.90.D0.B2.D1.82.D0.BE.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81_.D0.BF.D0.BE.D0.BC.D0.BE.D1.89.D1.8C.D1.8E_systemd_.D0.B8_inotify"></span><span class="mw-headline" id="Автоматическое_резервное_копирование_с_помощью_systemd_и_inotify">Автоматическое резервное копирование с помощью systemd и inotify</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
<ul>
<li>В связи с ограничениями inotify и systemd (см. <a rel="nofollow" class="external text" href="http://www.quora.com/Linux-Kernel/Inotify-monitoring-of-directories-is-not-recursive-Is-there-any-specific-reason-for-this-design-in-Linux-kernel">этот вопрос и ответ</a>(англ.)), рекурсивный мониторинг файловой системы невозможен. Несмотря на возможность просматривать каталог и его содержимое, нельзя рекурсивно заходить в подкаталоги и просматривать их содержимое; вам необходимо явно указывать каждый каталог для просмотра, даже если этот каталог является дочерним для другого указанного каталога.</li>
<li>Эта настройка основана на <a href="../ru/1f5394a42ce1ed8bac6cd0b28f1245e6.html" title="Systemd (Русский)/User (Русский)">systemd/User</a>.</li>
</ul>
</div>
<p>Вместо запуска резервного копирования по расписанию, например при помощи <a href="../en/Cron.html" class="mw-redirect" title="Cron (Русский)">cron</a>, можно запускать резервное копирование каждый раз, когда в один из файлов, подлежащих резервному копированию, вносятся изменения. Модули <code>systemd.path</code> используют <code>inotify</code> для мониторинга файловой системы, и могут быть использованы в связке с файлами <code>systemd.service</code> для запуска любого процесса (в данном случае резервного копирования при помощи <a class="mw-selflink selflink">rsync</a>) на основе события файловой системы.
</p>
<p>Сперва, создайте файл <code>systemd.path</code>, который будет отслеживать файлы для резервного копирования:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.config/systemd/user/backup.path</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Проверяет, изменились ли файлы, для которых необходимо создавать резервные копии

[Path]
PathChanged=%h/documents
PathChanged=%h/music

[Install]
WantedBy=default.target
</pre>
<p>Затем создайте файл <code>systemd.service</code>, который будет активирован при обнаружении изменений. По умолчанию будет запущен файл службы, названный так же, как и модуль пути (в данном случае <code>backup.path</code>), за исключением расширения <code>.service</code> вместо <code>.path</code> (в данном случае <code>backup.service</code>).
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вам нужно запустить несколько команд rsync, используйте <code>Type=oneshot</code>. Это позволяет указывать несколько параметров <code>ExecStart=</code>, один для каждой команды <a class="mw-selflink selflink">rsync</a>, которая будет выполнена. Другим способом является просто написание сценария для запуска создания всех резервных копий, такого как сценарий <a href="../en/Cron.html" class="mw-redirect" title="Cron (Русский)">cron</a>.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.config/systemd/user/backup.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Создаёт резервные копии файлов

[Service]
ExecStart=/usr/bin/rsync %h/./documents %h/./music -CERrltm --delete ubuntu:
</pre>
<p>Теперь <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Запустите/включите">запустите/включите</a> <code>backup.path</code>, как обычную службу systemd и она начнёт отслеживать изменения в файлах и автоматически запускать <code>backup.service</code>.
</p>
<h3>
<span id=".D0.94.D0.B8.D1.84.D1.84.D0.B5.D1.80.D0.B5.D0.BD.D1.86.D0.B8.D0.B0.D0.BB.D1.8C.D0.BD.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.B2_.D1.82.D0.B5.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D0.B4.D0.B5.D0.BB.D0.B8"></span><span class="mw-headline" id="Дифференциальное_резервное_копирование_в_течение_недели">Дифференциальное резервное копирование в течение недели</span>
</h3>
<p>Это полезная возможность rsync, заключающаяся в создании полной резервной копии (при каждом запуске) и поддержании дифференциальной резервной копии только измененных файлов в отдельном каталоге для каждого дня недели.
</p>
<p>Сперва создайте сценарий, содержащий подходящие командные опции:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/cron.daily/backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

DAY=$(date +%A)

if [ -e /расположение/для/инкрементной/копии/$DAY ] ; then
  rm -fr /расположение/для/инкрементной/копии/$DAY
fi

rsync -a --delete --quiet --inplace --backup --backup-dir=/расположение/для/инкрементной/копии/$DAY /каталог/для/резервного/копирования/ /расположение/для/полной/резервной/копии/</pre>
<dl>
<dt><code>--inplace</code></dt>
<dd>заставляет <code>--partial</code> обновлять целевые файлы напрямую.</dd>
</dl>
<h3>
<span id=".D0.A0.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.B8_.D0.BF.D0.BE.D0.BC.D0.BE.D1.89.D0.B8_.D1.81.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D1.8F_.D1.81.D0.BD.D0.B8.D0.BC.D0.BA.D0.BE.D0.B2"></span><span class="mw-headline" id="Резервное_копирование_при_помощи_создания_снимков">Резервное копирование при помощи создания снимков</span>
</h3>
<p>Эта же идея может использоваться для поддержания дерева снимков ваших файлов. Другими словами, каталога с копиями файлов, упорядоченных по дате. Копии создаются при помощи жёстких ссылок, то есть только изменённые файлы будут занимать пространство. В общих чертах, эта идея лежит в основе TimeMachine от Apple.
</p>
<p>Этот легко реализуемый базовый сценарий создаёт быстрые инкрементные снимки, используя опцию <code>--link-dest</code> для создания жёстких ссылок на неизменённые файлы:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/snapbackup.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

# Базовый скрипт для создания снимков при помощи rsync

# Config
OPT="-aPh"
LINK="--link-dest=/snapshots/пользователь/last/" 
SRC="/home/пользователь/файлы/"
SNAP="/snapshots/пользователь/"
LAST="/snapshots/пользователь/last"
date=`date "+%Y-%b-%d:_%T"`

# Запуск rsync для создания снимка
rsync $OPT $LINK $SRC ${SNAP}$date

# Удаление символической ссылки на предыдущий снимок
rm -f $LAST

# Создание новой символической ссылки на последний снимок, на который следует создавать жёсткие ссылки
ln -s ${SNAP}$date $LAST
</pre>
<p>Символическая ссылка должна уже существовать в качестве назначения <code>--link-dest</code>. Если предыдущий снимок удаляется, то символическая ссылка должна быть пересоздана на наиболее недавний снимок. Если <code>--link-dest</code> не найдёт работающей символической ссылки, rsync продолжит копировать все исходные файла вместо копирования только изменений.
</p>
<p>Более продвинутая версия поддерживает актуальную полную резервную копию <code>$SNAP/latest</code> и в случае изменения определённого количества файлов с прошлой полной резервной копии, создаёт снимок <code>$SNAP/$DATETAG</code> текущей полной резервной копии, используя <code>cp -al</code> для создания жёстких ссылок на неизменённые файлы:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/rsnapshot.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

## Моя процедура для создания снимков на основе rsync
## (cc) marcio rps AT gmail.com

# Конфигурационные переменные

SRC="/home/пользователь/файлы/" #не забудьте замыкающий слэш!
SNAP="/snapshots/пользователь"
OPTS="-rltgoi --delay-updates --delete --chmod=a-w"
MINCHANGES=20

# запуск этого процесса с низким приоритетом

ionice -c 3 -p $$
renice +12  -p $$

# синхронизация

rsync $OPTS $SRC $SNAP/latest &gt;&gt; $SNAP/rsync.log

# проверка, достаточно ли файлов поменялось, если да, то
# создаётся жёсткая ссылка, называемая по дате

COUNT=$( wc -l $SNAP/rsync.log|cut -d" " -f1 )
if [ $COUNT -gt $MINCHANGES ] ; then
        DATETAG=$(date +%Y-%m-%d)
        if [ ! -e $SNAP/$DATETAG ] ; then
                cp -al $SNAP/latest $SNAP/$DATETAG
                chmod u+w $SNAP/$DATETAG
                mv $SNAP/rsync.log $SNAP/$DATETAG
               chmod u-w $SNAP/$DATETAG
         fi
fi
</pre>
<p>Чтобы сделать всё намного проще, этот сценарий можно запускать как модуль <a href="../ru/3f3a84c728c7f82c3a1680ed48eacde3.html" title="Systemd (Русский)/Timers (Русский)">systemd/Timers</a>.
</p>
<h3>
<span id=".D0.9F.D0.BE.D0.BB.D0.BD.D0.B0.D1.8F_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.B0.D1.8F_.D0.BA.D0.BE.D0.BF.D0.B8.D1.8F_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Полная_резервная_копия_системы">Полная резервная копия системы</span>
</h3>
<p>Этот раздел об использовании <i>rsync</i> для перемещения копии полного дерева <code>/</code>, исключая несколько выбранных каталогов. Этот подход считается лучше, чем <a href="../en/Disk_cloning.html" class="mw-redirect" title="Клонирование диска">клонирование диска</a> с помощью <code>dd</code> т.к. он позволяет использовать различные размеры, таблицы разделов и файловые системы и лучше, чем копирование с помощью <code>cp -a</code>, т.к. предоставляет больший контроль над разрешениями, атрибутами файлов, <a href="../ru/Access_Control_Lists.html" title="Access Control Lists (Русский)">списками контроля доступа</a> и <a href="../en/File_permissions_and_attributes.html#Extended_attributes" class="mw-redirect" title="Extended attributes">расширенными атрибутами</a> (англ.).
</p>
<p><i>rsync</i> будет работать даже при запущенной системе, но файлы, изменённые во время перемещения могут быть как перемещены, так и нет, что может вызывать неопределённое поведение некоторых программ, использующих перемещённые файлы.
</p>
<p>Этот подход хорошо подходит для переноса существующей установки на новый жёсткий диск или <a href="../ru/Solid_state_drive.html" class="mw-redirect" title="SSD (Русский)">SSD</a>.
</p>
<p>Запустите следующую команду с правами root, чтобы удостовериться, что rsync имеет доступ ко всем системным файлам и может сохранять владельцев:
</p>
<pre># rsync -aAXHv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} / <i>/каталог/для/резервного/копирования</i>
</pre>
<p>При использовании набора опций <code>-aAX</code>, файлы перемещаются в режиме архива, что гарантирует сохранность символических ссылок, устройств, разрешений, владельцев, времени изменения, <a href="../ru/Access_Control_Lists.html" title="Access Control Lists (Русский)">списков контроля доступа</a> и расширенных атрибутов, в предположении, что целевая <a href="../ru/File_systems.html" class="mw-redirect" title="Файловая система">файловая система</a> поддерживает соответствующие функции. Опция <code>-H</code> сохраняет жёсткие ссылки, но использует больше памяти.
</p>
<p>Опция <code>--exclude</code> исключает файлы, подходящие под заданные шаблоны. Содержимое каталогов <code>/dev</code>, <code>/proc</code>, <code>/sys</code>, <code>/tmp</code> и <code>/run</code> исключено в команде выше т.к. они заполняются при загрузке, несмотря на то, что сами каталоги <i>не</i> создаются. <code>/lost+found</code> зависит от файловой системы. Команда выше зависит расширения скобок в оболочках <a rel="nofollow" class="external text" href="https://www.gnu.org/software/bash/manual/html_node/Brace-Expansion.html">bash</a> (англ.) и <a rel="nofollow" class="external text" href="http://zsh.sourceforge.net/Doc/Release/Expansion.html#Brace-Expansion">zsh</a> (англ.). При использовании другой <a href="../ru/Command-line_shell.html" title="Command-line shell (Русский)">оболочки</a>. шаблоны в <code>--exclude</code> должны повторяться вручную. Кавычки в исключаемых шаблонах позволят избежать расширения <a href="../ru/Command-line_shell.html" title="Command-line shell (Русский)">оболочкой</a>, что важно например при резервном копировании по <a href="../ru/OpenSSH.html" class="mw-redirect" title="SSH (Русский)">SSH</a>. Окончание исключаемых путей символом <code>*</code> гарантирует, что сами каталоги будут созданы, если они ещё не существуют.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
<ul>
<li>Если вы планируете записывать резервную копию в каталог, отличный от <code>/mnt</code> или <code>/media</code>, не забудьте добавить его в список исключаемых шаблонов, чтобы избежать бесконечного цикла.</li>
<li>Если в системе есть смонтированные привязанные каталоги, то они должны быть также исключены, чтобы их содержимое скопировалось только один раз.</li>
<li>Если вы используете <a href="../ru/Swap.html#%D0%A4%D0%B0%D0%B9%D0%BB_%D0%BF%D0%BE%D0%B4%D0%BA%D0%B0%D1%87%D0%BA%D0%B8" class="mw-redirect" title="Файл подкачки">файл подкачки</a>, убедитесь, что вы его исключили.</li>
<li>Примите к сведению, если хотите создать резервную копию каталога <code>/home/</code>. Если он содержит ваши данные, то может оказаться значительно больше, чем система. В ином случае, исключите неважные подкаталоги, такие как <code>/home/*/.thumbnails/*</code>, <code>/home/*/.cache/mozilla/*</code>, <code>/home/*/.cache/chromium/*</code>, и <code>/home/*/.local/share/Trash/*</code>, в зависимости от программного обеспечения, установленного в системе.</li>
<li>Если установлен <a href="../ru/File_manager_functionality.html#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" class="mw-redirect" title="GVFS (Русский)">GVFS</a>, то необходимо исключить <code>/home/*/.gvfs</code> чтобы избежать ошибок rsync.</li>
<li>Если установлен <a href="../ru/Dhcpcd.html" title="Dhcpcd (Русский)">Dhcpcd</a> ≥ 9.0.0, исключите каталог <code>/var/lib/dhcpcd/*</code> т.к. dhcpcd монтирует туда несколько системных каталогов в качестве подкаталогов.</li>
</ul>
</div>
<p>Возможно вы захотите добавить или убрать некоторые опции <a class="mw-selflink selflink">rsync</a>, например следующие. См. <span class="plainlinks archwiki-template-man" title="$ man 1 rsync"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/rsync.1">rsync(1)</a></span> для полного списка.
</p>
<ul>
<li>Если в вашей системе очень мало памяти, может иметь смысл убрать опцию {{ic|-H}; однако это не должно быть проблемой на большинстве современных устройств. Количество жёстких ссылок в файловой системе может быть большим при использовании некоторых программ, например <a href="../en/Flatpak.html" title="Flatpak">Flatpak</a>. Много жёстких ссылок находится в каталоге <code>/usr/</code>.</li>
<li>Вы можете захотеть добавить опцию rsync <code>--delete</code>, если запускаете его несколько раз для одного и того же каталога. В этом случае, убедитесь, что каталог источника на заканчивается на <code>/*</code>, иначе эта опция затронет файлы внутри подкаталогов источника, но не затронет файлы, находящиеся в самом источнике.</li>
<li>Если вы используете разреженные файлы, такие как виртуальные диски, образы <a href="../ru/Docker.html" title="Docker (Русский)">Docker</a> и т.п., добавьте опцию <code>-S</code>.</li>
<li>Опция <code>--numeric-ids</code> отключит сопоставление имён для групп и пользователей; вместо этого передаваться будут цифровые идентификаторы групп и пользователей. Это полезно при резервном копировании через <a href="../ru/OpenSSH.html" class="mw-redirect" title="SSH (Русский)">SSH</a> или при использовании live системы для резервного копирования другого системного диска.</li>
<li>Выбрав опцию <code>--info=progress2</code> вместо <code>-v</code>, вы увидите информацию об общем прогрессе и скорости передачи вместо списка передаваемых файлов.</li>
<li>Для избежания выхода за пределы файловой системы при рекурсивном обходе, добавьте опцию <code>-x</code>/<code>--one-file-system</code>. Она предотвратит резервное копирование любых точек монтирования в иерархии.</li>
</ul>
<h3>
<span id=".D0.92.D0.BE.D1.81.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B9_.D0.BA.D0.BE.D0.BF.D0.B8.D0.B8"></span><span class="mw-headline" id="Восстановление_резервной_копии">Восстановление резервной копии</span>
</h3>
<p>Если вы желаете восстановить резервную копию, используйте запущенную ранее команду rsync, поменяв источник и назначение.
</p>
<h2>
<span id=".D0.9A.D0.BB.D0.BE.D0.BD.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.BE.D0.B9_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Клонирование_файловой_системы">Клонирование файловой системы</span>
</h2>
<p>rsync предоставляет способ создания копии всех данных в файловой системы с сохранением максимально возможного количества информации, включая метаданные файловой системы. Это процедура клонирования на уровне файловой системы, где файловые системы источника и назначения не обязаны совпадать. Она может использоваться для резервного копирования, смены файловой системы или восстановления данных.
</p>
<p>Режим <i>архива</i> rsync неплохо подходит для этой цели, но он не создаёт резервную копию специальных метаданных файловой системы, таких как списки контроля доступа, расширенные атрибуты или свойства разреженных файлов. Для успешного копирования на уровне файловой системы, некоторые дополнительные опции должны быть включены:
</p>
<pre>rsync -qaHAXS ИСТОЧНИК НАЗНАЧЕНИЕ
</pre>
<p>Их значение (из справочной страницы):
</p>
<pre>--hard-links, -H      сохранять жёсткие ссылки
--acls, -A            сохранять списки контроля доступа (вызывает --perms)
--xattrs, -X          сохранять расширенные атрибуты
--sparse, -S          сжимать последовательности нулей в разреженные блоки
</pre>
<p>Кроме того, используйте <code>-x</code>, если другие файловые системы, которые желаете исключить из копии, примонтированы в дерево.
</p>
<p>Полученная копия может быть легко прочитана заново и проверена (например после попытки восстановления файлов) на уровне файловой системы с помощью рекурсивной опции <code>diff</code>:
</p>
<pre>diff -r ИСТОЧНИК НАЗНАЧЕНИЕ
</pre>
<p>Возможно осуществить успешный переход на другую файловую систему, используя rsync как описано в этой статье и обновив <a href="../ru/Fstab.html" title="Fstab (Русский)">fstab</a> и <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Загрузчик">загрузчик</a>, как описано в <a href="../en/Migrate_installation_to_new_hardware.html" title="Migrate installation to new hardware">Перенос установки на новое оборудование</a> (англ.). Это в сущности позволяет поменять любую корневую файловую систему на любую другую.
</p>
<h2>
<span id=".D0.94.D0.B5.D0.BC.D0.BE.D0.BD_rsync"></span><span class="mw-headline" id="Демон_rsync">Демон rsync</span>
</h2>
<p><i>rsync</i> можно запускать на сервере в качестве демона, слушающего порт <code>873</code>.
</p>
<p>Отредактируйте шаблон <code>/etc/rsyncd.conf</code>, настройте общий доступ и <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Запустите">запустите</a> <code>rsyncd.service</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> На момент <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rsync">rsync</a></span> 3.2.0-1 пакет использует файлы модулей systemd <code>rsyncd.service</code> и <code>rsyncd@.service</code>. Изменение <code>ProtectHome</code> было закомментировано, функция безопасности <code>ProtectSystem=full</code> в разделе <code>[Service]</code> до сих пор активна. Это делает каталоги <code>/boot/</code>, <code>/etc/</code> и <code>/usr/</code> доступными только для чтения. Если вы хотите, чтобы rsyncd записывал в системные каталоги, <a href="../ru/Systemd.html#%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%BD%D1%8B%D1%85_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%B0%D0%BC%D0%B8_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Отредактируйте">отредактируйте</a> модуль и установите <code>ProtectSystem=off</code> в разделе <code>[Service]</code> переопределяемого фрагмента.</div>
<p>Использование на клиенте, например перечисление содержимого сервера:
</p>
<pre>$ rsync rsync://<i>server/share</i>
</pre>
<p>перемещение файла с клиента на сервер:
</p>
<pre>$ rsync <i>локальный-файл</i> rsync://<i>server/share/</i>
</pre>
<p>Подумайте об использовании iptables для открытия порта <code>873</code> и аутентификации пользователей.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Все перемещаемые данные, включая данные аутентификации пользователя не шифруются.</div>
<h3>
<span id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Пример_конфигурации">Пример конфигурации</span>
</h3>
<h4>
<span id=".D0.A0.D0.B0.D0.B7.D0.B4.D0.B0.D1.87.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.BF.D0.BE_.D1.81.D0.BF.D0.B8.D1.81.D0.BA.D1.83"></span><span class="mw-headline" id="Раздача_файлов_по_списку">Раздача файлов по списку</span>
</h4>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsyncd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...

# Необходимо при пересечении границ файловой системы.
#use chroot  = no
read only = yes

...

[sync]
    path         = /
# Список файлов для копирования.
    include from = /backup.list
# Исключение оставшихся.
    exclude      = *</pre>
<p>Все <i>промежуточные пути</i> необходимы в списке файлов, если не используется шаблон <code>***</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/backup.list</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/etc/
/etc/conf.d/
/etc/conf.d/hwclock
/etc/fonts/***
</pre>
<h2>
<span id=".D0.A1.D0.BC._.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="См._также">См. также</span>
</h2>
<ul>
<li>Больше примеров использования можно найти на форумах <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewforum.php?id=27">Вклад Сообщества</a> (англ.) и <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewforum.php?id=33">Общее Программирование</a> (англ.)</li>
<li>
<a rel="nofollow" class="external text" href="http://www.pointsoftware.ch/en/howto-local-and-remote-snapshot-backup-using-rsync-with-hard-links/">Локальные и удалённые снимки с использованием rsync и жёстких ссылок</a><sup>[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">устаревшая ссылка</a> 2020-04-02]</sup> Включает дедупликацию файлов с помощью жёстких ссылок, MD5 подписи, защиту 'chattr', правил фильтров, квоту на диск, политику хранения с экспоненциальным распределением (ротация резервных копий с сохранением большего числа недавних копий, чем более старых)</li>
<li>
<a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/5527068/how-do-you-use-an-identity-file-with-rsync">Использование файлов ключей/идентификатора SSH с rsync</a> (англ.)</li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../ru/Category:Synchronization.html" title="Category:Synchronization (Русский)">Synchronization (Русский)</a></li>
<li><a href="../ru/Category:Backup.html" title="Category:Backup (Русский)">Backup (Русский)</a></li>
<li><a href="../ru/Category:Commands.html" title="Category:Commands (Русский)">Commands (Русский)</a></li>
</ul>
</div></div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Rsync_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=648095">https://wiki.archlinux.org/index.php?title=Rsync_(Русский)&amp;oldid=648095</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 3 January 2021, at 12:35.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
