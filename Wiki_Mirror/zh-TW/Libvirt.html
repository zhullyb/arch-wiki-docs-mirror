<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Libvirt (正體中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Libvirt_正體中文 rootpage-Libvirt_正體中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Libvirt (正體中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="../en/Category:Hypervisors.html" title="Category:Hypervisors">Category:Hypervisors</a></li>
<li><a href="../en/QEMU.html" title="QEMU">QEMU</a></li>
<li><a href="../en/KVM.html" title="KVM">KVM</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻譯狀態：</strong>本文章是 <a href="../en/Libvirt.html" title="Libvirt">Libvirt</a> 的翻譯版本。最近一次的翻譯時間：2016-03-10。點擊<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Libvirt&amp;diff=0&amp;oldid=413990">本連結</a>查看英文頁面之後的變更。</div>
<p>Libvirt 是一組軟體的匯集，提供了管理虛擬機器和其它虛擬化功能（如：儲存和虛擬網路等）的便利途徑。這些軟體主要包括：一個長期穩定的 API、一個守護程序（libvirtd）、一些命令列工具（如virsh、virt-install等）和一些GUI工具（如virt-manager等）。Libvirt 的主要目標是提供一個單一途徑以管理多種不同虛擬化方案以及虛擬化主機，包括：<a href="../en/QEMU.html" title="QEMU">KVM/QEMU</a>，<a href="../en/Xen.html" title="Xen">Xen</a>，<a href="../en/Linux_Containers.html" class="mw-redirect" title="LXC">LXC</a>，<a rel="nofollow" class="external text" href="http://openvz.org">OpenVZ</a> 或 <a href="../en/VirtualBox.html" title="VirtualBox">VirtualBox</a> <a href="../en/Category:Hypervisors.html" title="Category:Hypervisors">hypervisors</a> （<a rel="nofollow" class="external text" href="http://libvirt.org/drivers.html">詳見這裡</a>）。
</p>
<p>Libvirt 的一些主要功能如下：
</p>
<ul>
<li>
<b>VM management（虛擬機器管理）</b>：如：開機、停止、暫停、保存、恢復和迁移等；多種不同類型裝置的熱插拔操作，包括硬碟、網路卡、記憶體、CPU等。</li>
<li>
<b>Remote machine support（支援遠端連線）</b>：Libvirt 的所有功能都可以在執行著libvirt  daemon的機器上執行，包括遠端機器。通過最簡便且無需額外配置的 SSH 協定，遠端連線可支援多種網路連線方式。</li>
<li>
<b>Storage management（存儲管理）</b>：任何執行 libvirt 守護程序的主機都可以用于管理多種類型的的存儲：創建多種類型的鏡像檔（qcow2，qed，vmdk，raw，...），掛載 NFS 共用，枚舉現有 LVM 捲軸，新增新的 LVM 磁區，對裸磁碟裝置分割，掛載 iSCSI 共用，以及更多......</li>
<li>
<b>Network interface management（網路介面管理）</b>：任何執行 libvirt 守護程序的主機都可以用于管理物理的和邏輯的網路介面，枚舉現有介面，配置（和創建）介面、橋接、VLAN、連接埠綁定。</li>
<li>
<b>Virtual NAT and Route based networking（虛擬NAT 和基於路由的網路）</b>：任何執行libvirt 守護程序的主機都可以管理和創建虛擬網路。Libvirt 虛擬網路使用<a href="../en/Iptables.html" title="Iptables">iptables防火牆</a>規則實現一个路由器，為虛擬機器提供到主機網路的透明存取。</li>
</ul>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#%E5%AE%89%E8%A3%9D"><span class="tocnumber">1</span> <span class="toctext">安裝</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#%E4%BC%BA%E6%9C%8D%E5%99%A8%E7%AB%AF"><span class="tocnumber">1.1</span> <span class="toctext">伺服器端</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#%E7%94%A8%E6%88%B6%E7%AB%AF"><span class="tocnumber">1.2</span> <span class="toctext">用戶端</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4">
<a href="#%E9%85%8D%E7%BD%AE"><span class="tocnumber">2</span> <span class="toctext">配置</span></a>
<ul>
<li class="toclevel-2 tocsection-5">
<a href="#%E8%A8%AD%E5%AE%9A%E6%8E%88%E6%AC%8A"><span class="tocnumber">2.1</span> <span class="toctext">設定授權</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#%E4%BD%BF%E7%94%A8_polkit"><span class="tocnumber">2.1.1</span> <span class="toctext">使用 polkit</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#%E5%9F%BA%E6%96%BC%E6%AA%94%E6%A1%88%E7%9A%84%E6%AC%8A%E9%99%90%E6%8E%88%E6%AC%8A"><span class="tocnumber">2.1.2</span> <span class="toctext">基於檔案的權限授權</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8"><a href="#%E5%AE%88%E8%AD%B7%E7%A8%8B%E5%BA%8F"><span class="tocnumber">2.2</span> <span class="toctext">守護程序</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#%E9%9D%9E%E5%8A%A0%E5%AF%86%E7%9A%84_TCP/IP_sockets"><span class="tocnumber">2.3</span> <span class="toctext">非加密的 TCP/IP sockets</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#%E6%B8%AC%E8%A9%A6"><span class="tocnumber">3</span> <span class="toctext">測試</span></a></li>
<li class="toclevel-1 tocsection-11">
<a href="#%E7%AE%A1%E7%90%86"><span class="tocnumber">4</span> <span class="toctext">管理</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="#virsh"><span class="tocnumber">4.1</span> <span class="toctext">virsh</span></a></li>
<li class="toclevel-2 tocsection-13">
<a href="#%E5%84%B2%E5%AD%98pool"><span class="tocnumber">4.2</span> <span class="toctext">儲存pool</span></a>
<ul>
<li class="toclevel-3 tocsection-14"><a href="#%E7%94%A8_virsh_%E6%96%B0%E5%A2%9E%E5%AD%98%E5%84%B2Pool"><span class="tocnumber">4.2.1</span> <span class="toctext">用 virsh 新增存儲Pool</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#%E7%94%A8_virt-manager_%E6%96%B0%E5%A2%9E%E5%84%B2%E5%AD%98Pool"><span class="tocnumber">4.2.2</span> <span class="toctext">用 virt-manager 新增儲存Pool</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-16">
<a href="#%E5%AD%98%E5%84%B2%E7%A3%81%E5%8D%80"><span class="tocnumber">4.3</span> <span class="toctext">存儲磁區</span></a>
<ul>
<li class="toclevel-3 tocsection-17"><a href="#%E7%94%A8_virsh_%E6%96%B0%E5%A2%9E%E7%A3%81%E5%8D%80"><span class="tocnumber">4.3.1</span> <span class="toctext">用 virsh 新增磁區</span></a></li>
<li class="toclevel-3 tocsection-18"><a href="#virt-manager_%E5%BE%8C%E5%82%99%E5%84%B2%E5%AD%98%E9%A1%9E%E5%9E%8B%E7%9A%84_bug"><span class="tocnumber">4.3.2</span> <span class="toctext">virt-manager 後備儲存類型的 bug</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-19">
<a href="#%E8%99%9B%E6%93%AC%E6%A9%9F"><span class="tocnumber">4.4</span> <span class="toctext">虛擬機</span></a>
<ul>
<li class="toclevel-3 tocsection-20"><a href="#%E7%94%A8_virt-install_%E6%96%B0%E5%A2%9E%E8%99%9B%E6%93%AC%E6%A9%9F%E5%99%A8"><span class="tocnumber">4.4.1</span> <span class="toctext">用 virt-install 新增虛擬機器</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="#%E7%94%A8_virt-manager_%E6%96%B0%E5%A2%9E%E8%99%9B%E6%93%AC%E6%A9%9F%E5%99%A8"><span class="tocnumber">4.4.2</span> <span class="toctext">用 virt-manager 新增虛擬機器</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="#%E7%AE%A1%E7%90%86%E8%99%9B%E6%93%AC%E6%A9%9F"><span class="tocnumber">4.4.3</span> <span class="toctext">管理虛擬機</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-23"><a href="#%E7%B6%B2%E8%B7%AF"><span class="tocnumber">4.5</span> <span class="toctext">網路</span></a></li>
<li class="toclevel-2 tocsection-24">
<a href="#%E5%BF%AB%E7%85%A7"><span class="tocnumber">4.6</span> <span class="toctext">快照</span></a>
<ul>
<li class="toclevel-3 tocsection-25"><a href="#%E6%96%B0%E5%A2%9E%E5%BF%AB%E7%85%A7"><span class="tocnumber">4.6.1</span> <span class="toctext">新增快照</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-26"><a href="#%E5%85%B6%E4%BB%96%E7%AE%A1%E7%90%86%E6%93%8D%E4%BD%9C"><span class="tocnumber">4.7</span> <span class="toctext">其他管理操作</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-27"><a href="#Python_%E9%80%A3%E6%8E%A5%E4%BB%A3%E7%A2%BC"><span class="tocnumber">5</span> <span class="toctext">Python 連接代碼</span></a></li>
<li class="toclevel-1 tocsection-28"><a href="#%E5%8F%83%E9%96%B1"><span class="tocnumber">6</span> <span class="toctext">參閱</span></a></li>
</ul>
</div>

<h2>
<span id=".E5.AE.89.E8.A3.9D"></span><span class="mw-headline" id="安裝">安裝</span>
</h2>
<p>基於守護程序/用戶端的架構的 libvirt 只需要安裝在需要實現虛擬化的機器上。當然，libvirt伺服器和libvirt用戶端可以是相同的物理機器。
</p>
<h3>
<span id=".E4.BC.BA.E6.9C.8D.E5.99.A8.E7.AB.AF"></span><span class="mw-headline" id="伺服器端">伺服器端</span>
</h3>
<p><a href="../zh-TW/Help:Reading.html#%E5%AE%89%E8%A3%9D%E5%A5%97%E4%BB%B6" class="mw-redirect" title="安裝">安裝</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libvirt">libvirt</a></span> 以及至少一個管理程式（hypervisor）：
</p>
<ul><li>截至 2015-02-01，啟動 <code>libvirtd</code> <b>必須</b>在系統上安裝 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=qemu">qemu</a></span>（参參見<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/41888">FS#41888</a>）。好在， <a rel="nofollow" class="external text" href="http://libvirt.org/drvqemu.html">libvirt 的 KVM/QEMU 驅動</a> 是 <i>libvirt</i> 的，如果 <a href="../en/QEMU.html#Enabling_KVM" title="QEMU">KVM 功能已啟用</a>，首選驅動則支援全虛擬化和硬體加速加速的用戶機。詳見 <a href="../en/QEMU.html" title="QEMU">QEMU</a>。</li></ul>
<ul><li>其他虛擬機器後端，包括 <a href="../en/Linux_Containers.html" class="mw-redirect" title="LXC">LXC</a>, <a href="../en/Xen.html" title="Xen">Xen</a> 和 <a href="../en/VirtualBox.html" title="VirtualBox">VirtualBox</a>。請參見他們各自的安裝說明。</li></ul>
<dl>
<dd><div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> <a rel="nofollow" class="external text" href="http://libvirt.org/drvlxc.html">Libvirt 的 LXC 驅動</a> 並不依賴 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=lxc">lxc</a></span> 提供的使用這空間工具，因此，如果計畫使用這個驅動並不需要安裝該工具。</div></dd>
<dd><div class="archwiki-template-box archwiki-template-box-warning">
<strong>警告：</strong> Libvirt 預設未支援 <a href="../en/Xen.html" title="Xen">Xen</a>。需要用 <a href="../en/Arch_Build_System.html" class="mw-redirect" title="ABS">ABS</a> 編輯 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libvirt">libvirt</a></span> 的 <a href="../en/PKGBUILD.html" title="PKGBUILD">PKGBUILD</a> ，去掉 <code>--without-xen</code> 選項後重新構建（built）libvirt。</div></dd>
</dl>
<p>其它虛擬機器管理式的列表见<a rel="nofollow" class="external text" href="http://libvirt.org/drivers.html">这里</a>。
</p>
<p>對於網路連線，安裝這些包：
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ebtables">ebtables</a></span> <b>和</b> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnsmasq">dnsmasq</a></span> 用於 <a rel="nofollow" class="external text" href="http://wiki.libvirt.org/page/VirtualNetworking#The_default_configuration">預設的</a> NAT/DHCP網路</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bridge-utils">bridge-utils</a></span> 用於橋接網路</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openbsd-netcat">openbsd-netcat</a></span> 經由 <a href="../en/Secure_Shell.html" class="mw-redirect" title="SSH">SSH</a> 遠端管理</li>
</ul>
<h3>
<span id=".E7.94.A8.E6.88.B6.E7.AB.AF"></span><span class="mw-headline" id="用戶端">用戶端</span>
</h3>
<p>用戶端是用於管理和存取虛擬機器的使用者界面。
</p>
<ul><li>
<i>virsh</i> 用於管理和配置（域）的命令列程式；它包含在 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libvirt">libvirt</a></span> 中。</li></ul>
<p>虛擬機* <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-manager">virt-manager</a></span> 用於管理虛擬機的GUI。
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virtviewer">virtviewer</a></span><sup>[<a href="../en/Help:Procedures.html#Fix_broken_package_links" title="Help:Procedures">broken link</a>: replaced by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-viewer">virt-viewer</a></span>]</sup> 用於顯示並與虛擬化用戶機作業系統進行交互</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=gnome-boxes">gnome-boxes</a></span> 簡單的 GNOME 3 程式，存取遠端虛擬系統</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/libvirt-sandbox/">libvirt-sandbox</a></span><sup><small>AUR</small></sup> 應用程式沙箱工具包</li>
</ul>
<p>相容 libvirt 的軟體列表見<a rel="nofollow" class="external autonumber" href="http://libvirt.org/apps.html">[1]</a>.
</p>
<h2>
<span id=".E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="配置">配置</span>
</h2>
<p>對於<i><b>系統</b></i> 級別的管理工作（如：全局配置和鏡像位置），libvirt 要求至少要<a href="#%E8%A8%AD%E5%AE%9A%E6%8E%88%E6%AC%8A">設定授權</a>和<a href="#%E5%AE%88%E8%AD%B7%E7%A8%8B%E5%BA%8F">啟動守護程序</a>。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 對於使用者<i><b>工作階段</b></i> 級別的管理任務，守護程序的安裝和設定<i>不是</i> 必須的。授權總是僅限本地，前台程式將啟動一个 <b>libvirtd</b> 守護程序的本地實例。</div>
<h3>
<span id=".E8.A8.AD.E5.AE.9A.E6.8E.88.E6.AC.8A"></span><span class="mw-headline" id="設定授權">設定授權</span>
</h3>
<p>來自 <a rel="nofollow" class="external text" href="http://libvirt.org/auth.html#ACL_server_config">libvirt：連線授權</a>：
</p>
<dl><dd>Libvirt daemon允許管理員分別為用戶端連線的每個網路 socket 選擇不同授權機制。這主要是通過 libvirt 守護程序的主設定檔 <code>/etc/libvirt/libvirtd.conf</code> 來實現的。每個 libvirt socket 可以有獨立的授權機制配置。目前的可選項有 <code>none</code>、<code>polkit</code> 和 <code>sasl</code>。</dd></dl>
<p>由於  <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libvirt">libvirt</a></span> 在安裝時將把 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=polkit">polkit</a></span> 作為依賴一併安裝，所以 <a href="#%E4%BD%BF%E7%94%A8_polkit">polkit</a> 通常是 <code>unix_sock_auth</code> 參數的預設值（<a rel="nofollow" class="external text" href="http://libvirt.org/auth.html#ACL_server_polkit">來源</a>）。但<a href="#%E5%9F%BA%E6%96%BC%E6%AA%94%E6%A1%88%E7%9A%84%E6%AC%8A%E9%99%90%E6%8E%88%E6%AC%8A">基於檔案的權限</a>仍然可用。
</p>
<h4>
<span id=".E4.BD.BF.E7.94.A8_polkit"></span><span class="mw-headline" id="使用_polkit">使用 polkit</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 為了使 <code>polkit</code> 認證工作正常，應該重新啟動一次系統。</div>
<p><i>libvirt</i>  daemon在 polkit 策略設定檔（<code>/usr/share/polkit-1/actions/org.libvirt.unix.policy</code>）中提供了2種  <a href="../zh-CN/Polkit.html#%E8%A1%8C%E4%B8%BA" title="Polkit (简体中文)">行為</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup> 策略：
</p>
<ul>
<li>
<code>org.libvirt.unix.manage</code> 面向完全的管理存取（讀寫模式的後台 socket），以及</li>
<li>
<code>org.libvirt.unix.monitor</code> 面向僅監視查看存取（唯讀 socket）。</li>
</ul>
<p>預設的面向讀寫模式後台 socket 的策略將請求認證為管理者。這類似於 <a href="../en/Sudo.html" title="Sudo">sudo</a> 認證，但它並不要求用戶應用最終以 root 身分執行。預設策略下也仍然允許任何應用連線到唯讀 socket。
</p>
<p>Arch Linux 預設 <code>wheel</code> 組的所有實驗者都是管理員身分：定義於 <code>/etc/polkit-1/rules.d/50-default.rules</code>（參閱<a href="../zh-CN/Polkit.html#%E7%AE%A1%E7%90%86%E5%91%98%E6%A0%87%E8%AF%86" title="Polkit (简体中文)">管理员标识</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup>）。這樣就不必新增組和規則檔案。 <b>如果用户是 <code>wheel</code> 群組的成員</b>：只要連線到了讀寫模式 socket（例如通过 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-manager">virt-manager</a></span>）就會被提示輸入該使用者的口令。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 要求口令的提示由系統中的 <a href="../zh-CN/Polkit.html#%E8%AE%A4%E8%AF%81%E4%BB%A3%E7%90%86" title="Polkit (简体中文)">認證代理</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup> 給出。文本控制台預設的認證代理是 <code>pkttyagent</code> 它可能因工作不正常而導致各種問題。</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> 如果要配置無密碼認證，參考 <a href="../en/Polkit.html#Bypass_password_prompt" title="Polkit">跳過密碼提示</a>。</div>
<p>從 libvirt 1.2.16 開始（提案見：<a rel="nofollow" class="external autonumber" href="http://libvirt.org/git/?p=libvirt.git;a=commit;h=e94979e901517af9fdde358d7b7c92cc055dd50c">[2]</a>），<code>libvirt</code> 組的成員使用者預設可以無密碼存取讀寫模式 socket。最簡單的判斷方法就是看 libvirt 組是否存在並且使用者是否為該組成員。如果要把 kvm 組存取讀寫模式後台 socket 的認證策略改為免認證模式，可創建下面的檔案：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/polkit-1/rules.d/50-libvirt.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/* Allow users in kvm group to manage the libvirt daemon without authentication（允許 kvm 組的使用者管理 libvirt 而無需認證）
*/
polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.unix.manage" &amp;&amp;
        subject.isInGroup("kvm")) {
            return polkit.Result.YES;
    }
});
</pre>
<p>然後 <a href="/index.php?title=Users_and_group&amp;action=edit&amp;redlink=1" class="new" title="Users and group (page does not exist)">新增使用者</a> 到 <code>kvm</code> 組并重新登入。<i>kvm</i> 也可以是任何其它存在的組並且用戶是該組的成員（詳情請閱讀 <a href="/index.php?title=%E4%BD%BF%E7%94%A8%E8%80%85%E5%92%8C%E4%BD%BF%E7%94%A8%E8%80%85%E7%BE%A4%E7%B5%84&amp;action=edit&amp;redlink=1" class="new" title="使用者和使用者群組 (page does not exist)">使用者和使用者群組</a>）。
</p>
<p>修改組之後別忘了重新登入才能生效。
</p>
<h4>
<span id=".E5.9F.BA.E6.96.BC.E6.AA.94.E6.A1.88.E7.9A.84.E6.AC.8A.E9.99.90.E6.8E.88.E6.AC.8A"></span><span class="mw-headline" id="基於檔案的權限授權">基於檔案的權限授權</span>
</h4>
<p>為了給 <i>libvirt</i> 組使用者定義基於檔案的權限以管理虛擬機器，取消下列行的註釋：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/libvirt/libvirtd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#unix_sock_group = "libvirt"
#unix_sock_ro_perms = "0777"  # set to 0770 to deny non-group libvirt users
#unix_sock_rw_perms = "0770"
#auth_unix_ro = "none"
#auth_unix_rw = "none"
</pre>
<p>有些資料提到可以通過改變某些特定 libvirt 目錄的權限以簡化管理。需要記住的是：包更新時，這些變更會遺失。如要修改這些系統目錄的權限，需要 root 使用者權限。
</p>
<h3>
<span id=".E5.AE.88.E8.AD.B7.E7.A8.8B.E5.BA.8F"></span><span class="mw-headline" id="守護程序">守護程序</span>
</h3>
<p><code>libvirtd.service</code> 和 <code>virtlogd.service</code>2個服務都要 <a href="../zh-TW/Systemd.html" title="Systemd (正體中文)">啟動</a>。可以把 <code>libvirtd.service</code> 設定為 <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">啟用</a>，這時系統將同時啟用 <code>virtlogd.service</code> 和 <code>virtlockd.socket</code> 兩個服務 <a href="../zh-TW/Systemd.html" title="Systemd (正體中文)">單元</a>，因此後二者不必再設置為啟用。
</p>
<h3>
<span id=".E9.9D.9E.E5.8A.A0.E5.AF.86.E7.9A.84_TCP.2FIP_sockets"></span><span class="mw-headline" id="非加密的_TCP/IP_sockets">非加密的 TCP/IP sockets</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>警告：</strong> 這種方法常用於在可信網路中快速連線遠端虛擬機做協助。這是<i><b>最不安全</b></i> 的連線方式，應當<i>僅僅</i> 用於測試或用於安全、私密和可信的網路環境。這時 SASL 沒有啟用，所以所有的 TCP 通訊都是明文傳輸。在正式的應用場合應當<i>始終</i> 啟用SASL。</div>
<p>編輯 <code>/etc/libvirt/libvirtd.conf</code>：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/libvirt/libvirtd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">listen_tls = 0
listen_tcp = 1
auth_tcp=none
</pre>
<p>It is also necessary to start the server in listening mode by editing <code>/etc/conf.d/libvirtd</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/conf.d/libvirtd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">LIBVIRTD_ARGS="--listen"</pre>
<h2>
<span id=".E6.B8.AC.E8.A9.A6"></span><span class="mw-headline" id="測試">測試</span>
</h2>
<p>To test if libvirt is working properly on a <i>system</i> level:
</p>
<pre>$ virsh -c qemu:///system
</pre>
<p>To test if libvirt is working properly for a user-<i>session</i>:
</p>
<pre>$ virsh -c qemu:///session
</pre>
<h2>
<span id=".E7.AE.A1.E7.90.86"></span><span class="mw-headline" id="管理">管理</span>
</h2>
<p>Libvirt management is done mostly with three tools: <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-manager">virt-manager</a></span> (GUI), <code>virsh</code>, and <code>guestfish</code> (which is part of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libguestfs">libguestfs</a></span>).
</p>
<h3><span class="mw-headline" id="virsh">virsh</span></h3>
<p>The virsh program is for managing guest <i>domains</i> (virtual machines) and works well for scripting, virtualization administration.  Though most virsh commands require root privileges to run due to the communication channels used to talk to the hypervisor, typical management, creation, and running of domains (like that done with VirtualBox) can be done as a regular user.
</p>
<p>Virsh includes an interactive terminal that can be entered if no commands are passed (options are allowed though): <code>virsh</code>.  The interactive terminal has support for tab completion.
</p>
<p>From the command line:
</p>
<pre>$ virsh [option] &lt;command&gt; [argument]...
</pre>
<p>From the interactive terminal:
</p>
<pre>virsh # &lt;command&gt; [argument]...
</pre>
<p>Help is available:
</p>
<pre>$ virsh help [option*] or [group-keyword*]
</pre>
<h3>
<span id=".E5.84.B2.E5.AD.98pool"></span><span class="mw-headline" id="儲存pool">儲存pool</span>
</h3>
<p>A pool is a location where storage <i>volumes</i> can be kept.  What libvirt defines as <i>volumes</i> others may define as "virtual disks" or "virtual machine images".  Pool locations may be a directory, a network filesystem, or partition (this includes a <a href="../en/LVM.html" title="LVM">LVM</a>).  Pools can be toggled active or inactive and allocated for space.
</p>
<p>On the <i>system</i>-level, <code>/var/lib/libvirt/images/</code> will be activated by default; on a user-<i>session</i>, <code>virt-manager</code> creates <code>$HOME/VirtualMachines</code>.
</p>
<p>Print active and inactive storage pools:
</p>
<pre>$ virsh pool-list --all
</pre>
<h4>
<span id=".E7.94.A8_virsh_.E6.96.B0.E5.A2.9E.E5.AD.98.E5.84.B2Pool"></span><span class="mw-headline" id="用_virsh_新增存儲Pool">用 virsh 新增存儲Pool</span>
</h4>
<p>If wanted to <i>add</i> a storage pool, here are examples of the command form, adding a directory, and adding a LVM volume:
</p>
<pre>$ virsh pool-define-as name type [source-host] [source-path] [source-dev] [source-name] [&lt;target&gt;] [--source-format format]
$ virsh pool-define-as <i>poolname</i> dir - - - - /home/<i>username</i>/.local/libvirt/images
$ virsh pool-define-as <i>poolname</i> fs - -  <i>/dev/vg0/images</i> - <i>mntpoint</i>
</pre>
<p>The above command defines the information for the pool, to build it:
</p>
<pre>$ virsh pool-build     <i>poolname</i>
$ virsh pool-start     <i>poolname</i>
$ virsh pool-autostart <i>poolname</i>
</pre>
<p>To remove it:
</p>
<pre>$ virsh pool-undefine  <i>poolname</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> For LVM storage pools:
<ul>
<li>It is a good practice to dedicate a volume group to the storage pool only.</li>
<li>Choose a LVM volume group that differs from the pool name, otherwise when the storage pool is deleted the LVM group will be too.</li>
</ul>
</div>
<h4>
<span id=".E7.94.A8_virt-manager_.E6.96.B0.E5.A2.9E.E5.84.B2.E5.AD.98Pool"></span><span class="mw-headline" id="用_virt-manager_新增儲存Pool">用 virt-manager 新增儲存Pool</span>
</h4>
<p>First, connect to a hypervisor (e.g. QEMU/KVM <i>system</i>, or user-<i>session</i>).  Then, right-click on a connection and select <i>Details</i>; select the <i>Storage</i> tab, push the <i>+</i> button on the lower-left, and follow the wizard.
</p>
<h3>
<span id=".E5.AD.98.E5.84.B2.E7.A3.81.E5.8D.80"></span><span class="mw-headline" id="存儲磁區">存儲磁區</span>
</h3>
<p>Once the pool has been created, volumes can be created inside the pool.  <i>If building a new domain (virtual machine), this step can be skipped as a volume can be created in the domain creation process.</i>
</p>
<h4>
<span id=".E7.94.A8_virsh_.E6.96.B0.E5.A2.9E.E7.A3.81.E5.8D.80"></span><span class="mw-headline" id="用_virsh_新增磁區">用 virsh 新增磁區</span>
</h4>
<p>Create volume, list volumes, resize, and delete:
</p>
<pre>$ virsh vol-create-as      <i>poolname</i> <i>volumename</i> 10GiB
$ virsh vol-list           <i>poolname</i>
$ virsh vol-resize  --pool <i>poolname</i> <i>volumename</i> 12GiB
$ virsh vol-delete  --pool <i>poolname</i> <i>volumename</i>
$ virsh vol-dumpxml --pool <i>poolname</i> <i>volumename</i>  # for details.
</pre>
<h4>
<span id="virt-manager_.E5.BE.8C.E5.82.99.E5.84.B2.E5.AD.98.E9.A1.9E.E5.9E.8B.E7.9A.84_bug"></span><span class="mw-headline" id="virt-manager_後備儲存類型的_bug">virt-manager 後備儲存類型的 bug</span>
</h4>
<p>On newer versions of <code>virt-manager</code> you can now specify a backing store to use when creating a new disk. This is very useful, in that you can have new domains be based on base images saving you both time and disk space when provisioning new virtual systems. There is a bug (<a rel="nofollow" class="external free" href="https://bugzilla.redhat.com/show_bug.cgi?id=1235406">https://bugzilla.redhat.com/show_bug.cgi?id=1235406</a>) in the current version of <code>virt-manager</code> which causes <code>virt-manager</code> to choose the wrong type of the backing image in the case where the backing image is a <code>qcow2</code> type. In this case, it will errantly pick the backing type as <code>raw</code>. This will cause the new image to be unable to read from the backing store, and effectively remove the utility of having a backing store at all.
</p>
<p>There is a workaround for this issue. <code>qemu-img</code> has long been able to do this operation directly. If you wish to have a backing store for your new domain before this bug is fixed, you may use the following command.
</p>
<pre>$ qemu-img create -f qcow2 -o backing_file=&lt;path to backing image&gt;,backing_fmt=qcow2 &lt;disk name&gt; &lt;disk size&gt;
</pre>
<p>Then you can use this image as the base for your new domain and it will use the backing store as a COW volume saving you time and disk space.
</p>
<h3>
<span id=".E8.99.9B.E6.93.AC.E6.A9.9F"></span><span class="mw-headline" id="虛擬機">虛擬機</span>
</h3>
<p>Virtual machines are called <i>domains</i>.  If working from the command line, use <code>virsh</code> to list, create, pause, shutdown domains, etc.  <code>virt-viewer</code> can be used to view domains started with <code>virsh</code>.  Creation of domains is typically done either graphically with <code>virt-manager</code> or with <code>virt-install</code> (a command line program that is part of the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-manager">virt-manager</a></span> package).
</p>
<p>Creating a new domain typically involves using some installation media, such as an <code>.iso</code> from the storage pool or an optical drive.
</p>
<p>Print active and inactive domains:
</p>
<pre># virsh list --all
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <a href="../en/SELinux.html" title="SELinux">SELinux</a> has a built-in exemption for libvirt that allows volumes in <code>/var/lib/libvirt/images/</code> to be accessed.  If using SELinux and there are issues with the volumes, ensure that volumes are in that directory, or ensure that other storage pools are correctly labeled.</div>
<h4>
<span id=".E7.94.A8_virt-install_.E6.96.B0.E5.A2.9E.E8.99.9B.E6.93.AC.E6.A9.9F.E5.99.A8"></span><span class="mw-headline" id="用_virt-install_新增虛擬機器">用 virt-install 新增虛擬機器</span>
</h4>
<p>For an extremely detailed domain (virtual machine) setup, it is easier to <a href="#%E7%94%A8_virt-manager_%E6%96%B0%E5%A2%9E%E8%99%9B%E6%93%AC%E6%A9%9F%E5%99%A8">#用 virt-manager 新增虛擬機器</a>.  However, basics can easily be done with <code>virt-install</code> and still run quite well.  Minimum specifications are <code>--name</code>, <code>--memory</code>, guest storage (<code>--disk</code>, <code>--filesystem</code>, or <code>--nodisks</code>), and an install method (generally an <code>.iso</code> or CD).
</p>
<p>Arch Linux install (two GiB, raw format volume create; user-networking):
</p>
<pre>$ virt-install  \
  --name arch-linux_testing \
  --memory 1024             \ 
  --vcpus=2,maxvcpus=4      \
  --cpu host                \
  --cdrom $HOME/Downloads/arch-linux_install.iso \
  --disk size=2,format=raw  \
  --network user            \
  --virt-type kvm
</pre>
<p>Fedora testing (Xen hypervisor, non-default pool, do not originally view):
</p>
<pre>$ virt-install  \
  --connect xen:///     \
  --name fedora-testing \
  --memory 2048         \
  --vcpus=2             \
  --cpu=host            \
  --cdrom /tmp/fedora20_x84-64.iso      \
  --os-type=linux --os-variant=fedora20 \
  --disk pool=testing,size=4            \
  --network bridge=br0                  \
  --graphics=vnc                        \
  --noautoconsole
$ virt-viewer --connect xen:/// fedora-testing
</pre>
<p>Windows:
</p>
<pre>$ virt-install \
  --name=windows7           \
  --memory 2048             \
  --cdrom /dev/sr0          \
  --os-variant=win7         \
  --disk /mnt/storage/domains/windows7.qcow2,size=20GiB \
  --network network=vm-net  \
  --graphics spice
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Run <code>osinfo-query --fields=name,version os</code> to get argument for <code>--os-variant</code>; this will help define some specifications for the domain.  However, <code>--memory</code> and <code>--disk</code> will need to be entered; one can look within the appropriate <code>/usr/share/libosinfo/db/oses/<i>os</i>.xml</code> if needing these specifications.  After installing, it will likely be preferable to install the <a rel="nofollow" class="external text" href="http://www.spice-space.org/download.html">Spice Guest Tools</a> that include the <a rel="nofollow" class="external text" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Host_Configuration_and_Guest_Installation_Guide/form-Virtualization_Host_Configuration_and_Guest_Installation_Guide-Para_virtualized_drivers-Mounting_the_image_with_virt_manager.html">VirtIO drivers</a>. For a Windows VirtIO network driver there is also <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/virtio-win/">virtio-win</a></span><sup><small>AUR</small></sup>. These drivers are referenced by a <code>&lt;model type='virtio' /&gt;</code> in the guest's <code>.xml</code> configuration section for the device. A bit more information can also be found on the <a href="../en/QEMU.html#Preparing_a_Windows_guest" title="QEMU">QEMU article</a>.</div>
<p>Import existing volume:
</p>
<pre>$ virt-install  \
  --name demo  \
  --memory 512 \
  --disk /home/user/VMs/mydisk.img \
  --import
</pre>
<h4>
<span id=".E7.94.A8_virt-manager_.E6.96.B0.E5.A2.9E.E8.99.9B.E6.93.AC.E6.A9.9F.E5.99.A8"></span><span class="mw-headline" id="用_virt-manager_新增虛擬機器">用 virt-manager 新增虛擬機器</span>
</h4>
<p>首先，連線到虛擬機的Hypervisor（例如 QEMU/KVM <i>system</i> 或使用這 <i>session</i>，在“連線”上右鍵按一下並選擇 <i>新增</i>，然後跟隨 新增虛擬機器精靈 完成。
</p>
<ul><li>在<b>第五步</b>中打開<b>進階選項</b>並確認<b>虛擬化類型</b>设为 <b>KVM</b>（這通常是首選模式）。如果要求附加的硬體配置，選中<b>安裝前定制</b>選項。</li></ul>
<h4>
<span id=".E7.AE.A1.E7.90.86.E8.99.9B.E6.93.AC.E6.A9.9F"></span><span class="mw-headline" id="管理虛擬機">管理虛擬機</span>
</h4>
<p>啟動虛擬機器：
</p>
<pre>$ virsh start <i>domain</i>
$ virt-viewer --connect qemu:///session <i>domain</i>
</pre>
<p>Gracefully attempt to shutdown a domain; force off a domain:
</p>
<pre>$ virsh shutdown <i>domain</i>
$ virsh destroy  <i>domain</i>
</pre>
<p>Autostart domain on libvirtd start:
</p>
<pre>$ virsh autostart <i>domain</i>
$ virsh autostart <i>domain</i> --disable
</pre>
<p>Shutdown domain on host shutdown:
</p>
<dl><dd>Running domains can be automatically suspended/shutdown at host shutdown using the <code>libvirt-guests.service</code> systemd service. This same service will resume/startup the suspended/shutdown domain automatically at host startup.  Read <code>/etc/conf.d/libvirt-guests</code> for service options.</dd></dl>
<p>Edit a domain's XML configuration:
</p>
<pre>$ virsh edit <i>domain</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Virtual Machines started directly by QEMU are not managable by libvirt tools.</div>
<h3>
<span id=".E7.B6.B2.E8.B7.AF"></span><span class="mw-headline" id="網路">網路</span>
</h3>
<p><a rel="nofollow" class="external text" href="https://jamielinux.com/docs/libvirt-networking-handbook/">此處</a>是有有關libvirt 網路的一个正宗的概述。
</p>
<p>預設情況下，當 <code>libvird</code> 服務啟動後，即創建了一個名為 <i>default</i> 的 NAT 網橋與外部網路聯通（警告：參閱 <a href="#%22default%22_%E7%B6%B2%E8%B7%AF%E7%9A%84_bug">#"default" 網路的 bug</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup>）。對於其他的網路連線需求，可創建下列4種類型的網路讓虛擬機連線到網路：
</p>
<ul>
<li>bridge — 這是一個虛擬裝置，它通過一個物理介面直接共享網路資料。使用場合為：宿主機有 <i>靜態</i> 網路、虛擬機不需與其它虛擬機連接、虛擬機要佔用全部進出流量，並且虛擬機執行於<i>系統</i> 層級。有關如何在現有預設網橋時增加另一個網橋的方法，參閱 <a href="/index.php?title=%E7%B6%B2%E6%A9%8B&amp;action=edit&amp;redlink=1" class="new" title="網橋 (page does not exist)">網橋</a>。網橋創建後，需要將它指定到相應客戶機的 <code>.xml</code> 設定檔中。</li>
<li>network — 這是一個虛擬網路，它可以與其它虛擬機共用。使用場景為：宿主機有 <i>動態</i> 網路（例如：NetworkManager）或使用無線網路。</li>
<li>macvtap — 直接連線到宿主機的一個物理網路介面。</li>
<li>user — 本地網路，僅用於使用者 <i>工作階段</i>。</li>
</ul>
<p>絕大多數用戶都可以通過 <code>virsh</code> 的各種可選項創建具有各種功能的網路，一般來說比通過 GUI 程式（像 <code>virt-manager</code> 等）更容易做到。也可以按 <a href="#%E7%94%A8_virt-install_%E6%96%B0%E5%A2%9E%E8%99%9B%E6%93%AC%E6%A9%9F">#用 virt-install 新增虛擬機</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup> 實現。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> libvirt 通過  <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnsmasq">dnsmasq</a></span> 處理 DHCP 和 DNS 請求，以啟動每個虛擬網路的不同實例。也會為特定的路由添加 iptables 規則並啟用 <code>ip_forward</code> 內核參數。</div>
<h3>
<span id=".E5.BF.AB.E7.85.A7"></span><span class="mw-headline" id="快照">快照</span>
</h3>
<p>Snapshots take the disk, memory, and device state of a domain at a point-of-time, and save it for future use.  They have many uses, from saving a "clean" copy of an OS image to saving a domain's state before a potentially destructive operation.  Snapshots are identified with a unique name.
</p>
<p>Snapshots are saved within the volume itself and the volume must be the format: qcow2 or raw.  Snapshots use deltas so they have the potentiality to not take much space.
</p>
<h4>
<span id=".E6.96.B0.E5.A2.9E.E5.BF.AB.E7.85.A7"></span><span class="mw-headline" id="新增快照">新增快照</span>
</h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Some of this data appears to be dated. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Libvirt_(%E6%AD%A3%E9%AB%94%E4%B8%AD%E6%96%87)">Talk:Libvirt (正體中文)#</a>)</div>
</div>
<p>Once a snapshot is taken it is saved as a new block device and the original snapshot is taken offline.  Snapshots can be chosen from and also merged into another (even without shutting down the domain).
</p>
<p>Print a running domain's volumes (running domains can be printed with <code>virsh list</code>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># virsh domblklist <i>domain</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> Target     Source
 ------------------------------------------------
 vda        /vms/domain.img
</pre>
<p>To see a volume's physical properties:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># qemu-img info /vms/domain.img</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> image: /vms/domain.img
 file format: qcow2
 virtual size: 50G (53687091200 bytes)
 disk size: 2.1G
 cluster_size: 65536
</pre>
<p>Create a disk-only snapshot (the option <code>--atomic</code> will prevent the volume from being modified if snapshot creation fails):
</p>
<pre># virsh snapshot-create-as <i>domain</i> snapshot1 --disk-only --atomic
</pre>
<p>List snapshots:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># virsh snapshot-list <i>domain</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> Name                 Creation Time             State
 ------------------------------------------------------------
 snapshot1           2012-10-21 17:12:57 -0700 disk-snapshot
</pre>
<p>One can they copy the original image with <code>cp --sparse=true</code> or <code>rsync -S</code> and then merge the the original back into snapshot:
</p>
<pre># virsh blockpull --domain <i>domain</i> --path /vms/<i>domain</i>.snapshot1
</pre>
<p><code>domain.snapshot1</code> becomes a new volume.  After this is done the original volume (<code>domain.img</code> and snapshot metadata can be deleted.   The <code>virsh blockcommit</code> would work opposite to <code>blockpull</code> but it seems to be currently under development (including <code>snapshot-revert feature</code>, scheduled to be released sometime next year.
</p>
<h3>
<span id=".E5.85.B6.E4.BB.96.E7.AE.A1.E7.90.86.E6.93.8D.E4.BD.9C"></span><span class="mw-headline" id="其他管理操作">其他管理操作</span>
</h3>
<p>Connect to non-default hypervisor:
</p>
<pre>$ virsh --connect xen:///
virsh # uri
xen:///
</pre>
<p>Connect to the QEMU hypervisor over SSH; and the same with logging:
</p>
<pre>$ virsh --connect qemu+ssh://<i>username</i>@<i>host</i>/system
$ LIBVIRT_DEBUG=1 virsh --connect qemu+ssh://<i>username</i>@<i>host</i>/system
</pre>
<p>Connect a graphic console over SSH:
</p>
<pre>$ virt-viewer  --connect qemu+ssh://<i>username</i>@<i>host</i>/system <i>domain</i>
$ virt-manager --connect qemu+ssh://<i>username</i>@<i>host</i>/system <i>domain</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you are having problems connecting to a remote RHEL server (or anything other than Arch, really), try the two workarounds mentioned in <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/30748">FS#30748</a> and <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/22068">FS#22068</a>.</div>
<p>Connect to the VirtualBox hypervisor (<i>VirtualBox support in libvirt is not stable yet and may cause libvirtd to crash</i>):
</p>
<pre>$ virsh --connect vbox:///system
</pre>
<p>Network configurations:
</p>
<pre>$ virsh -c qemu:///system net-list --all
$ virsh -c qemu:///system net-dumpxml default
</pre>
<h2>
<span id="Python_.E9.80.A3.E6.8E.A5.E4.BB.A3.E7.A2.BC"></span><span class="mw-headline" id="Python_連接代碼">Python 連接代碼</span>
</h2>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libvirt-python">libvirt-python</a></span> package provides a <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=python2">python2</a></span> API in <code>/usr/lib/python2.7/site-packages/libvirt.py</code>.
</p>
<p>General examples are given in <code>/usr/share/doc/libvirt-python-<i>your_libvirt_version</i>/examples/</code>
</p>
<p>Unofficial example using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=qemu">qemu</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span>:
</p>
<pre>#! /usr/bin/env python2
# -*- coding: utf-8 -*-
import socket
import sys
import libvirt
if (__name__ == "__main__"):
   conn = libvirt.open("qemu+ssh://xxx/system")
   print "Trying to find node on xxx"
   domains = conn.listDomainsID()
   for domainID in domains:
       domConnect = conn.lookupByID(domainID)
       if domConnect.name() == 'xxx-node':
           print "Found shared node on xxx with ID " + str(domainID)
           domServ = domConnect
           break
</pre>
<h2>
<span id=".E5.8F.83.E9.96.B1"></span><span class="mw-headline" id="參閱">參閱</span>
</h2>
<ul>
<li><a rel="nofollow" class="external text" href="http://libvirt.org/drvqemu.html">libvirt網站</a></li>
<li><a rel="nofollow" class="external text" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/index.html">Red Hat 虛擬化部署和管理指南</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:7d876dcc0aeb99723c8082d6986c7db5.html" title="Category:正體中文">正體中文</a></li>
<li><a href="../zh-TW/Category:Virtualization.html" title="Category:Virtualization (正體中文)">Virtualization (正體中文)</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_broken_package_links.html" title="Category:Pages with broken package links">Pages with broken package links</a></li>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Libvirt_(%E6%AD%A3%E9%AB%94%E4%B8%AD%E6%96%87)&amp;oldid=615381">https://wiki.archlinux.org/index.php?title=Libvirt_(正體中文)&amp;oldid=615381</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 24 May 2020, at 07:35.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
